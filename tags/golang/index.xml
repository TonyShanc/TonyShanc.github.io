<?xml version="1.0" encoding="utf-8" standalone="yes"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>golang on shank</title>
    <link>https://shankisme.com/tags/golang/</link>
    <description>Recent content in golang on shank</description>
    <generator>Hugo -- gohugo.io</generator>
    <language>en-us</language>
    <copyright>This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.</copyright>
    <lastBuildDate>Mon, 13 Dec 2021 15:35:21 +0800</lastBuildDate><atom:link href="https://shankisme.com/tags/golang/index.xml" rel="self" type="application/rss+xml" />
    <item>
      <title>é¢å‘API server CRUDçš„æ¢ç´¢</title>
      <link>https://shankisme.com/posts/clientset/</link>
      <pubDate>Mon, 13 Dec 2021 15:35:21 +0800</pubDate>
      
      <guid>https://shankisme.com/posts/clientset/</guid>
      <description>å‰è¨€ æŸäº›åœºæ™¯ä¸‹ï¼Œæˆ‘ä»¬å¯èƒ½ä¸éœ€è¦operatorçš„é‚£ç§è¿ç»´èƒ½åŠ›ï¼Œèƒ½å¯¹èµ„æºCRUDå°±å¤Ÿäº†ï¼Œclient-goä¸­çš„clientå°±æ˜¯éå¸¸ä¸é”™çš„é€‰æ‹©ã€‚
å‰ç½®çŸ¥è¯† GVRã€GVK åœ¨æ•´ä¸ªkubernetesæ¶æ„ä¸­ï¼Œèµ„æºæ˜¯æœ€é‡è¦çš„æ¦‚å¿µï¼Œå¯ä»¥è¯´k8sçš„ç”Ÿæ€ç³»ç»Ÿéƒ½å›´ç»•èµ„æºè¿ä½œï¼Œå®ƒæœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªèµ„æºæ§åˆ¶ç³»ç»Ÿï¼šæ³¨å†Œã€ç®¡ç†ã€è°ƒåº¦èµ„æºå¹¶ç»´æŠ¤èµ„æºçŠ¶æ€ã€‚
k8så°†èµ„æºåˆ†ç»„å’Œç‰ˆæœ¬åŒ–ï¼Œå½¢æˆäº†:
Group: èµ„æºç»„ Version: èµ„æºç‰ˆæœ¬ Resource: èµ„æº Kind: èµ„æºç§ç±», ä¸resourceä¸ºåŒçº§æ¦‚å¿µ k8sç³»ç»Ÿæ”¯æŒå¤šä¸ªGroupï¼Œæ¯ä¸ªGroupæ”¯æŒå¤šä¸ªVersionï¼Œæ¯ä¸ªVersionæ”¯æŒå¤šä¸ªResourceï¼Œå…¶ä¸­éƒ¨åˆ†èµ„æºä¼šæ‹¥æœ‰å­èµ„æºï¼Œå¦‚Deploymentä¼šæ‹¥æœ‰Statuså­èµ„æºã€‚
èµ„æºç»„ã€èµ„æºç‰ˆæœ¬ã€èµ„æºã€å­èµ„æºçš„å®Œæ•´è¡¨ç°å½¢å¼ä¸ºï¼š&amp;lt;group&amp;gt;/&amp;lt;version&amp;gt;/&amp;lt;resource&amp;gt;/&amp;lt;subresource&amp;gt;
å¦‚Deploymentèµ„æºï¼Œå®Œæ•´è¡¨ç°å½¢å¼ä¸ºï¼šapps/v1/deployments/status
èµ„æºå®ä¾‹åŒ–åä¸ºä¸€ä¸ªèµ„æºå¯¹è±¡ï¼Œæ‹¥æœ‰èµ„æºç»„ã€èµ„æºç‰ˆæœ¬ã€èµ„æºç§ç±»ï¼Œè¡¨ç°å½¢å¼ä¸ºï¼š&amp;lt;group&amp;gt;/&amp;lt;version&amp;gt;,Kind=&amp;lt;kind&amp;gt;
å¦‚Deployment, å®Œæ•´è¡¨ç°å½¢å¼ä¸ºapps/v1,Kind=Deployment
client-go k8sä½¿ç”¨client-goä½œä¸ºgoè¯­è¨€å®˜æ–¹ç¼–ç¨‹å¼äº¤äº’å®¢æˆ·ç«¯åº“ï¼Œæä¾›å¯¹k8s API serverçš„äº¤äº’å¼è®¿é—®ã€‚
client-goæ”¯æŒ4ç§clientå¯¹è±¡ä¸k8säº¤äº’ï¼Œåˆ†åˆ«æ˜¯ClientSetã€DynamicClientã€DiscoveryClientã€RESTClient
RESTClientæœ€åŸºç¡€ï¼Œå®ƒå°è£…äº†HTTPRequest,å®ç°äº†RESTfulé£æ ¼çš„APIï¼ŒClientSetã€DynamicClinetä»¥åŠDiscoveryClientéƒ½æ˜¯åŸºäºRESTfulClientå®ç°çš„ã€‚
RESTClient package main import ( &amp;#34;context&amp;#34; &amp;#34;fmt&amp;#34; corev1 &amp;#34;k8s.io/api/core/v1&amp;#34; metav1 &amp;#34;k8s.io/apimachinery/pkg/apis/meta/v1&amp;#34; &amp;#34;k8s.io/client-go/kubernetes/scheme&amp;#34; &amp;#34;k8s.io/client-go/rest&amp;#34; &amp;#34;k8s.io/client-go/tools/clientcmd&amp;#34; ) func main() { config, err := clientcmd.BuildConfigFromFlags(&amp;#34;&amp;#34;, &amp;#34;/etc/rancher/k3s/k3s.yaml&amp;#34;) if err != nil { panic(err) } config.APIPath = &amp;#34;api&amp;#34; // group core version v1 config.GroupVersion = &amp;amp;corev1.SchemeGroupVersion // set codec config.</description>
    </item>
    
    <item>
      <title>èŠä¸€èŠkubernetes operator</title>
      <link>https://shankisme.com/posts/%E8%81%8A%E4%B8%80%E8%81%8Akubernetes-operator/</link>
      <pubDate>Tue, 07 Dec 2021 20:13:53 +0800</pubDate>
      
      <guid>https://shankisme.com/posts/%E8%81%8A%E4%B8%80%E8%81%8Akubernetes-operator/</guid>
      <description>å‰è¨€ å¾®æœåŠ¡å…´èµ·ï¼Œè®¸å¤šä¸šåŠ¡è¢«éƒ¨ç½²åœ¨äº†k8sä¸Šï¼Œå¤§å¤šæ•°ä¸šåŠ¡å¼€å‘äººå‘˜æ—¥å¸¸æ¥è§¦åˆ°çš„åŸºæœ¬æ˜¯build-inèµ„æº(ingress service deployment replicaset pod hpa)ï¼Œå› æ­¤ä¼šè®¤ä¸ºkubernetes(ä»¥ä¸‹ç®€ç§°k8s)æ˜¯ä¸€ä¸ªè®¾è®¡ä¼˜ç§€çš„paaså¹³å°ï¼Œåœ¨k8sä¸­åˆ›å»ºèµ„æºçš„äººå‘˜ä¼šè¢«ç§°ä¸ºyamlå·¥ç¨‹å¸ˆğŸ¤£ã€‚
è¿™ä¹ˆè¯´æ˜¾å¾—k8så¾ˆæ— èŠ, èµ„æºåªæ˜¯å¯¹è±¡çŠ¶æ€çš„æè¿°ï¼Œå®é™…æ‰§è¡ŒåŠ¨ä½œçš„æ˜¯k8sçš„ç»„ä»¶(kubelet kube-proxyç­‰)ï¼Œå¯ä»¥è¯´k8sçš„æ‰§è¡Œèƒ½åŠ›è¶³å¤Ÿå¼ºå¤§ï¼Œèƒ½åœ¨å­˜å‚¨ã€ç½‘ç»œã€å®¹å™¨ä¸Šç©å‡ºèŠ±ï¼Œä½ å®Œå…¨å¯ä»¥ç»„ç»‡è‡ªå·±çš„èµ„æºæ ¼å¼(crd)ï¼Œåˆ©ç”¨k8sçš„èƒ½åŠ›åšè‡ªå·±æƒ³åšçš„äº‹ï¼Œk8sæœ¬è´¨ä¸Šæ˜¯å¸¦æœ‰å¼ºå¤§æ‰§è¡ŒåŠ›çš„åˆ†å¸ƒå¼èµ„æºç®¡ç†å¹³å°ï¼Œè¿™ç§åŠ¨è¯-åè¯åˆ†ç¦»çš„è§£é‡Šåº”è¯¥èƒ½è®©ä½ æ›´å¥½åœ°ç†è§£k8sã€‚
å½“ä»Šè®¸å¤šå¯¹æ‰©å±•æ€§å¯ç”¨æ€§è¦æ±‚é«˜çš„é¡¹ç›®ï¼ˆTiDBç­‰ï¼‰ï¼Œæ›´é’çäºä½¿ç”¨k8sä½œä¸ºåŸºåº§ï¼Œè¿™æ ·çš„æ·±åº¦ç»“åˆåªä¼šè®©k8sè¶Šæ¥è¶Šæµè¡Œã€‚
å¾—ç›Šäºå¼ºå¤§çš„æ’ä»¶æœºåˆ¶ï¼Œk8sè¿˜èƒ½è‡ªå®šä¹‰èµ„æº(crd/cr)ï¼Œè‡ªå®šä¹‰controllerï¼Œè‡ªå®šä¹‰api server, è‡ªå®šä¹‰admission webhookï¼Œä»–ä»¬è®©ä½ èƒ½æœ‰æ•ˆç»„åˆk8sçš„æ‰§è¡ŒåŠ›ï¼Œåšä¸€äº›æœ‰é€»è¾‘çš„äº‹ã€‚å½“ä¸‹æœ€æµè¡Œçš„è«è¿‡äºç©crd+controlleräº†ã€‚
ä¸ºäº†è®©çœ‹å®˜æ›´å¥½çš„äº†è§£operatorï¼ˆcontroller + crd + crï¼‰ï¼Œå’±ä»¬ä»k8sä¸¤å¤§è®¾è®¡æ€æƒ³ï¼šå£°æ˜å¼APIã€æ§åˆ¶å¾ªç¯è¯´èµ·ã€‚
å£°æ˜å¼API å£°æ˜å¼ä¸ä¹‹ç›¸å¯¹çš„æ˜¯å‘½ä»¤å¼, å‘½ä»¤å¼é¡¾åæ€ä¹‰ï¼Œè®©ç›®æ ‡æŒ‰æŒ‡å®šå‘½ä»¤åšäº‹ï¼›è€Œå£°æ˜å¼åˆ™æ˜¯æä¾›ç›®æ ‡ä¸€ä¸ªæœŸæœ›çŠ¶æ€ï¼Œè®©ç›®æ ‡æœæœŸæœ›çŠ¶æ€å»å˜æ›´ã€‚
çœ‹å¾—å‡ºæ¥ï¼Œå‘½ä»¤å¼å¤Ÿç®€æ´ï¼Œä½†è¦èŠ±è´¹å·¨å¤§ä»£ä»·ä¿è¯å‘½ä»¤æ‰§è¡Œæ‹¥æœ‰åŸå­æ€§å¹‚ç­‰æ€§ã€‚
æä¾›æœŸæœ›çŠ¶æ€çœ‹ä¼¼å†—ä½™ï¼Œä½†åªè¦æœŸæœ›çŠ¶æ€èƒ½è¢«æ‰§è¡Œè€…è·å–åˆ°ï¼Œæ‰§è¡Œè€…å°±èƒ½ä¸æ–­å°è¯•ç€å»è¾¾æˆæœŸæœ›çŠ¶æ€ï¼Œè¿‡ç¨‹ç®€å•ã€‚
è€ŒAPIå˜›ï¼ŒæŒ‡çš„æ˜¯k8s apiserveræä¾›çš„RESTful httpæ¥å£ï¼Œåˆ›å»ºèµ„æºæ¥å£éœ€è¦æ¥æ”¶å®Œæ•´çš„èµ„æºæœŸæœ›çŠ¶æ€å®šä¹‰, æœŸæœ›çŠ¶æ€æŒ‡çš„å°±æ˜¯specä¸­çš„æè¿°ï¼Œä¸ä¹‹å¯¹åº”çš„å®é™…çŠ¶æ€ç”±æ‰§è¡Œè€…ï¼ˆcontrollerï¼‰è®°å½•åœ¨statusä¸­ã€‚
è¿™ä¹Ÿæ˜¯ä¸ºå•¥æˆ‘ä»¬åœ¨ç”¨kubectlæŸ¥çœ‹èµ„æºä¿¡æ¯çš„æ—¶å€™åå‡ºç°é¢å¤–çš„statuså­—æ®µï¼Œè¿™å®é™…ä¸Šæ˜¯æ‰§è¡Œè€…å¸®æˆ‘ä»¬è®°å½•çš„ï¼Œä¸“ä¸šç‚¹çš„å«æ³•æ˜¯è§„çº¦(spec) - çŠ¶æ€(status)åˆ†ç¦»ã€‚æ¯”å¦‚pod, é™¤äº†å…ƒä¿¡æ¯å¤–ï¼ŒçŠ¶æ€ä»specå’Œstatuså­—æ®µå¼€å§‹å±•å¼€ã€‚
type Pod struct { metav1.TypeMeta `json:&amp;#34;,inline&amp;#34;` metav1.ObjectMeta `json:&amp;#34;metadata,omitempty&amp;#34; protobuf:&amp;#34;bytes,1,opt,name=metadata&amp;#34;` Spec PodSpec `json:&amp;#34;spec,omitempty&amp;#34; protobuf:&amp;#34;bytes,2,opt,name=spec&amp;#34;` Status PodStatus `json:&amp;#34;status,omitempty&amp;#34; protobuf:&amp;#34;bytes,3,opt,name=status&amp;#34;` } æ§åˆ¶å¾ªç¯ï¼ˆcontrol loopï¼‰ èµ„æºçš„ç†æƒ³çŠ¶æ€å­˜å‚¨åœ¨k8sçš„apiserverä¸­ï¼Œä¸ºäº†è®©èµ„æºç”±å®é™…çŠ¶æ€å‘æœŸæœ›çŠ¶æ€é æ‹¢, æ‰§è¡Œè€…éœ€è¦ç›‘å¬èµ„æºæœŸæœ›çŠ¶æ€çš„å¢åˆ æ”¹äº‹ä»¶ï¼Œè¿™äº›äº‹ä»¶ä¼šè§¦å‘æ‰§è¡Œè€…ä»¥å®šæ—¶é‡å¤æ‰§è¡Œæ–¹å¼è°ƒç”¨å¯¹åº”çš„handlerå¤„ç†äº‹ä»¶, ç›´åˆ°æ»¡è¶³æœŸæœ›çŠ¶æ€ä¸ºæ­¢ï¼Œä¹‹åæ‰§è¡Œè€…å†æŠŠæ“ä½œç»“æœè®°å½•åˆ°å®é™…çŠ¶æ€ä¸­ã€‚
æ‰§è¡Œè€… æˆ‘ä»¬çŸ¥é“ï¼Œkubeletæ˜¯k8sè‡ªå¸¦ç»„ä»¶ï¼Œä¸»è¦åŠŸèƒ½é€šè¿‡ç›‘å¬podæœŸæœ›çŠ¶æ€å˜åŒ–äº‹ä»¶å¹¶åšä¸€äº›äº‹ç¡®ä¿æœ¬åœ°çš„podå¤„äºæœŸæœ›çŠ¶æ€ã€‚
kube-proxyåŒæ ·ä¹Ÿä¼šå¤„ç†podçš„å¢åˆ æ”¹äº‹ä»¶ï¼Œå®ƒä¸æ–­åœ°åˆ·æ–°æœ¬æœºlinuxç½‘ç»œè®¾å¤‡çš„é…ç½®ï¼Œæ¥ç¡®ä¿podç½‘ç»œé€šç•…ã€‚
è¿˜æœ‰æˆ‘ä»¬å¸¸ç”¨çš„deploymentã€cronJobã€statefulsetç­‰ï¼Œå®ƒä»¬æ‹¥æœ‰è‡ªå·±çš„controlleråšæ§åˆ¶å¾ªç¯ï¼Œè¿™äº›controller è¿è¡Œåœ¨ç»„ä»¶controller-managerå†…ã€‚
ç„¶è€Œä¸åƒä¸Šé¢æåˆ°çš„å¤„ç†k8såŸç”Ÿèµ„æºçš„æ‰§è¡Œè€…ï¼Œè¿™æ¬¡æˆ‘ä»¬èŠçš„operator,ç”±crd(custom resource definition)ã€cr(custom resource)ã€controllerç»„æˆã€‚
crdç”¨æ¥æè¿°ä½ æƒ³åˆ›å»ºçš„èµ„æºåº”è¯¥æœ‰å“ªäº›å­—æ®µï¼Œcræ˜¯crdçš„å…·ä½“åŒ–å®ç°ï¼Œä¸å¯¹è±¡ï¼Œå¯¹è±¡å®ä¾‹ä¹‹é—´åŒºåˆ«ç±»ä¼¼ã€‚
æˆ‘ä»¬è‡ªå·±å®ç°çš„controlleræ§åˆ¶çš„ç›®æ ‡å°±æ˜¯cr, å®ƒçš„å®ç°åŸç†ç­‰åŒcontroller-managerä¸­çš„åŸç”Ÿcontrollerï¼š
ä¾é informerçš„ListAndWatchæ–¹æ³•å°†æŒ‡å®šèµ„æºçš„çŠ¶æ€ç¼“å­˜åœ¨å†…å­˜ä¸­ï¼Œå¹¶ä¸æ–­ç›‘æ§çŠ¶æ€å˜åŒ–
reconcileæ–¹æ³•ä¸­çš„ä¸šåŠ¡é€»è¾‘ä¼šæ ¹æ®èµ„æºçš„æœŸæœ›çŠ¶æ€ï¼Œå¯¹å¤–éƒ¨ä¸–ç•Œä½œå‡ºæ”¹å˜ï¼Œå¦‚æœå¤„ç†å¤±è´¥ï¼Œå°±é‡æ–°å…¥é˜Ÿï¼ŒæŒ‰æŸç§è§„åˆ™åˆ°æŸä¸ªæ—¶é—´ç»§ç»­è¿›å…¥reconcile, ç›´åˆ°å¤„ç†å®Œæˆã€‚</description>
    </item>
    
    <item>
      <title>go-mockåˆæ¢</title>
      <link>https://shankisme.com/posts/go-mock%E5%88%9D%E6%8E%A2/</link>
      <pubDate>Fri, 22 Jan 2021 01:41:04 +0800</pubDate>
      
      <guid>https://shankisme.com/posts/go-mock%E5%88%9D%E6%8E%A2/</guid>
      <description>go mock ç”¨äºè™šæ‹Ÿæ¥å£ã€‚ä¸€èˆ¬åªè¦æä¾›interfaceï¼Œæ— è®ºæœ‰æ²¡æœ‰å®ç°è¯¥interfaceçš„ç±»å‹ï¼Œgomockä¼šæ ¹æ®æ¥å£çš„è¾“å…¥è¾“å‡ºæä¾›ä¸€ä¸ªå®ç°äº†è¯¥interfaceçš„mockå®ä¾‹ï¼ŒåŒæ—¶åœ¨è‡ªå®šä¹‰mockå®ä¾‹çš„è¾“å…¥è¾“å‡ºå‰ï¼Œå¯ä»¥æ ¹æ®æœŸæœ›è¿‡æ»¤è¾“å…¥ï¼Œäº§ç”Ÿæƒ³è¦çš„è¾“å‡ºæˆ–è°ƒç”¨æŸäº›å‡½æ•°ã€‚è¯´çš„å¾ˆæ™¦æ¶©ï¼Œçœ‹ç‚¹ä»£ç å§ã€‚
ç›®å½•ç»“æ„ï¼š
trymock/ /db |--db.go |--db_test.go /mock |--db_mock.go // generated by mockgen //db.go type DB interface { Get(key string) (int, error) } func GetFromDB(db DB, key string) int { if value, err := db.Get(key); err == nil { return value } return -1 } gomockä¸­ï¼ŒDBå®ä¾‹åªèƒ½é€šè¿‡ä¼ å‚ä¼ å…¥ç”Ÿæˆmockæ–‡ä»¶
mockgen -source=db.go -destination=db_mock.go -package=mock gomockç”Ÿæˆçš„db_mock.goå¦‚ä¸‹
//db_mock.go // Code generated by MockGen. DO NOT EDIT. // Source: db.go // Package mock_db is a generated GoMock package.</description>
    </item>
    
  </channel>
</rss>
