<?xml version="1.0" encoding="utf-8" standalone="yes"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>kubernetes on shank</title>
    <link>https://shankisme.com/tags/kubernetes/</link>
    <description>Recent content in kubernetes on shank</description>
    <generator>Hugo -- gohugo.io</generator>
    <language>en-us</language>
    <copyright>This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.</copyright>
    <lastBuildDate>Fri, 01 Mar 2024 01:35:21 +0800</lastBuildDate><atom:link href="https://shankisme.com/tags/kubernetes/index.xml" rel="self" type="application/rss+xml" />
    <item>
      <title>kubernetesæ•…éšœæ’æŸ¥</title>
      <link>https://shankisme.com/posts/kubernetes%E6%95%85%E9%9A%9C%E6%8E%92%E6%9F%A5/</link>
      <pubDate>Fri, 01 Mar 2024 01:35:21 +0800</pubDate>
      
      <guid>https://shankisme.com/posts/kubernetes%E6%95%85%E9%9A%9C%E6%8E%92%E6%9F%A5/</guid>
      <description>æœ¬æ–‡æ•´ç†äº†åœ¨å·¥ä½œè¿‡ç¨‹ä¸­ç»å†çš„éƒ¨åˆ†kubernetesæ•…éšœæ’æŸ¥è®°å½•ã€‚
1. k8sç½‘ç»œç›´æ¥è·¯ç”±æ¨¡å¼ä¸‹ç½‘å¡æµé‡å¼‚å¸¸ èµ·å› ï¼šnode 1åˆ°node 2çš„é€šä¿¡å»¶è¿Ÿæ¯”å…¶ä»–é›†ç¾¤é«˜ï¼Œç»è¿‡vnstatç›‘å¬node 2 ç½‘å¡å‘ç°eth0å‡ ä¹æ²¡æµé‡ï¼Œeth1æµé‡é«˜è¾¾å‡ ç™¾Mbpsï¼Œå‡ ä¹æ‰“æ»¡å¸¦å®½ã€‚
ç¡®è®¤é—®é¢˜ï¼šk8sèŠ‚ç‚¹node 1 eth0åˆ°node 2çš„æµé‡é¢„æœŸç»è¿‡node 2 eth0ï¼Œä½†æ˜¯å´åœ¨node 2çš„eth1ç½‘å¡ç›‘å¬åˆ°ï¼Œæµé‡é“¾è·¯å¼‚å¸¸ã€‚
åˆ†æï¼šåœ¨å’Œè¿ç»´åŒå­¦æ²Ÿé€šç¡®è®¤äº†æ¥çº¿å’Œè·¯ç”±é…ç½®æ²¡é—®é¢˜åï¼Œç”»å‡ºç®€æ˜“ç½‘ç»œæ‹“æ‰‘ï¼š
ç¡®è®¤ä¸‰å±‚ç½‘ç»œæ­£å¸¸ï¼Œé—®é¢˜å‘ç”Ÿåœ¨äºŒå±‚æ•°æ®é“¾è·¯å±‚ï¼Œè€ŒäºŒå±‚ä½¿ç”¨MACåœ°å€å®šä½å‡ºå£ç½‘å¡ï¼ŒæŸ¥çœ‹node 1è®°å½•çš„ç›®æ ‡ip 192.168.4.112å¯¹åº”çš„MACåœ°å€å‘ç°æ˜¯192.168.3.112çš„MACåœ°å€ï¼Œè¯´æ˜node 1 arpæ´ªæ³›å­¦ä¹ äº†é”™è¯¯çš„MACåœ°å€ã€‚
è§£å†³æ–¹æ¡ˆï¼š ip neighbouråˆ é™¤arpè®°å½•è®©node 1é‡æ–°å­¦ä¹ ã€‚å­¦ä¹ é”™è¯¯MACåœ°å€çš„åŸå› å¾…è§‚å¯Ÿã€‚
2. internal ipåœ¨é›†ç¾¤å®‰è£…å’ŒæŠ•äº§æ—¶ä¸ä¸€è‡´å¯¼è‡´API Serverå‘kubeletçš„è¯·æ±‚è¿”å›x509 ipéæ³•é”™è¯¯ã€‚ ç»„å»ºk3s/k8sé›†ç¾¤æ—¶ï¼Œkubeletåˆå§‹åŒ–ä¼šç»å†ä¸¤ä¸ªæ­¥éª¤ï¼š
é€‰æ‹©é»˜è®¤è·¯ç”±çš„ç½‘å¡ipä½œä¸ºèŠ‚ç‚¹internal ip ä¸»èŠ‚ç‚¹å°†kubeletè®¾ç½®çš„å½“å‰èŠ‚ç‚¹internal ipï¼ŒåŠ å…¥kubeletæœåŠ¡ç«¯è¯ä¹¦çš„ipç™½åå•, ç­¾å‘å¹¶ä¸‹å‘è¯ä¹¦ï¼Œä¾›èŠ‚ç‚¹çš„kubeletä½œä¸ºæœåŠ¡ç«¯tlsè¯ä¹¦ä½¿ç”¨ èƒŒæ™¯: æˆ‘ä»¬çš„k3s/k8sé›†ç¾¤ä¸»è¦ç”¨äºè¾¹ç¼˜è®¡ç®—ï¼Œä½¿ç”¨ç‰©è”ç½‘å¡æ¥å…¥å…¬ç½‘ï¼Œæµé‡è´¹ç”¨è¾ƒè´µï¼Œå› æ­¤ä¸ºäº†åœ¨æŠ•äº§å‰èƒ½æ›´ç»æµæ›´å¿«åœ°æŠŠåŸºç¡€æœåŠ¡çš„é•œåƒæ‹‰ä¸‹æ¥ï¼Œæˆ‘ä»¬ä¸Šæ¸¸è¿ç»´äººå‘˜ä¼šåœ¨åˆå§‹åŒ–é›†ç¾¤æ—¶ç»™gatewayèŠ‚ç‚¹/ä¸»èŠ‚ç‚¹æ¥å…¥ç½‘çº¿ï¼ŒåŠ å…¥åŠå…¬å®¤ç½‘ç»œï¼Œå…¶ä»–ä»èŠ‚ç‚¹å°†ä¸»èŠ‚ç‚¹ä½œä¸ºé»˜è®¤ç½‘å…³æ‹‰é•œåƒã€‚å› æ­¤åœ¨åˆå§‹åŒ–é›†ç¾¤æ—¶ï¼ŒgatewayèŠ‚ç‚¹ä¼šå¤šå‡ºæ¥ä¸ªç½‘å¡ï¼Œä½œä¸ºè®¿é—®é»˜è®¤ç½‘å…³çš„ç½‘å¡ä½¿ç”¨ã€‚
é—®é¢˜ï¼šé›†ç¾¤çš„åŸºç¡€æœåŠ¡çš„å®¹å™¨å…¨éƒ¨runningåï¼Œè¿ç»´äººå‘˜ç»™é›†ç¾¤æ–­å¼€åŠå…¬å®¤ç½‘ç»œï¼Œäº¤ä»˜ä½¿ç”¨ã€‚å‘ç°åœ¨gatewayèŠ‚ç‚¹ä½¿ç”¨kubectlå·¥å…·æ— æ³•è®¿é—®podçš„æ—¥å¿—ï¼Œè¿”å›æŠ¥é”™:
Error from server: Get &amp;#34;https://192.168.3.123:10250/containerLogs/&amp;lt;NAMESPACE&amp;gt;/&amp;lt;POD_NAME&amp;gt;/&amp;lt;CONTAINER_NAME&amp;gt;&amp;#34;: x509 certificate is valid for 127.0.0.1, 172.29.1.100, not 192.168.3.123 åˆ†æï¼š æ—¥å¿—è¯·æ±‚çš„é“¾è·¯ä¸Šé‡åˆ°äº†TLSåŒå‘éªŒè¯å¤±è´¥çš„é—®é¢˜ï¼Œå…·ä½“åŸå› æ˜¯æŸä¸ªæœåŠ¡åœ¨TLSæ¡æ‰‹é˜¶æ®µæ‹’ç»äº†è¯·æ±‚æ–¹ï¼Œå› ä¸ºè¯·æ±‚æ–¹çš„ipæœªåœ¨è¯¥æœåŠ¡ipç™½åå•å†…ï¼Œè€Œç™½åå•æ˜¯å†™è¿›x509è¯ä¹¦ä¸­çš„ï¼Œè¿›ä¸€æ­¥æ ¹æ®10250ç«¯å£å®šä½è¯¥æœåŠ¡æ˜¯kubeletï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œä½¿ç”¨serving-kubelet.crtä½œä¸ºæœåŠ¡ç«¯è¯ä¹¦çš„kubeletæ²¡æœ‰æ”¾è¡ŒAPI Serverçš„è®¿é—®å®¹å™¨æ—¥å¿—çš„è¯·æ±‚ã€‚
è¯¢é—®è¿ç»´åŒå­¦ï¼Œäº†è§£äº†åˆå§‹åŒ–é›†ç¾¤åˆ°æŠ•å…¥ä½¿ç”¨çš„è¿‡ç¨‹ï¼š
å®šä½åˆ°é—®é¢˜åï¼Œæ‰¾åˆ°æœºå™¨ä¸Šserving-kubelet.crtè¯ä¹¦çš„ä½ç½®ï¼Œopenssl x509å‘½ä»¤æŸ¥çœ‹è¯ä¹¦å†…å®¹ï¼š
$ sudo openssl x509 -in serving-kube-apiserver.crt -text Certificate: ... X509v3 Subject Alternative Name: DNS:kubernetes, DNS:kubernetes.</description>
    </item>
    
    <item>
      <title>infra intro</title>
      <link>https://shankisme.com/posts/infra/</link>
      <pubDate>Sat, 17 Feb 2024 15:35:21 +0800</pubDate>
      
      <guid>https://shankisme.com/posts/infra/</guid>
      <description>ä¸šåŠ¡å…³é”®è¯ ç¯å«é¢†åŸŸ è‡ªåŠ¨é©¾é©¶æ¸…æ‰«è½¦ åŸå¸‚è¡—é“/å›­åŒº/éš§é“ æ‘„åƒå¤´/æ¿€å…‰é›·è¾¾/è½¦è¾†è¿è¡Œæ•°æ® è·¯çº¿è§„åˆ’ è¿œç¨‹æ“æ§ æ‰‹è‡ªåŠ¨æ¨¡å¼åˆ‡æ¢ éœ€æ±‚å…³é”®è¯ ä¸šåŠ¡/ç®—æ³•éƒ¨é—¨é¡¹ç›®ç‹¬ç«‹éƒ¨ç½² é¡¹ç›®ç‰ˆæœ¬ç®¡ç† ç‰ˆæœ¬è¿­ä»£æ–¹ä¾¿ èµ„æºé™é¢ï¼ˆcpuã€å†…å­˜ã€GPUï¼‰ è¾¹ç¼˜é›†ç¾¤ç½‘ç»œé«˜è´Ÿè½½(æµé‡å¤§äº1Gbps) æŠ€æœ¯å…³é”®è¯ è¾¹ç¼˜è®¡ç®— å¼±ç½‘ç¯å¢ƒ è¾¹ç¼˜éƒ¨ç½²è½»é‡k8sé›†ç¾¤(k3s) è¾¹ç¼˜æ··åˆæ¶æ„(ARM + X86) å¤šé›†ç¾¤ç®¡ç† é¡¹ç›®ç®¡ç† åŸºäºk8sçš„å¤šé›†ç¾¤ç®¡ç†å¹³å°cloud cloudæ¶æ„ è¾¹ç¼˜é›†ç¾¤æ¶æ„ Network Serveræ¶æ„ é›†ç¾¤æ³¨å†Œæµç¨‹å›¾ è¾¹ç¼˜å®¹å™¨ç½‘ç»œæ–¹æ¡ˆè¿­ä»£ v1 podç½‘ç»œåˆ†é…ï¼šk8s.controller-manager.ipam-controller æœ¬æœºpod ipç®¡ç†ï¼šhost-local åŒä¸»æœºpodé€šä¿¡ï¼šbridge è·¨ä¸»æœºpodé€šä¿¡ï¼šk3så†…ç½®flannel(vxlan) v2 podç½‘ç»œåˆ†é…ï¼šk8s.controller-manager.ipam-controller æœ¬æœºpod ipç®¡ç†ï¼šhost-local åŒä¸»æœºpodé€šä¿¡ï¼šbridge è·¨ä¸»æœºpodé€šä¿¡ï¼šflannel pod(vxlan) v3 podç½‘ç»œåˆ†é…ï¼šk8s.controller-manager.ipam-controller æœ¬æœºpod ipåˆ†é…ï¼šhost-local åŒä¸»æœºpodé€šä¿¡ï¼šbridge è·¨ä¸»æœºpodé€šä¿¡ï¼šè‡ªç ”é™æ€è·¯ç”±é…ç½®å·¥å…·router v4 podç½‘ç»œåˆ†é…ï¼šåœ¨kubeletæ³¨å†Œnodeå‰ï¼Œåœ¨nodeä¸­é¢„ç½®pod cidr æœ¬æœºpod ipåˆ†é…ï¼šhost-local åŒä¸»æœºpodé€šä¿¡ï¼šbridge è·¨ä¸»æœºpodé€šä¿¡ï¼šè‡ªç ”é™æ€è·¯ç”±é…ç½®å·¥å…·router </description>
    </item>
    
    <item>
      <title>CANç½‘ç»œè®¾å¤‡åœ¨k8sé›†ç¾¤å†…çš„ç®¡ç†æ–¹å¼</title>
      <link>https://shankisme.com/posts/can%E8%AE%BE%E5%A4%87%E5%9C%A8k8s%E9%9B%86%E7%BE%A4%E5%86%85%E7%9A%84%E7%AE%A1%E7%90%86%E6%96%B9%E5%BC%8F/</link>
      <pubDate>Tue, 28 Jun 2022 10:56:02 +0800</pubDate>
      
      <guid>https://shankisme.com/posts/can%E8%AE%BE%E5%A4%87%E5%9C%A8k8s%E9%9B%86%E7%BE%A4%E5%86%85%E7%9A%84%E7%AE%A1%E7%90%86%E6%96%B9%E5%BC%8F/</guid>
      <description>èƒŒæ™¯ è½¦ä¸Šçš„CANç½‘ç»œæ¥å£é€šå¸¸åœ¨hostç½‘ç»œä¸­åˆ›å»ºï¼Œä½¿ç”¨CANæ¥å£çš„é¡¹ç›®éœ€è¦åœ¨hostç½‘ç»œä¸­è¿è¡Œï¼Œå› æ­¤å¯èƒ½ä¼šäº§ç”Ÿç½‘ç»œæ ˆèµ„æºä½¿ç”¨å†²çªï¼Œå¯¼è‡´é¡¹ç›®å¯åŠ¨å¤±è´¥ï¼Œæ‰€ä»¥éœ€è¦ä½¿ç”¨æŸç§æŠ€æœ¯èƒ½è®©å®¹å™¨ç½‘ç»œä¸­çš„é¡¹ç›®è®¿é—®CANç½‘ç»œè®¾å¤‡ã€‚
å·²çŸ¥å¼€æºæ–¹æ¡ˆ k8s-device-plugin-socketcan for docker k8s-socketcan for containerd è¿™ä¸¤ç§æ–¹æ¡ˆåŸºäºk8s device pluginç›‘å¬podçš„æœŸæœ›èµ„æºå¹¶åˆ†é…å®é™…èµ„æºã€‚
yamlä¾‹å¦‚ï¼š
apiVersion: v1 kind: Pod metadata: name: demo-pod spec: containers: - name: demo-container-1 image: k8s.gcr.io/pause:2.0 resources: limits: shankisme.com/can: 1 //max is 1 å¦‚æœæŸpodé…ç½®äº†æŒ‡å®šèµ„æºï¼Œå°±å°†CANçš„netnsè®¾ç½®æˆè¯¥podçš„netnsï¼Œä¸¤ä¸ªé¡¹ç›®é—´çš„åŒºåˆ«ä»…ä»…åœ¨äºå®¹å™¨è¿è¡Œæ—¶ä¸€ä¸ªåªæ”¯æŒdocker,å¦ä¸€ä¸ªåªæ”¯æŒcontainerdã€‚
é—®é¢˜ æ²¡æœ‰ç®¡ç†å¥½CANçš„ç”Ÿå‘½å‘¨æœŸï¼Œå½“CANæ‰€åœ¨çš„netnsè¢«åˆ é™¤æ—¶ï¼ŒCANä¹Ÿä¼šè¢«åˆ é™¤ï¼Œéœ€è¦CANç›¸å…³çš„é©±åŠ¨æˆ–å®ˆæŠ¤è¿›ç¨‹å…œåº•ï¼Œé‡æ–°åˆ›å»ºå‡ºæ–°çš„CANæ¥å£ã€‚
CANæ¥å£èµ„æºæ˜¯å”¯ä¸€çš„ï¼Œæ„å‘³ç€ä½¿ç”¨CANçš„é¡¹ç›®åªèƒ½æœ‰ä¸€ä¸ªå‰¯æœ¬ï¼Œdeploymentæ»šåŠ¨æ›´æ–°æ—¶éœ€è¦ä¿è¯è€podç¨³å®šè¿è¡Œï¼Œä¸èƒ½ç§»é™¤CANï¼Œåˆè¦ä¿è¯æ–°podæ‹¿åˆ°CANè¾¾åˆ°healthyçŠ¶æ€æ‰èƒ½å®Œæˆæ»šåŠ¨æ›´æ–°ï¼Œç›´æ¥å¯¼è‡´æ­»é”ã€‚
ä¸€èˆ¬æ¥è¯´k8s device pluginé€‚åˆåˆ†é…åƒgpuã€cpuã€å†…å­˜è¿™ç±»åˆ†é…æ•°å¯å¤§äº1çš„æ•´æ•°è®¡ç®—èµ„æºï¼Œè€ŒCANç½‘ç»œæ¥å£podå†…å­˜åœ¨å³å¯ï¼Œå’Œæ•°é‡æ— å…³ï¼Œæ‰€ä»¥åŸºäºk8s device pluginçš„æ–¹æ¡ˆä¸åˆé€‚ã€‚
æ–¹æ¡ˆ å¹³æ»‘å‡çº§é¡¹ç›®ç‰ˆæœ¬æ˜¯æœ‰å¿…è¦çš„ï¼Œk8s deploymentçš„æ»šåŠ¨æ›´æ–°å¿…ç„¶è¦æ±‚åŒæ—¶æœ‰å¤šä¸ªCANï¼Œå•çº¯ç§»åŠ¨CANçš„æƒ³æ³•ä¼¼ä¹åº”è¯¥è¢«æŠ›å¼ƒã€‚
æµé‡è½¬å‘ å­¦ä¹ dockerç½‘ç»œåŸç†çš„æ—¶å€™ï¼Œæˆ‘ä»¬ä¼šäº†è§£åˆ°ä¸€äº›ç‰¹æ®Šçš„ç½‘ç»œè®¾å¤‡ï¼šveth pairã€bridgeã€‚
dockerçš„é»˜è®¤ç½‘ç»œæ¨¡å¼bridgeï¼Œä½¿ç”¨docker0(bridgeç½‘ç»œè®¾å¤‡)ä½œä¸ºhostçš„ethXä¸å…¶ä»–netnsçš„ethXæµé‡è½¬å‘ä¸­æ¢ï¼Œä½¿ç”¨vethä¸ºå®¹å™¨ç½‘ç»œæä¾›ethXæ¥å£ä¸å¤–ç•Œé€šä¿¡ã€‚
CANç½‘ç»œè®¾å¤‡ä¹Ÿæœ‰ç±»ä¼¼çš„ç½‘æ¡¥cangwå’Œè¿æ¥ä¸¤ä¸ªnetnsçš„vxcanå®ç°ä¸Šé¢çš„æµé‡è½¬å‘æ–¹æ¡ˆ, ä¸è¿‡åŒºåˆ«æ˜¯bridgeæ ¹æ®ipè½¬å‘ï¼Œcangwæ˜¯åˆ†å‘ç›¸åŒæµé‡ã€‚
ç¯å¢ƒè¦æ±‚ linux should support can kernel module(sudo modprobe can to check and load)
linux should support vxcan kernel module(sudo modprobe vxcan to check and load)</description>
    </item>
    
    <item>
      <title>é¢å‘API server CRUDçš„æ¢ç´¢</title>
      <link>https://shankisme.com/posts/clientset/</link>
      <pubDate>Mon, 13 Dec 2021 15:35:21 +0800</pubDate>
      
      <guid>https://shankisme.com/posts/clientset/</guid>
      <description>å‰è¨€ æŸäº›åœºæ™¯ä¸‹ï¼Œæˆ‘ä»¬å¯èƒ½ä¸éœ€è¦operatorçš„é‚£ç§è¿ç»´èƒ½åŠ›ï¼Œèƒ½å¯¹èµ„æºCRUDå°±å¤Ÿäº†ï¼Œclient-goä¸­çš„clientå°±æ˜¯éå¸¸ä¸é”™çš„é€‰æ‹©ã€‚
å‰ç½®çŸ¥è¯† GVRã€GVK åœ¨æ•´ä¸ªkubernetesæ¶æ„ä¸­ï¼Œèµ„æºæ˜¯æœ€é‡è¦çš„æ¦‚å¿µï¼Œå¯ä»¥è¯´k8sçš„ç”Ÿæ€ç³»ç»Ÿéƒ½å›´ç»•èµ„æºè¿ä½œï¼Œå®ƒæœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªèµ„æºæ§åˆ¶ç³»ç»Ÿï¼šæ³¨å†Œã€ç®¡ç†ã€è°ƒåº¦èµ„æºå¹¶ç»´æŠ¤èµ„æºçŠ¶æ€ã€‚
k8så°†èµ„æºåˆ†ç»„å’Œç‰ˆæœ¬åŒ–ï¼Œå½¢æˆäº†:
Group: èµ„æºç»„ Version: èµ„æºç‰ˆæœ¬ Resource: èµ„æº Kind: èµ„æºç§ç±», ä¸resourceä¸ºåŒçº§æ¦‚å¿µ k8sç³»ç»Ÿæ”¯æŒå¤šä¸ªGroupï¼Œæ¯ä¸ªGroupæ”¯æŒå¤šä¸ªVersionï¼Œæ¯ä¸ªVersionæ”¯æŒå¤šä¸ªResourceï¼Œå…¶ä¸­éƒ¨åˆ†èµ„æºä¼šæ‹¥æœ‰å­èµ„æºï¼Œå¦‚Deploymentä¼šæ‹¥æœ‰Statuså­èµ„æºã€‚
èµ„æºç»„ã€èµ„æºç‰ˆæœ¬ã€èµ„æºã€å­èµ„æºçš„å®Œæ•´è¡¨ç°å½¢å¼ä¸ºï¼š&amp;lt;group&amp;gt;/&amp;lt;version&amp;gt;/&amp;lt;resource&amp;gt;/&amp;lt;subresource&amp;gt;
å¦‚Deploymentèµ„æºï¼Œå®Œæ•´è¡¨ç°å½¢å¼ä¸ºï¼šapps/v1/deployments/status
èµ„æºå®ä¾‹åŒ–åä¸ºä¸€ä¸ªèµ„æºå¯¹è±¡ï¼Œæ‹¥æœ‰èµ„æºç»„ã€èµ„æºç‰ˆæœ¬ã€èµ„æºç§ç±»ï¼Œè¡¨ç°å½¢å¼ä¸ºï¼š&amp;lt;group&amp;gt;/&amp;lt;version&amp;gt;,Kind=&amp;lt;kind&amp;gt;
å¦‚Deployment, å®Œæ•´è¡¨ç°å½¢å¼ä¸ºapps/v1,Kind=Deployment
client-go k8sä½¿ç”¨client-goä½œä¸ºgoè¯­è¨€å®˜æ–¹ç¼–ç¨‹å¼äº¤äº’å®¢æˆ·ç«¯åº“ï¼Œæä¾›å¯¹k8s API serverçš„äº¤äº’å¼è®¿é—®ã€‚
client-goæ”¯æŒ4ç§clientå¯¹è±¡ä¸k8säº¤äº’ï¼Œåˆ†åˆ«æ˜¯ClientSetã€DynamicClientã€DiscoveryClientã€RESTClient
RESTClientæœ€åŸºç¡€ï¼Œå®ƒå°è£…äº†HTTPRequest,å®ç°äº†RESTfulé£æ ¼çš„APIï¼ŒClientSetã€DynamicClinetä»¥åŠDiscoveryClientéƒ½æ˜¯åŸºäºRESTfulClientå®ç°çš„ã€‚
RESTClient package main import ( &amp;#34;context&amp;#34; &amp;#34;fmt&amp;#34; corev1 &amp;#34;k8s.io/api/core/v1&amp;#34; metav1 &amp;#34;k8s.io/apimachinery/pkg/apis/meta/v1&amp;#34; &amp;#34;k8s.io/client-go/kubernetes/scheme&amp;#34; &amp;#34;k8s.io/client-go/rest&amp;#34; &amp;#34;k8s.io/client-go/tools/clientcmd&amp;#34; ) func main() { config, err := clientcmd.BuildConfigFromFlags(&amp;#34;&amp;#34;, &amp;#34;/etc/rancher/k3s/k3s.yaml&amp;#34;) if err != nil { panic(err) } config.APIPath = &amp;#34;api&amp;#34; // group core version v1 config.GroupVersion = &amp;amp;corev1.SchemeGroupVersion // set codec config.</description>
    </item>
    
    <item>
      <title>èŠä¸€èŠkubernetes operator</title>
      <link>https://shankisme.com/posts/%E8%81%8A%E4%B8%80%E8%81%8Akubernetes-operator/</link>
      <pubDate>Tue, 07 Dec 2021 20:13:53 +0800</pubDate>
      
      <guid>https://shankisme.com/posts/%E8%81%8A%E4%B8%80%E8%81%8Akubernetes-operator/</guid>
      <description>å‰è¨€ å¾®æœåŠ¡å…´èµ·ï¼Œè®¸å¤šä¸šåŠ¡è¢«éƒ¨ç½²åœ¨äº†k8sä¸Šï¼Œå¤§å¤šæ•°ä¸šåŠ¡å¼€å‘äººå‘˜æ—¥å¸¸æ¥è§¦åˆ°çš„åŸºæœ¬æ˜¯build-inèµ„æº(ingress service deployment replicaset pod hpa)ï¼Œå› æ­¤ä¼šè®¤ä¸ºkubernetes(ä»¥ä¸‹ç®€ç§°k8s)æ˜¯ä¸€ä¸ªè®¾è®¡ä¼˜ç§€çš„paaså¹³å°ï¼Œåœ¨k8sä¸­åˆ›å»ºèµ„æºçš„äººå‘˜ä¼šè¢«ç§°ä¸ºyamlå·¥ç¨‹å¸ˆğŸ¤£ã€‚
è¿™ä¹ˆè¯´æ˜¾å¾—k8så¾ˆæ— èŠ, èµ„æºåªæ˜¯å¯¹è±¡çŠ¶æ€çš„æè¿°ï¼Œå®é™…æ‰§è¡ŒåŠ¨ä½œçš„æ˜¯k8sçš„ç»„ä»¶(kubelet kube-proxyç­‰)ï¼Œå¯ä»¥è¯´k8sçš„æ‰§è¡Œèƒ½åŠ›è¶³å¤Ÿå¼ºå¤§ï¼Œèƒ½åœ¨å­˜å‚¨ã€ç½‘ç»œã€å®¹å™¨ä¸Šç©å‡ºèŠ±ï¼Œä½ å®Œå…¨å¯ä»¥ç»„ç»‡è‡ªå·±çš„èµ„æºæ ¼å¼(crd)ï¼Œåˆ©ç”¨k8sçš„èƒ½åŠ›åšè‡ªå·±æƒ³åšçš„äº‹ï¼Œk8sæœ¬è´¨ä¸Šæ˜¯å¸¦æœ‰å¼ºå¤§æ‰§è¡ŒåŠ›çš„åˆ†å¸ƒå¼èµ„æºç®¡ç†å¹³å°ï¼Œè¿™ç§åŠ¨è¯-åè¯åˆ†ç¦»çš„è§£é‡Šåº”è¯¥èƒ½è®©ä½ æ›´å¥½åœ°ç†è§£k8sã€‚
å½“ä»Šè®¸å¤šå¯¹æ‰©å±•æ€§å¯ç”¨æ€§è¦æ±‚é«˜çš„é¡¹ç›®ï¼ˆTiDBç­‰ï¼‰ï¼Œæ›´é’çäºä½¿ç”¨k8sä½œä¸ºåŸºåº§ï¼Œè¿™æ ·çš„æ·±åº¦ç»“åˆåªä¼šè®©k8sè¶Šæ¥è¶Šæµè¡Œã€‚
å¾—ç›Šäºå¼ºå¤§çš„æ’ä»¶æœºåˆ¶ï¼Œk8sè¿˜èƒ½è‡ªå®šä¹‰èµ„æº(crd/cr)ï¼Œè‡ªå®šä¹‰controllerï¼Œè‡ªå®šä¹‰api server, è‡ªå®šä¹‰admission webhookï¼Œä»–ä»¬è®©ä½ èƒ½æœ‰æ•ˆç»„åˆk8sçš„æ‰§è¡ŒåŠ›ï¼Œåšä¸€äº›æœ‰é€»è¾‘çš„äº‹ã€‚å½“ä¸‹æœ€æµè¡Œçš„è«è¿‡äºç©crd+controlleräº†ã€‚
ä¸ºäº†è®©çœ‹å®˜æ›´å¥½çš„äº†è§£operatorï¼ˆcontroller + crd + crï¼‰ï¼Œå’±ä»¬ä»k8sä¸¤å¤§è®¾è®¡æ€æƒ³ï¼šå£°æ˜å¼APIã€æ§åˆ¶å¾ªç¯è¯´èµ·ã€‚
å£°æ˜å¼API å£°æ˜å¼ä¸ä¹‹ç›¸å¯¹çš„æ˜¯å‘½ä»¤å¼, å‘½ä»¤å¼é¡¾åæ€ä¹‰ï¼Œè®©ç›®æ ‡æŒ‰æŒ‡å®šå‘½ä»¤åšäº‹ï¼›è€Œå£°æ˜å¼åˆ™æ˜¯æä¾›ç›®æ ‡ä¸€ä¸ªæœŸæœ›çŠ¶æ€ï¼Œè®©ç›®æ ‡æœæœŸæœ›çŠ¶æ€å»å˜æ›´ã€‚
çœ‹å¾—å‡ºæ¥ï¼Œå‘½ä»¤å¼å¤Ÿç®€æ´ï¼Œä½†è¦èŠ±è´¹å·¨å¤§ä»£ä»·ä¿è¯å‘½ä»¤æ‰§è¡Œæ‹¥æœ‰åŸå­æ€§å¹‚ç­‰æ€§ã€‚
æä¾›æœŸæœ›çŠ¶æ€çœ‹ä¼¼å†—ä½™ï¼Œä½†åªè¦æœŸæœ›çŠ¶æ€èƒ½è¢«æ‰§è¡Œè€…è·å–åˆ°ï¼Œæ‰§è¡Œè€…å°±èƒ½ä¸æ–­å°è¯•ç€å»è¾¾æˆæœŸæœ›çŠ¶æ€ï¼Œè¿‡ç¨‹ç®€å•ã€‚
è€ŒAPIå˜›ï¼ŒæŒ‡çš„æ˜¯k8s apiserveræä¾›çš„RESTful httpæ¥å£ï¼Œåˆ›å»ºèµ„æºæ¥å£éœ€è¦æ¥æ”¶å®Œæ•´çš„èµ„æºæœŸæœ›çŠ¶æ€å®šä¹‰, æœŸæœ›çŠ¶æ€æŒ‡çš„å°±æ˜¯specä¸­çš„æè¿°ï¼Œä¸ä¹‹å¯¹åº”çš„å®é™…çŠ¶æ€ç”±æ‰§è¡Œè€…ï¼ˆcontrollerï¼‰è®°å½•åœ¨statusä¸­ã€‚
è¿™ä¹Ÿæ˜¯ä¸ºå•¥æˆ‘ä»¬åœ¨ç”¨kubectlæŸ¥çœ‹èµ„æºä¿¡æ¯çš„æ—¶å€™åå‡ºç°é¢å¤–çš„statuså­—æ®µï¼Œè¿™å®é™…ä¸Šæ˜¯æ‰§è¡Œè€…å¸®æˆ‘ä»¬è®°å½•çš„ï¼Œä¸“ä¸šç‚¹çš„å«æ³•æ˜¯è§„çº¦(spec) - çŠ¶æ€(status)åˆ†ç¦»ã€‚æ¯”å¦‚pod, é™¤äº†å…ƒä¿¡æ¯å¤–ï¼ŒçŠ¶æ€ä»specå’Œstatuså­—æ®µå¼€å§‹å±•å¼€ã€‚
type Pod struct { metav1.TypeMeta `json:&amp;#34;,inline&amp;#34;` metav1.ObjectMeta `json:&amp;#34;metadata,omitempty&amp;#34; protobuf:&amp;#34;bytes,1,opt,name=metadata&amp;#34;` Spec PodSpec `json:&amp;#34;spec,omitempty&amp;#34; protobuf:&amp;#34;bytes,2,opt,name=spec&amp;#34;` Status PodStatus `json:&amp;#34;status,omitempty&amp;#34; protobuf:&amp;#34;bytes,3,opt,name=status&amp;#34;` } æ§åˆ¶å¾ªç¯ï¼ˆcontrol loopï¼‰ èµ„æºçš„ç†æƒ³çŠ¶æ€å­˜å‚¨åœ¨k8sçš„apiserverä¸­ï¼Œä¸ºäº†è®©èµ„æºç”±å®é™…çŠ¶æ€å‘æœŸæœ›çŠ¶æ€é æ‹¢, æ‰§è¡Œè€…éœ€è¦ç›‘å¬èµ„æºæœŸæœ›çŠ¶æ€çš„å¢åˆ æ”¹äº‹ä»¶ï¼Œè¿™äº›äº‹ä»¶ä¼šè§¦å‘æ‰§è¡Œè€…ä»¥å®šæ—¶é‡å¤æ‰§è¡Œæ–¹å¼è°ƒç”¨å¯¹åº”çš„handlerå¤„ç†äº‹ä»¶, ç›´åˆ°æ»¡è¶³æœŸæœ›çŠ¶æ€ä¸ºæ­¢ï¼Œä¹‹åæ‰§è¡Œè€…å†æŠŠæ“ä½œç»“æœè®°å½•åˆ°å®é™…çŠ¶æ€ä¸­ã€‚
æ‰§è¡Œè€… æˆ‘ä»¬çŸ¥é“ï¼Œkubeletæ˜¯k8sè‡ªå¸¦ç»„ä»¶ï¼Œä¸»è¦åŠŸèƒ½é€šè¿‡ç›‘å¬podæœŸæœ›çŠ¶æ€å˜åŒ–äº‹ä»¶å¹¶åšä¸€äº›äº‹ç¡®ä¿æœ¬åœ°çš„podå¤„äºæœŸæœ›çŠ¶æ€ã€‚
kube-proxyåŒæ ·ä¹Ÿä¼šå¤„ç†podçš„å¢åˆ æ”¹äº‹ä»¶ï¼Œå®ƒä¸æ–­åœ°åˆ·æ–°æœ¬æœºlinuxç½‘ç»œè®¾å¤‡çš„é…ç½®ï¼Œæ¥ç¡®ä¿podç½‘ç»œé€šç•…ã€‚
è¿˜æœ‰æˆ‘ä»¬å¸¸ç”¨çš„deploymentã€cronJobã€statefulsetç­‰ï¼Œå®ƒä»¬æ‹¥æœ‰è‡ªå·±çš„controlleråšæ§åˆ¶å¾ªç¯ï¼Œè¿™äº›controller è¿è¡Œåœ¨ç»„ä»¶controller-managerå†…ã€‚
ç„¶è€Œä¸åƒä¸Šé¢æåˆ°çš„å¤„ç†k8såŸç”Ÿèµ„æºçš„æ‰§è¡Œè€…ï¼Œè¿™æ¬¡æˆ‘ä»¬èŠçš„operator,ç”±crd(custom resource definition)ã€cr(custom resource)ã€controllerç»„æˆã€‚
crdç”¨æ¥æè¿°ä½ æƒ³åˆ›å»ºçš„èµ„æºåº”è¯¥æœ‰å“ªäº›å­—æ®µï¼Œcræ˜¯crdçš„å…·ä½“åŒ–å®ç°ï¼Œä¸å¯¹è±¡ï¼Œå¯¹è±¡å®ä¾‹ä¹‹é—´åŒºåˆ«ç±»ä¼¼ã€‚
æˆ‘ä»¬è‡ªå·±å®ç°çš„controlleræ§åˆ¶çš„ç›®æ ‡å°±æ˜¯cr, å®ƒçš„å®ç°åŸç†ç­‰åŒcontroller-managerä¸­çš„åŸç”Ÿcontrollerï¼š
ä¾é informerçš„ListAndWatchæ–¹æ³•å°†æŒ‡å®šèµ„æºçš„çŠ¶æ€ç¼“å­˜åœ¨å†…å­˜ä¸­ï¼Œå¹¶ä¸æ–­ç›‘æ§çŠ¶æ€å˜åŒ–
reconcileæ–¹æ³•ä¸­çš„ä¸šåŠ¡é€»è¾‘ä¼šæ ¹æ®èµ„æºçš„æœŸæœ›çŠ¶æ€ï¼Œå¯¹å¤–éƒ¨ä¸–ç•Œä½œå‡ºæ”¹å˜ï¼Œå¦‚æœå¤„ç†å¤±è´¥ï¼Œå°±é‡æ–°å…¥é˜Ÿï¼ŒæŒ‰æŸç§è§„åˆ™åˆ°æŸä¸ªæ—¶é—´ç»§ç»­è¿›å…¥reconcile, ç›´åˆ°å¤„ç†å®Œæˆã€‚</description>
    </item>
    
  </channel>
</rss>
